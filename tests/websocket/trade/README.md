# WebSocket 체결(Trade) 테스트 계획

> 티커 테스트에서 검증된 배치 스냅샷 방식을 기반으로 한 효율적인 체결 테스트 설계

## 🎯 테스트 목표

티커 테스트에서 **배치 스냅샷의 우수성**이 증명되었으므로, 체결 테스트는 **핵심 기능 검증**에 집중합니다.

### 검증 완료된 사항 (티커 테스트 결과)
- ✅ **배치 구독 우수성**: 5,000+ symbols/sec 성능
- ✅ **연결 안정성**: 100% 성공률 달성
- ✅ **확장성**: 189개 KRW 페어 동시 처리
- ✅ **지연 최적화**: 음의 지연 기울기 (-0.0104 ms/symbol)

## 📋 체결 테스트 핵심 계획

### 🔍 **필수 검증 항목**
1. **체결 데이터 무결성**: 16개 필드 완전성 검증
2. **sequential_id 고유성**: 중복 체결 방지 검증
3. **ask_bid 분류 정확성**: 매수/매도 구분 검증
4. **타임스탬프 일관성**: trade_timestamp vs timestamp 검증
5. **최우선 호가 연동**: best_ask/bid 실시간 동기화 검증

### 🚀 **Test Suite 구성**

#### **Test 01: 단일 체결 검증** ⭐
- **목적**: KRW-BTC 체결 데이터 기본 동작 검증
- **검증**: 16개 필드 타입 및 범위 검증
- **소요시간**: ~30초

#### **Test 02: 체결 연속성 검증** ⭐
- **목적**: sequential_id 고유성 및 연속성 확인
- **검증**: 5회 연속 체결에서 중복 ID 없음
- **소요시간**: ~1분

#### **Test 03: 멀티 심볼 체결 비교** ⭐
- **목적**: KRW-BTC + KRW-ETH 체결 패턴 비교
- **검증**: 심볼별 체결 특성 및 동시성
- **소요시간**: ~1분

#### **Test 04: KRW 마켓 체결 스냅샷** ⭐⭐
- **목적**: 전체 189개 페어 체결 현황 스냅샷
- **검증**: 배치 스냅샷으로 시장 전체 체결 상황
- **소요시간**: ~1분 (티커 테스트 기반 최적화)

#### **Test 05: 체결 방향 분석** ⭐⭐
- **목적**: ask_bid 패턴 및 시장 압력 분석
- **검증**: 매수/매도 체결 비율 및 패턴
- **소요시간**: ~2분

## 🎯 **집중 검증 영역**

### 📊 **체결 데이터 완전성 (Test 01, 04)**
```python
trade_fields = {
    # 핵심 체결 정보
    'type': str,
    'code': str,
    'trade_price': (int, float),
    'trade_volume': (int, float),
    'ask_bid': str,  # ASK, BID

    # 시간 정보
    'trade_timestamp': int,
    'timestamp': int,
    'trade_date': str,
    'trade_time': str,

    # 고유 식별
    'sequential_id': int,

    # 시장 상황
    'prev_closing_price': (int, float),
    'change': str,  # RISE, EVEN, FALL
    'change_price': (int, float),

    # 최우선 호가
    'best_ask_price': (int, float),
    'best_ask_size': (int, float),
    'best_bid_price': (int, float),
    'best_bid_size': (int, float),

    # 스트림 정보
    'stream_type': str  # SNAPSHOT, REALTIME
}
```

### 🔍 **고유성 검증 (Test 02)**
- **sequential_id 중복 체크**: Set 기반 중복 감지
- **타임스탬프 순서**: 시간 순서 일관성
- **체결 논리 검증**: 가격/수량 합리성

### ⚖️ **시장 압력 분석 (Test 05)**
- **매수 압력**: BID 체결 비율 및 규모
- **매도 압력**: ASK 체결 비율 및 규모
- **호가 스프레드**: best_ask - best_bid 분석

## 📈 **성능 기준 (티커 테스트 기반)**

| 테스트 | 목표 성능 | 성공 기준 |
|--------|-----------|-----------|
| **Test 01** | < 100ms | 16개 필드 100% 검증 |
| **Test 02** | < 1초 | sequential_id 100% 고유 |
| **Test 03** | < 1초 | 2개 심볼 동시 수신 |
| **Test 04** | < 2초 | 189개 페어 배치 처리 |
| **Test 05** | < 2분 | ask_bid 패턴 분석 |

## 🚀 **최적화 전략**

### 1. **배치 스냅샷 활용**
```json
{
  "type": "trade",
  "codes": ["KRW-BTC", "KRW-ETH", ..., "KRW-XYZ"],
  "is_only_snapshot": true
}
```

### 2. **데이터 필터링**
- **거래량 기준**: > 0.001 BTC (소액 체결 제외)
- **가격 범위**: ±10% 이상 급변 감지
- **시간 윈도우**: 최근 1분 내 체결만

### 3. **메모리 최적화**
- **순환 버퍼**: 최근 N개 체결만 보관
- **압축 저장**: 중요 필드만 추출
- **배치 처리**: 여러 체결 일괄 분석

## 🔧 **구현 우선순위**

### 🥇 **1단계 (핵심)**: Test 01, 02, 03
- 체결 기본 기능 및 무결성 검증
- sequential_id 고유성 확인
- 멀티 심볼 동시성 검증

### 🥈 **2단계 (확장)**: Test 04
- 전체 KRW 마켓 배치 스냅샷
- 티커 테스트 성능 기반 최적화

### 🥉 **3단계 (분석)**: Test 05
- 시장 압력 및 체결 패턴 분석
- 고급 매매 신호 도출

## 📊 **예상 결과**

### 🎯 **성능 예측** (티커 테스트 기반)
- **Test 04 처리량**: 3,000+ trades/sec 예상
- **지연시간**: < 50ms (체결 발생 → 수신)
- **메모리 사용량**: < 100MB (189개 페어)

### 🔍 **데이터 품질**
- **필드 완전성**: 100% (16개 필드)
- **고유성**: 100% (sequential_id)
- **타임스탬프 정확도**: ±10ms

## 🎉 **테스트 성공 기준**

### ✅ **기능 검증**
- [ ] 체결 데이터 16개 필드 100% 검증
- [ ] sequential_id 중복 0건
- [ ] ask_bid 분류 100% 정확
- [ ] 타임스탬프 논리 일관성 100%

### ⚡ **성능 검증**
- [ ] 배치 스냅샷 < 2초 완료
- [ ] 멀티 심볼 지연 < 100ms
- [ ] 메모리 사용량 < 200MB

### 📈 **안정성 검증**
- [ ] 연결 성공률 > 95%
- [ ] 데이터 손실 0%
- [ ] 에러 복구 100%

---

## 🔗 **티커 테스트 경험 활용**

### ✅ **검증된 패턴 재사용**
- `WebSocketTestBase` 상속 구조
- `measure_request` 성능 측정
- 배치 구독 최적화 방식
- 결과 저장 및 분석 로직

### 🚀 **성능 최적화 적용**
- 음의 지연 기울기 원리 활용
- 189개 페어 동시 처리 검증
- 13단계 부하 테스트 경험

**체결 테스트는 티커 테스트의 혁신적 발견을 기반으로, 더욱 효율적이고 정확한 검증을 목표로 합니다!** 🎯
