# ì‹œê°„ ê³„ì‚° ë©”ì„œë“œ ì„±ëŠ¥ ë¹„êµ ë¶„ì„ ë³´ê³ ì„œ

## ğŸ” í…ŒìŠ¤íŠ¸ ê°œìš”

`TimeUtils.get_aligned_time_by_ticks` vs ê¸°ì¡´ `timedelta` ë°©ì‹ì˜ í¬ê´„ì  ì„±ëŠ¥ ë° ì •í™•ì„± ë¹„êµ

**í…ŒìŠ¤íŠ¸ í™˜ê²½:** Python 3.13.5, Windows, ì—…ë¹„íŠ¸ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ
**í…ŒìŠ¤íŠ¸ ë²”ìœ„:** 9ê°œ íƒ€ì„í”„ë ˆì„, ë‹¤ì–‘í•œ í‹± ìˆ˜, ê²½ê³„ ì¡°ê±´, ì •ë°€ë„

---

## ğŸ“Š í•µì‹¬ ë°œê²¬ì‚¬í•­

### 1ï¸âƒ£ ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼

**âŒ ì˜ˆìƒê³¼ ë°˜ëŒ€: get_aligned_time_by_ticksê°€ ëª¨ë“  ì¼€ì´ìŠ¤ì—ì„œ ì„±ëŠ¥ ì €í•˜**

| êµ¬ë¶„ | í‰ê·  ì„±ëŠ¥ ë³€í™” | ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë³€í™” | ìµœì•… ì¼€ì´ìŠ¤ |
|------|:---:|:---:|:---:|
| **ë‹¨ì¼ í‹± ì´ë™** | **-88.57%** | **-108.33%** | ì£¼ë´‰: -150% |
| **ë‹¤ì¤‘ í‹± ì´ë™** | **-10.89%** | N/A | 1ì‹œê°„ë´‰: -11.82% |
| **ì¢…ë£Œì‹œê°„ ê³„ì‚°** | **-37.84%** | N/A | 1ì‹œê°„ë´‰: -44.35% |

**ì„±ëŠ¥ ì €í•˜ ì›ì¸:**
- `get_aligned_time_by_ticks`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë³µì¡í•œ ë¶„ê¸° ë¡œì§ ìˆ˜í–‰
- ì›”/ë…„ë´‰ íŠ¹ë³„ ì²˜ë¦¬, ì •ë ¬ ë¡œì§, íƒ€ì… ê²€ì¦ ë“±ì˜ ì˜¤ë²„í—¤ë“œ
- ë‹¨ìˆœí•œ 1~ìˆ˜ì²œ í‹± ì´ë™ì—ì„œëŠ” `timedelta` ì—°ì‚°ì´ ì••ë„ì ìœ¼ë¡œ ë¹ ë¦„

### 2ï¸âƒ£ ì •í™•ì„± ë¶„ì„ ê²°ê³¼

**âš ï¸ ì‹¬ê°í•œ ì •í™•ì„± ë¬¸ì œ ë°œê²¬**

| ë¬¸ì œ ì˜ì—­ | ì˜í–¥ë„ | ìƒì„¸ |
|----------|:---:|------|
| **ì›”ë´‰/ë…„ë´‰ ê³„ì‚°** | ğŸ”´ HIGH | UTC vs naive datetime ë¶ˆì¼ì¹˜ |
| **ì¢…ë£Œì‹œê°„ ê³„ì‚°** | ğŸ”´ HIGH | ëª¨ë“  íƒ€ì„í”„ë ˆì„ì—ì„œ ì´ˆ/ë¶„ ì •ë³´ ì†ì‹¤ |
| **ê²½ê³„ ì¡°ê±´** | ğŸŸ¡ MED | ì›”ë´‰ ê²½ê³„ì—ì„œë§Œ ë¬¸ì œ |

**ì •í™•ì„± ë¬¸ì œ ìƒì„¸:**

1. **ì›”ë´‰/ë…„ë´‰ ê²°ê³¼ ë¶ˆì¼ì¹˜:**
   ```
   ê¸°ì¡´: 2024-05-02 00:00:00+00:00 (UTC)
   ìƒˆë°©ì‹: 2024-05-01 00:00:00 (naive)
   ```
   - timezone ì •ë³´ ì°¨ì´ ë° ê³„ì‚° ë¡œì§ ì°¨ì´

2. **ì¢…ë£Œì‹œê°„ ê³„ì‚° ë¶ˆì¼ì¹˜:**
   ```
   ê¸°ì¡´: 2024-06-15 11:13:45+00:00 (ì›ë˜ ì´ˆ/ë¶„ ìœ ì§€)
   ìƒˆë°©ì‹: 2024-06-15 11:13:00+00:00 (ì •ë ¬ëœ ì‹œê°„)
   ```
   - ê¸°ì¡´ ë°©ì‹: ì›ë˜ ì‹œê°„ì˜ ì„¸ë¶€ ì •ë³´ ìœ ì§€
   - ìƒˆ ë°©ì‹: ìº”ë“¤ ê²½ê³„ë¡œ ì •ë ¬í•˜ì—¬ ì •ë³´ ì†ì‹¤

### 3ï¸âƒ£ ì‚¬ìš© ì‚¬ë¡€ë³„ ì˜í–¥ë„

| í˜„ì¬ CandleDataProvider ì‚¬ìš© | ì˜í–¥ë„ | ë¬¸ì œì  |
|------------------------------|:---:|--------|
| **ì§„ì…ì  ë³´ì •** (Lines 589, 601, 708) | ğŸ”´ HIGH | 40-90% ì„±ëŠ¥ ì €í•˜ |
| **ì—°ì†ì„± ë³´ì¥** (Line 642) | ğŸ”´ HIGH | ì‹œê°„ ì •ë³´ ì†ì‹¤ ìœ„í—˜ |
| **ë²”ìœ„ ê³„ì‚°** (Lines 736, 1177) | ğŸ”´ CRITICAL | ë¶€ì •í™•í•œ ì¢…ë£Œì‹œê°„ |
| **API íŒŒë¼ë¯¸í„° ì¡°ì •** (Lines 777-823) | ğŸŸ¡ MED | ì„±ëŠ¥ ì €í•˜ë§Œ |

---

## ğŸ’¡ ë¶„ì„ ë° ê¶Œì¥ì‚¬í•­

### ğŸš« **ê²°ë¡ : get_aligned_time_by_ticks ë„ì… ë°˜ëŒ€**

**ì´ìœ :**
1. **ì„±ëŠ¥**: ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ 30-150% ì„±ëŠ¥ ì €í•˜
2. **ì •í™•ì„±**: ì‹¬ê°í•œ ì •í™•ì„± ë¬¸ì œë¡œ ì¸í•´ ì—…ë¹„íŠ¸ API í˜¸ì¶œ ì˜¤ë¥˜ ê°€ëŠ¥
3. **ë³µì¡ì„±**: ì˜¤ë²„ ì—”ì§€ë‹ˆì–´ë§ìœ¼ë¡œ ë‹¨ìˆœ ì‘ì—…ì— ë¶€ì í•©

### âœ… **ê°œì„  ê¶Œì¥ì‚¬í•­**

#### 1. í˜„ì¬ ë°©ì‹ ìœ ì§€ + ìµœì í™”
```python
# ê¸°ì¡´ ë°©ì‹ ìœ ì§€í•˜ë˜ ìºì‹± ì¶”ê°€
_TIMEFRAME_DELTA_CACHE = {}

def get_timeframe_delta_cached(timeframe: str) -> timedelta:
    if timeframe not in _TIMEFRAME_DELTA_CACHE:
        _TIMEFRAME_DELTA_CACHE[timeframe] = TimeUtils.get_timeframe_delta(timeframe)
    return _TIMEFRAME_DELTA_CACHE[timeframe]
```

#### 2. get_aligned_time_by_ticks ì ìš© ë²”ìœ„ ì œí•œ
**âœ… ì í•©í•œ ì‚¬ìš© ì‚¬ë¡€:**
- ë§¤ìš° í° í‹± ìˆ˜ (10,000+ í‹±) ê³„ì‚°
- ë³µì¡í•œ ì‹œê°„ ì‹œí€€ìŠ¤ ìƒì„± (`generate_time_sequence`)
- ì›”/ë…„ë´‰ ì •í™•í•œ ê²½ê³„ ê³„ì‚°

**âŒ ë¶€ì í•©í•œ ì‚¬ìš© ì‚¬ë¡€:**
- 1-1000 í‹± ë‹¨ìˆœ ì´ë™ (í˜„ì¬ CandleDataProvider ëŒ€ë¶€ë¶„)
- ì´ˆ/ë¶„/ì‹œ ì •ë³´ê°€ ì¤‘ìš”í•œ ì¢…ë£Œì‹œê°„ ê³„ì‚°
- ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ì‹¤ì‹œê°„ ì²˜ë¦¬

#### 3. í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²• ì œì•ˆ
```python
def smart_time_calculation(base_time: datetime, timeframe: str, tick_count: int) -> datetime:
    """í‹± ìˆ˜ì— ë”°ë¥¸ ì ì‘í˜• ì‹œê°„ ê³„ì‚°"""
    if abs(tick_count) <= 1000 and timeframe not in ['1M', '1y']:
        # ì‘ì€ í‹±: ê¸°ì¡´ ë°©ì‹ (ë¹ ë¦„)
        delta = TimeUtils.get_timeframe_delta(timeframe) * tick_count
        return TimeUtils.align_to_candle_boundary(base_time, timeframe) - delta
    else:
        # í° í‹± ë˜ëŠ” ë³µì¡í•œ íƒ€ì„í”„ë ˆì„: ìƒˆ ë°©ì‹ (ì •í™•í•¨)
        return TimeUtils.get_aligned_time_by_ticks(base_time, timeframe, -tick_count)
```

---

## ğŸ› ï¸ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê°œì„ ì‚¬í•­

### CandleDataProvider ìµœì í™”
í˜„ì¬ ì½”ë“œì—ì„œ ë‹¤ìŒ ë¶€ë¶„ë“¤ì€ **ê¸°ì¡´ ë°©ì‹ ìœ ì§€** ê¶Œì¥:

1. **ì§„ì…ì  ë³´ì •** (ì„±ëŠ¥ ì¤‘ìš”):
   ```python
   # í˜„ì¬ (ìœ ì§€)
   dt = TimeUtils.get_timeframe_delta(request_info.timeframe)
   first_chunk_start_time = aligned_to - dt
   ```

2. **ì—°ì†ì„± ë³´ì¥** (ì •í™•ì„± ì¤‘ìš”):
   ```python
   # í˜„ì¬ (ìœ ì§€)
   timeframe_delta = TimeUtils.get_timeframe_delta(state.timeframe)
   next_internal_time = last_time - timeframe_delta
   ```

3. **ì¢…ë£Œì‹œê°„ ê³„ì‚°** (ì •í™•ì„± ì¤‘ìš”):
   ```python
   # í˜„ì¬ (ìœ ì§€)
   timeframe_seconds = TimeUtils.get_timeframe_delta(timeframe).total_seconds()
   end_time = start_time - timedelta(seconds=(count - 1) * timeframe_seconds)
   ```

### TimeUtils ê°œì„ 
`get_aligned_time_by_ticks`ëŠ” ë‹¤ìŒ ìš©ë„ë¡œë§Œ í™œìš©:
- `generate_time_sequence` (ì´ë¯¸ êµ¬í˜„ë¨)
- `get_time_range` (ì´ë¯¸ êµ¬í˜„ë¨)
- ìƒˆë¡œìš´ ë³µì¡í•œ ì‹œê°„ ì‹œí€€ìŠ¤ ìƒì„± ê¸°ëŠ¥

---

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™” ìš°ì„ ìˆœìœ„

1. **High Priority**: ìì£¼ í˜¸ì¶œë˜ëŠ” ë‹¨ìˆœ ê³„ì‚° â†’ ê¸°ì¡´ ë°©ì‹ + ìºì‹±
2. **Medium Priority**: API íŒŒë¼ë¯¸í„° ìƒì„± â†’ í˜„ì¬ ë°©ì‹ ìœ ì§€
3. **Low Priority**: ë³µì¡í•œ ì‹œê°„ ë²”ìœ„ ê³„ì‚° â†’ `get_aligned_time_by_ticks` í™œìš©

**ê²°ë¡ **: "ì˜¬ë°”ë¥¸ ë„êµ¬ë¥¼ ì˜¬ë°”ë¥¸ ê³³ì—" - ê° ë°©ì‹ì˜ ì¥ì ì„ ì‚´ë¦° ì„ íƒì  ì ìš©ì´ ìµœì í•´
