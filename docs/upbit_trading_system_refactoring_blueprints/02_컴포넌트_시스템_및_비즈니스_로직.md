# 업비트 자동매매 시스템 통합 청사진 v2.2 - 02: 컴포넌트 시스템 및 비즈니스 로직

## 컴포넌트 기반 전략 시스템 (85% 완료)

### 🧩 컴포넌트 아키텍처 개요

현재 시스템은 **아토믹 컴포넌트(Atomic Components)** 기반으로 구축되어 있으며, 모든 전략은 이 컴포넌트들의 조합으로 이루어집니다.

```python
# 컴포넌트 시스템 구조 (component_system/__init__.py)
from .base import (
    ComponentType, ComponentResult, ExecutionContext,
    TriggerComponent, ActionComponent, ConditionComponent
)

# 실제 구현된 컴포넌트들
COMPONENT_CATALOG = {
    "triggers": {"price": [...], "indicator": [...], "time": [...]},
    "actions": {"trading": [...], "alert": [...]},
    "conditions": {"risk_management": [...], "profit_loss": [...]}
}
```

### 🎯 컴포넌트 분류 체계

#### 1. 트리거 컴포넌트 (Triggers)
**역할**: 시장의 특정 조건을 감지하여 전략 실행 신호 발생

```python
# 가격 기반 트리거들
PriceChangeTrigger     # 지정 가격에서 특정 % 변화 시 트리거
PriceBreakoutTrigger   # 지지선/저항선 돌파 시 트리거  
PriceCrossoverTrigger  # 두 가격선의 교차 시 트리거

# 지표 기반 트리거들 (향후 구현)
RSITrigger            # RSI 과매수/과매도 구간 트리거
MACDTrigger           # MACD 골든크로스/데드크로스 트리거
BollingerTrigger      # 볼린저 밴드 상/하한선 터치 트리거
```

#### 2. 액션 컴포넌트 (Actions)
**역할**: 트리거 신호를 받아 실제 거래 행동 실행

```python
# 거래 액션들
BuyAction                 # 다양한 방식의 매수 실행 (신규/추가/물타기)
SellAction               # 전체/부분 매도 실행 (익절/손절)
PositionManagementAction # 손절가/익절가 설정, 트레일링스탑

# 알림 액션들 (향후 구현)
NotificationAction       # 슬랙/텔레그램 알림 발송
LogAction               # 거래 로그 기록
```

#### 3. 조건 컴포넌트 (Conditions)  
**역할**: 트리거와 액션 사이에서 추가 검증 로직 수행

```python
# 리스크 관리 조건들
BalanceCondition         # 사용 가능한 잔고 확인
PositionSizeCondition    # 현재 포지션 크기 제한
AddBuyCountCondition     # 물타기 횟수 제한

# 손익 관리 조건들
ProfitLossCondition      # 현재 포지션의 수익률 확인
TimeCondition           # 특정 시간대 제한
TechnicalIndicatorCondition # 기술적 지표 추가 확인
```

### 🔧 컴포넌트 조합 패턴

#### 물타기(피라미딩) 전략 예시
```python
# 실제 구현된 전략 조합 (strategies/pyramiding_example.py)
pyramiding_strategy = PyramidingStrategy(
    trigger=PriceChangeTrigger(change_percent=-5.0),    # 5% 하락 시
    action=BuyAction(amount_type="fixed", amount=10000), # 1만원 매수
    conditions=[
        AddBuyCountCondition(max_count=3),               # 최대 3번까지
        BalanceCondition(min_balance=50000)              # 잔고 5만원 이상
    ]
)
```

#### RSI 역추세 전략 (향후 구현)
```python
rsi_strategy = StrategyRule(
    trigger=RSITrigger(oversold_threshold=30),           # RSI 30 이하
    action=BuyAction(amount_type="percent", amount=20),  # 잔고의 20%
    conditions=[
        BalanceCondition(min_balance=10000),             # 최소 잔고 확인
        TimeCondition(start_time="09:00", end_time="15:00") # 거래시간 제한
    ]
)
```

## 비즈니스 로직 계층 아키텍처

### ✅ 완성된 비즈니스 모듈들

#### 1. 백테스팅 엔진 (100% 완료)
```python
# business_logic/backtester/
BacktestRunner          # 백테스트 실행 엔진
BacktestAnalyzer        # 성과 분석 및 지표 계산
BacktestResultsManager  # 결과 저장 및 비교 관리

# 사용 예시
runner = BacktestRunner()
result = runner.run_backtest(
    strategy_id="pyramiding_v1",
    symbol="KRW-BTC", 
    timeframe="1d",
    start_date=datetime(2024, 1, 1),
    end_date=datetime(2024, 12, 31),
    initial_capital=1000000
)
```

#### 2. 데이터 수집 및 처리 (90% 완료)
```python
# data_layer/collectors/
UpbitDataCollector      # 업비트 API 데이터 수집
MarketDataManager       # 시장 데이터 통합 관리

# data_layer/processors/  
TechnicalIndicator      # 기술적 지표 계산
DataValidator          # 데이터 품질 검증
```

### 🚧 개발 진행 중인 모듈들

#### 1. 실시간 거래 엔진 (50% 완료)
```python
# business_logic/trader/ (개발 진행 중)
TradingEngine          # 실시간 거래 실행 엔진
OrderManager           # 주문 생성 및 관리
RiskManager           # 리스크 관리 및 안전장치
PositionTracker       # 포지션 추적 및 관리

# 구현 목표 인터페이스
engine = TradingEngine()
engine.start_strategy(strategy_id="my_strategy")
engine.monitor_positions()
engine.execute_order(order_request)
```

#### 2. 포트폴리오 관리 (40% 완료)
```python
# business_logic/portfolio/ (기본 구조 완료)
PortfolioManager       # 포트폴리오 생성 및 관리
AssetAllocator        # 자산 배분 및 리밸런싱
PerformanceAnalyzer   # 포트폴리오 성과 분석

# 구현 목표 기능
portfolio = PortfolioManager()
portfolio.create_portfolio(name="균형 포트폴리오")
portfolio.add_coin("KRW-BTC", weight=0.4, strategy_id="trend_follow")
portfolio.rebalance()
```

#### 3. 종목 스크리너 (30% 완료)
```python
# business_logic/screener/ (설계 단계)
CoinScreener          # 거래량/변동성 기준 필터링
TrendAnalyzer         # 추세 분석 및 패턴 인식
VolumeAnalyzer        # 거래량 분석

# 계획된 스크리닝 기준
screener.screen_by_volume(min_volume=1000000000)      # 거래량 10억 이상
screener.screen_by_volatility(min_vol=3, max_vol=15) # 변동성 3-15%
screener.screen_by_trend("uptrend", timeframe="1d")  # 상승 추세
```

## 데이터 흐름 및 통합 패턴

### 📊 데이터 파이프라인
```
1. 데이터 수집 → 2. 전처리 → 3. 지표 계산 → 4. 신호 생성 → 5. 전략 실행
   ↓              ↓           ↓            ↓            ↓
업비트 API → TechnicalIndicator → ComponentSystem → TradingEngine → OrderManager
```

### 🔄 컴포넌트 실행 흐름
```python
# 전략 실행 워크플로우
class StrategyExecutor:
    def execute_strategy(self, strategy: StrategyRule):
        # 1. 트리거 조건 확인
        trigger_result = strategy.trigger.check_condition(market_data)
        
        if trigger_result.triggered:
            # 2. 조건들 검증
            for condition in strategy.conditions:
                if not condition.check(execution_context):
                    return False
            
            # 3. 액션 실행
            return strategy.action.execute(execution_context)
```

### 🏗️ 계층간 통신 패턴

#### UI → 비즈니스 로직 (어댑터 패턴)
```python
# UI 어댑터가 UI 이벤트를 비즈니스 요청으로 변환
class StrategyBuilderAdapter:
    def handle_save_strategy(self, ui_form_data):
        business_request = self._convert_to_strategy_request(ui_form_data)
        return self.strategy_service.save_strategy(business_request)
```

#### 비즈니스 로직 → 데이터 계층 (리포지토리 패턴)
```python
# 데이터 접근을 추상화하여 비즈니스 로직과 분리
class StrategyRepository:
    def save_strategy(self, strategy: Strategy) -> str:
        return self.db_manager.save_to_strategies_db(strategy)
    
    def find_by_id(self, strategy_id: str) -> Strategy:
        return self.db_manager.find_from_strategies_db(strategy_id)
```

## 개발 우선순위 및 다음 단계

### 🎯 Phase 1: 컴포넌트 시스템 완성 (2주)
- [ ] **누락된 트리거 구현**: RSI, MACD, Bollinger Band 트리거
- [ ] **알림 액션 구현**: 슬랙/텔레그램 연동 NotificationAction
- [ ] **고급 조건 구현**: 복합 기술적 지표 조건
- [ ] **컴포넌트 테스트**: 각 컴포넌트별 단위 테스트 작성
- [ ] **전략 템플릿**: 자주 사용되는 전략 패턴 템플릿화

### 🎯 Phase 2: 실시간 거래 엔진 완성 (3주)
- [ ] **주문 실행 시스템**: 업비트 API 연동 주문 생성/취소
- [ ] **포지션 추적**: 실시간 포지션 상태 모니터링
- [ ] **리스크 관리**: 손실 한도, 일일 거래 한도 등 안전장치
- [ ] **오류 처리**: 네트워크 오류, API 한도 초과 등 예외 상황 대응
- [ ] **거래 로그**: 모든 거래 내역 상세 기록 및 분석

### 🎯 Phase 3: 고도화 및 최적화 (2주)
- [ ] **포트폴리오 시스템**: 다중 코인 동시 관리
- [ ] **스마트 스크리너**: AI 기반 종목 선별
- [ ] **성능 최적화**: 메모리 사용량 최적화, 병렬 처리
- [ ] **모니터링 대시보드**: 실시간 거래 상황 시각화
- [ ] **백업 및 복구**: 데이터 백업/복구 자동화

## 테스트 전략

### 단위 테스트 (각 컴포넌트별)
```python
def test_price_change_trigger():
    trigger = PriceChangeTrigger(change_percent=-5.0)
    market_data = create_test_market_data(price_change=-5.1)
    result = trigger.check_condition(market_data)
    assert result.triggered == True
```

### 통합 테스트 (전략 조합)
```python  
def test_pyramiding_strategy_integration():
    strategy = create_pyramiding_strategy()
    backtest_result = run_strategy_backtest(strategy, test_data)
    assert backtest_result.total_return > 0
```

### 실거래 시뮬레이션
```python
def test_live_trading_simulation():
    engine = TradingEngine(test_mode=True)
    strategy = load_test_strategy()
    result = engine.simulate_live_trading(strategy, duration_hours=24)
    assert result.orders_executed > 0
```

이 컴포넌트 시스템과 비즈니스 로직 구조는 확장성과 재사용성을 극대화하도록 설계되었으며, 사용자가 복잡한 거래 전략을 쉽게 구성할 수 있는 기반을 제공합니다.
