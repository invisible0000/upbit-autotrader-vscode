# WebSocket v6 ë¹„ë™ê¸° ë©”ì‹œì§€ í†µí•© ì‹œìŠ¤í…œ
## Pending State ê¸°ë°˜ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€ê¸°ì¤‘ í†µí•© ë©”ì»¤ë‹ˆì¦˜

> **í•µì‹¬ ê°œë…**: Rate Limiter ëŒ€ê¸° ì¤‘ í›„ì† êµ¬ë… ìš”ì²­ë“¤ì„ ìë™ìœ¼ë¡œ í†µí•©í•˜ì—¬ í•˜ë‚˜ì˜ ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ëŠ” ë‚´ì¬ì  ë¹„ë™ê¸° ë©”ì‹œì§€ í ì‹œìŠ¤í…œ

---

## ğŸ¯ ì‹œìŠ¤í…œ ê°œìš”

### ë¬¸ì œ ì •ì˜
- ë‹¤ìˆ˜ì˜ ì»´í¬ë„ŒíŠ¸ê°€ ë™ì‹œì— êµ¬ë… ìš”ì²­í•  ë•Œ ê°œë³„ ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ë©´ Rate Limit ìœ„ë°˜
- ë‹¨ìˆœí•œ ë°°ì¹˜ ì²˜ë¦¬ë¡œëŠ” ì‹¤ì‹œê°„ì„± ì†ì‹¤
- ìˆ˜ë™ í ê´€ë¦¬ëŠ” ë³µì¡ì„± ì¦ê°€

### í•´ê²°ì±…: Pending State ê¸°ë°˜ ìì—°ìŠ¤ëŸ¬ìš´ í†µí•©
Rate Limiterì˜ ëŒ€ê¸° ì‹œê°„ì„ í™œìš©í•œ **ë‚´ì¬ì  ë¹„ë™ê¸° ë©”ì‹œì§€ í**ë¡œ ë™ì‘

---

## ğŸ”„ í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜ íë¦„

### 1ë‹¨ê³„: êµ¬ë… ìš”ì²­ ë°œìƒ
```
ì»´í¬ë„ŒíŠ¸ A: ticker êµ¬ë… ìš”ì²­
â†“
SubscriptionManager: ë‚´ë¶€ ìƒíƒœ ì—…ë°ì´íŠ¸
â†“
WebSocketManager._on_subscription_change() í˜¸ì¶œ
```

### 2ë‹¨ê³„: Pending Task í™•ì¸ (í•µì‹¬!)
```python
# websocket_manager.pyì˜ _on_subscription_change()
if not self._pending_subscription_task or self._pending_subscription_task.done():
    # ìƒˆ Task ìƒì„±
    self._pending_subscription_task = asyncio.create_task(
        self._debounced_subscription_handler()
    )
else:
    # ì´ë¯¸ ì²˜ë¦¬ ì¤‘ - ìë™ í†µí•©ë¨!
    self.logger.debug("â³ ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ êµ¬ë… Task ìˆìŒ - ìë™ í†µí•©ë¨")
```

### 3ë‹¨ê³„: Rate Limiter ëŒ€ê¸° + í›„ì† ìš”ì²­ ìˆ˜ì§‘
```
Time: 0ms    - ì»´í¬ë„ŒíŠ¸ A: ticker êµ¬ë… â†’ Task ìƒì„±, Rate Limiter ëŒ€ê¸° ì‹œì‘
Time: 50ms   - ì»´í¬ë„ŒíŠ¸ B: orderbook êµ¬ë… â†’ ê¸°ì¡´ Task ìˆìŒ, SubscriptionManagerë§Œ ì—…ë°ì´íŠ¸
Time: 80ms   - ì»´í¬ë„ŒíŠ¸ C: trade êµ¬ë… â†’ ê¸°ì¡´ Task ìˆìŒ, SubscriptionManagerë§Œ ì—…ë°ì´íŠ¸
Time: 200ms  - Rate Limiter í•´ì œ â†’ í†µí•©ëœ ìƒíƒœ(A+B+C)ë¥¼ í•˜ë‚˜ì˜ ë©”ì‹œì§€ë¡œ ì „ì†¡
```

### 4ë‹¨ê³„: í†µí•© ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
```python
# Rate Limiter í•´ì œ ì‹œì ì— ì‹¤í–‰
streams = self._subscription_manager.get_realtime_streams(connection_type)
# streams = {ticker: {KRW-BTC}, orderbook: {KRW-BTC}, trade: {KRW-BTC}}

unified_message = await self._create_unified_message_v6_2(connection_type, streams)
# í•˜ë‚˜ì˜ ì—…ë¹„íŠ¸ WebSocket ë©”ì‹œì§€ë¡œ í†µí•©

await self._send_message(connection_type, unified_message)
```

---

## ğŸ§© êµ¬ì„± ìš”ì†Œ ì—­í• 

### WebSocketManager
- **Pending State ê´€ë¦¬**: `_pending_subscription_task` í†µí•´ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
- **ë””ë°”ìš´ì‹±**: `_debounce_delay` (100ms) ìœ¼ë¡œ ì¶”ê°€ ìš”ì²­ ìˆ˜ì§‘ ì‹œê°„ ì œê³µ
- **Rate Limiter í†µí•©**: `_apply_rate_limit()` ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€ê¸° ìƒì„±

### SubscriptionManager
- **ë¦¬ì–¼íƒ€ì„ ìƒíƒœ ê´€ë¦¬**: ëª¨ë“  êµ¬ë… ìƒíƒœë¥¼ ë©”ëª¨ë¦¬ì—ì„œ ì‹¤ì‹œê°„ í†µí•©
- **ìŠ¤ëƒ…ìƒ· í**: ì„ì‹œ ìš”ì²­ë“¤ì„ ë³„ë„ ê´€ë¦¬í•˜ì—¬ ë¦¬ì–¼íƒ€ì„ê³¼ ë¶„ë¦¬
- **ë³€ê²½ ê°ì§€**: ìƒíƒœ ë³€ê²½ ì‹œ WebSocketManagerì— ì¦‰ì‹œ ì•Œë¦¼

### Rate Limiter
- **ìì—°ìŠ¤ëŸ¬ìš´ ì§€ì—°**: ì˜ë„ì ì¸ ëŒ€ê¸° ì‹œê°„ì„ í†µí•© ê¸°íšŒë¡œ í™œìš©
- **ë™ì  ì¡°ì •**: 429 ì—ëŸ¬ ë°œìƒ ì‹œ ëŒ€ê¸° ì‹œê°„ ì¦ê°€ â†’ ë” ë§ì€ í†µí•© ê¸°íšŒ

---

## ğŸ“Š ë©”ì‹œì§€ í†µí•© ì˜ˆì‹œ

### Before (ê°œë³„ ì „ì†¡)
```json
// ë©”ì‹œì§€ 1
[{"ticket":"upbit_1"}, {"type":"ticker","codes":["KRW-BTC"]}, {"format":"DEFAULT"}]

// ë©”ì‹œì§€ 2 (50ms í›„)
[{"ticket":"upbit_2"}, {"type":"orderbook","codes":["KRW-BTC"]}, {"format":"DEFAULT"}]

// ë©”ì‹œì§€ 3 (80ms í›„)
[{"ticket":"upbit_3"}, {"type":"trade","codes":["KRW-BTC"]}, {"format":"DEFAULT"}]
```

### After (í†µí•© ì „ì†¡)
```json
// í•˜ë‚˜ì˜ í†µí•© ë©”ì‹œì§€ (200ms í›„)
[
  {"ticket":"upbit_unified_1234567890"},
  {"type":"ticker","codes":["KRW-BTC"]},
  {"type":"orderbook","codes":["KRW-BTC"]},
  {"type":"trade","codes":["KRW-BTC"]},
  {"format":"DEFAULT"}
]
```

---

## âš¡ ì„±ëŠ¥ ë° íš¨ìœ¨ì„±

### ì¥ì 
1. **Rate Limit ì¤€ìˆ˜**: ê°œë³„ ë©”ì‹œì§€ ëŒ€ì‹  í†µí•© ë©”ì‹œì§€ë¡œ API í˜¸ì¶œ íšŸìˆ˜ ê°ì†Œ
2. **ì‹¤ì‹œê°„ì„± ìœ ì§€**: ëŒ€ê¸° ì‹œê°„ì„ í™œìš©í•˜ì—¬ ì§€ì—° ìµœì†Œí™”
3. **ìë™ ìµœì í™”**: ìˆ˜ë™ ê°œì… ì—†ì´ ìì—°ìŠ¤ëŸ¬ìš´ ë°°ì¹˜ ì²˜ë¦¬
4. **ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ì„±**: ë‹¨ì¼ WebSocket ë©”ì‹œì§€ë¡œ ì—¬ëŸ¬ êµ¬ë… ì²˜ë¦¬

### ë©”íŠ¸ë¦­
- **í†µí•© ë¹„ìœ¨**: í‰ê·  3-5ê°œ ìš”ì²­ì´ í•˜ë‚˜ì˜ ë©”ì‹œì§€ë¡œ í†µí•©
- **ì§€ì—° ì‹œê°„**: Rate Limiter ëŒ€ê¸° ì‹œê°„ + 100ms ë””ë°”ìš´ìŠ¤
- **ì²˜ë¦¬ëŸ‰**: ê°œë³„ ì „ì†¡ ëŒ€ë¹„ 3-5ë°° íš¨ìœ¨ì„± í–¥ìƒ

---

## ğŸ”§ í•µì‹¬ ì„¤ì • ê°’

### ë””ë°”ìš´ìŠ¤ ì„¤ì •
```python
self._debounce_delay: float = 0.1  # 100ms ì¶”ê°€ ìš”ì²­ ìˆ˜ì§‘ ì‹œê°„
```

### Rate Limiter ì„¤ì •
```yaml
rate_limiter:
  enable_rate_limiter: true
  enable_dynamic_adjustment: true
  strategy: "balanced"  # conservative, balanced, aggressive
  recovery_delay: 0.5   # ëŒ€ê¸° ì‹œê°„ (í†µí•© ê¸°íšŒ)
```

---

## ğŸš¨ ì¤‘ìš”í•œ ì´í•´ì‚¬í•­

### 1. "ì¦‰ì‹œ ì „ì†¡" vs "Pending State"
- `await self._send_latest_subscriptions()` í˜¸ì¶œ ì‹œì—ë„ Rate Limiter ëŒ€ê¸° ë°œìƒ ê°€ëŠ¥
- ëŒ€ê¸° ì¤‘ì¸ ë™ì•ˆ ì¶”ê°€ êµ¬ë… ìš”ì²­ë“¤ì´ ìë™ìœ¼ë¡œ í†µí•©ë¨
- **"ì¦‰ì‹œ"ì˜ ì˜ë¯¸**: êµ¬ë… ë“±ë¡ í›„ ì „ì†¡ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¦‰ì‹œ ì‹œì‘ (ì‹¤ì œ ì „ì†¡ì€ Rate Limitì— ë”°ë¼ ì§€ì—° ê°€ëŠ¥)

### 2. ë‚´ì¬ì  ë¹„ë™ê¸° íì˜ ë™ì‘
- ëª…ì‹œì  í êµ¬ì¡° ì—†ì´ `_pending_subscription_task` í•˜ë‚˜ë¡œ ëª¨ë“  í†µí•© ì²˜ë¦¬
- Pending ìƒíƒœ ì¤‘ ìƒˆ ìš”ì²­ì€ SubscriptionManagerì—ë§Œ ì¶”ê°€ë˜ê³  TaskëŠ” ì¬ìƒì„±í•˜ì§€ ì•ŠìŒ
- Rate Limiter í•´ì œ ì‹œì ì— ìµœì‹  í†µí•© ìƒíƒœë¥¼ í•œë²ˆì— ì „ì†¡

### 3. ì‹œìŠ¤í…œì˜ ìê¸° ì¡°ì ˆ ëŠ¥ë ¥
- Rate Limit ì••ë°•ì´ í´ìˆ˜ë¡ â†’ ë” ë§ì€ ìš”ì²­ì´ í†µí•©ë¨ â†’ ë” ë†’ì€ íš¨ìœ¨ì„±
- Rate Limit ì—¬ìœ ë¡œìš¸ ë•Œ â†’ ë¹ ë¥¸ ê°œë³„ ì²˜ë¦¬ â†’ ë” ë‚˜ì€ ì‹¤ì‹œê°„ì„±
- **ë„¤íŠ¸ì›Œí¬ ìƒí™©ì— ë”°ë¥¸ ìë™ ì ì‘**

---

## ğŸ¯ ê²°ë¡ 

ì´ ì‹œìŠ¤í…œì€ **Rate Limiterì˜ ëŒ€ê¸° ì‹œê°„ì„ ì—­ì´ìš©**í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ë©”ì‹œì§€ í†µí•©ì„ ë‹¬ì„±í•˜ëŠ” í˜ì‹ ì ì¸ ì ‘ê·¼ë²•ì…ë‹ˆë‹¤.

- **ìˆ˜ë™ í ê´€ë¦¬ ë¶ˆí•„ìš”**
- **ì‹¤ì‹œê°„ì„±ê³¼ íš¨ìœ¨ì„±ì˜ ìµœì  ê· í˜•**
- **ë„¤íŠ¸ì›Œí¬ ìƒí™© ìë™ ì ì‘**
- **ì½”ë“œ ë³µì¡ì„± ìµœì†Œí™”**

Rate Limiterê°€ ë‹¨ìˆœí•œ ì œì•½ì´ ì•„ë‹Œ **í†µí•© ìµœì í™”ì˜ ë„êµ¬**ë¡œ í™œìš©ë˜ëŠ” ê²ƒì´ ì´ ì‹œìŠ¤í…œì˜ í•µì‹¬ ì•„ì´ë””ì–´ì…ë‹ˆë‹¤.
