# ğŸ› ï¸ DDD ë„ë©”ì¸ ê³„ì¸µ êµ¬í˜„ ê°€ì´ë“œ

> **ì‹¤ì œ ì½”ë“œë¡œ ë°°ìš°ëŠ” ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„ êµ¬í˜„ë²•**

## ğŸ“‹ ê°œìš”

ì´ ë¬¸ì„œëŠ” ì—…ë¹„íŠ¸ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œì—ì„œ ì‹¤ì œë¡œ êµ¬í˜„í•œ ë„ë©”ì¸ ê³„ì¸µ ì½”ë“œë¥¼ í†µí•´ DDD ì›ì¹™ì„ ì‹¤ë¬´ì— ì ìš©í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ êµ¬ì¡°

### ì „ì²´ êµ¬ì¡°
```
upbit_auto_trading/domain/
â”œâ”€â”€ entities/                 # ë„ë©”ì¸ ì—”í‹°í‹°
â”‚   â”œâ”€â”€ strategy.py          # ì „ëµ ì—”í‹°í‹° (í•µì‹¬)
â”‚   â”œâ”€â”€ trigger.py           # íŠ¸ë¦¬ê±° ì—”í‹°í‹°  
â”‚   â”œâ”€â”€ management_rule.py   # ê´€ë¦¬ ê·œì¹™ ì—”í‹°í‹°
â”‚   â””â”€â”€ strategy_factory.py  # íŒ©í† ë¦¬ í´ë˜ìŠ¤
â”œâ”€â”€ value_objects/           # ê°’ ê°ì²´
â”‚   â”œâ”€â”€ strategy_id.py       # ì „ëµ ì‹ë³„ì
â”‚   â”œâ”€â”€ trigger_id.py        # íŠ¸ë¦¬ê±° ì‹ë³„ì
â”‚   â””â”€â”€ comparison_operator.py # ë¹„êµ ì—°ì‚°ì
â””â”€â”€ exceptions/              # ë„ë©”ì¸ ì˜ˆì™¸
    â””â”€â”€ domain_exceptions.py
```

### ì˜ì¡´ì„± ë°©í–¥
```
UI Layer â†’ Service Layer â†’ Domain Layer
                      â†“
Repository Layer â†’ Infrastructure Layer
```

## ğŸ’ ê°’ ê°ì²´ (Value Objects) êµ¬í˜„

### 1. StrategyId - ì „ëµ ì‹ë³„ì

```python
@dataclass(frozen=True)
class StrategyId:
    """ì „ëµ ê³ ìœ  ì‹ë³„ì ê°’ ê°ì²´"""
    value: str

    def __post_init__(self):
        """ë„ë©”ì¸ ê·œì¹™ ê²€ì¦"""
        if not isinstance(self.value, str):
            raise InvalidStrategyIdError("ì „ëµ IDëŠ” ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        if not 3 <= len(self.value) <= 50:
            raise InvalidStrategyIdError(f"ì „ëµ IDëŠ” 3-50ìì—¬ì•¼ í•©ë‹ˆë‹¤: {self.value}")
        
        if not self.value[0].isalpha():
            raise InvalidStrategyIdError(f"ì „ëµ IDëŠ” ì˜ë¬¸ìë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤: {self.value}")

    def __str__(self) -> str:
        return self.value
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- `frozen=True`: ë¶ˆë³€ì„± ë³´ì¥
- `__post_init__`: ìƒì„± ì‹œì ì— ë„ë©”ì¸ ê·œì¹™ ê²€ì¦
- êµ¬ì²´ì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ (ê¸¸ì´, ì‹œì‘ ë¬¸ì ë“±)

### 2. ComparisonOperator - ë¹„êµ ì—°ì‚°ì

```python
class ComparisonOperator(Enum):
    """ë¹„êµ ì—°ì‚°ì ê°’ ê°ì²´"""
    GREATER_THAN = ">"
    LESS_THAN = "<"
    GREATER_EQUAL = ">="
    LESS_EQUAL = "<="
    EQUAL = "=="
    NOT_EQUAL = "!="
    APPROXIMATELY_EQUAL = "~="

    def evaluate(self, left: Union[int, float, Decimal], right: Union[int, float, Decimal]) -> bool:
        """ì‹¤ì œ ë¹„êµ ìˆ˜í–‰"""
        # Decimal íƒ€ì… ì§€ì›ìœ¼ë¡œ ì •í™•í•œ ê¸ˆìœµ ê³„ì‚°
        left_decimal = Decimal(str(left))
        right_decimal = Decimal(str(right))
        
        if self == ComparisonOperator.GREATER_THAN:
            return left_decimal > right_decimal
        elif self == ComparisonOperator.LESS_THAN:
            return left_decimal < right_decimal
        # ... ê¸°íƒ€ ì—°ì‚°ìë“¤
        
    def get_display_name(self) -> str:
        """UI í‘œì‹œìš© ì´ë¦„"""
        display_names = {
            ComparisonOperator.GREATER_THAN: "ì´ˆê³¼",
            ComparisonOperator.LESS_THAN: "ë¯¸ë§Œ",
            # ...
        }
        return display_names.get(self, self.value)
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- Enumìœ¼ë¡œ ì œí•œëœ ì„ íƒì§€ ë³´ì¥
- `evaluate()`: ê°’ ê°ì²´ê°€ ìì‹ ì˜ ì±…ì„ ìˆ˜í–‰
- `Decimal` ì‚¬ìš©: ê¸ˆìœµ ê³„ì‚°ì˜ ì •í™•ì„±

## ğŸ›ï¸ ë„ë©”ì¸ ì—”í‹°í‹° êµ¬í˜„

### 1. Strategy - ì „ëµ ì—”í‹°í‹° (Aggregate Root)

```python
@dataclass
class Strategy:
    """ë§¤ë§¤ ì „ëµ ë„ë©”ì¸ ì—”í‹°í‹° (Aggregate Root)"""
    id: StrategyId
    config: StrategyConfig
    is_active: bool = True
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)
    domain_events: List[DomainEvent] = field(default_factory=list)
    management_strategies: List['ManagementRule'] = field(default_factory=list)

    def activate(self) -> None:
        """ì „ëµ í™œì„±í™”"""
        if not self.is_active:
            self.is_active = True
            self.updated_at = datetime.now()
            self._add_domain_event(DomainEvent(
                event_type="strategy_activated",
                aggregate_id=str(self.id),
                event_data={"activated_at": self.updated_at.isoformat()}
            ))

    def deactivate(self) -> None:
        """ì „ëµ ë¹„í™œì„±í™”"""
        if self.is_active:
            self.is_active = False
            self.updated_at = datetime.now()
            self._add_domain_event(DomainEvent(
                event_type="strategy_deactivated",
                aggregate_id=str(self.id),
                event_data={"deactivated_at": self.updated_at.isoformat()}
            ))

    def add_management_strategy(self, rule: 'ManagementRule') -> None:
        """ê´€ë¦¬ ì „ëµ ì¶”ê°€"""
        self.management_strategies.append(rule)
        self.updated_at = datetime.now()
        self._add_domain_event(DomainEvent(
            event_type="management_strategy_added",
            aggregate_id=str(self.id),
            event_data={
                "rule_id": str(rule.id),
                "rule_type": rule.management_type.value
            }
        ))

    def _add_domain_event(self, event: DomainEvent) -> None:
        """ë„ë©”ì¸ ì´ë²¤íŠ¸ ì¶”ê°€ (ë‚´ë¶€ ë©”ì„œë“œ)"""
        self.domain_events.append(event)
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- **Aggregate Root**: ì¼ê´€ì„± ê²½ê³„ ì •ì˜
- **ë„ë©”ì¸ ì´ë²¤íŠ¸**: ìƒíƒœ ë³€í™”ë¥¼ ì´ë²¤íŠ¸ë¡œ ì¶”ì 
- **ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ**: activate(), deactivate() ë“±
- **ë¶ˆë³€ì‹ ë³´ì¥**: ë‚´ë¶€ ìƒíƒœ ì¼ê´€ì„± ìœ ì§€

### 2. Trigger - íŠ¸ë¦¬ê±° ì—”í‹°í‹°

```python
@dataclass
class Trigger:
    """ë§¤ë§¤ ì¡°ê±´ íŠ¸ë¦¬ê±° ë„ë©”ì¸ ì—”í‹°í‹°"""
    id: TriggerId
    trigger_type: TriggerType
    variable: TradingVariable
    operator: ComparisonOperator
    target_value: str
    external_variable: Optional[TradingVariable] = None
    is_active: bool = True
    created_at: datetime = field(default_factory=datetime.now)
    domain_events: List[DomainEvent] = field(default_factory=list)

    def evaluate(self, market_data: Any = None) -> TriggerEvaluationResult:
        """íŠ¸ë¦¬ê±° ì¡°ê±´ í‰ê°€"""
        if not self.is_active:
            return TriggerEvaluationResult.failure("ë¹„í™œì„± íŠ¸ë¦¬ê±°")
        
        # ì„ì‹œ êµ¬í˜„ - ì‹¤ì œë¡œëŠ” market_data ê¸°ë°˜ ë³µì¡í•œ ë¡œì§
        evaluation_successful = True
        
        result = TriggerEvaluationResult.success() if evaluation_successful else TriggerEvaluationResult.failure("ì¡°ê±´ ë¶ˆë§Œì¡±")
        
        self._add_domain_event(DomainEvent(
            event_type="trigger_evaluated",
            aggregate_id=str(self.id),
            event_data={
                "result": "success" if evaluation_successful else "failure",
                "evaluated_at": datetime.now().isoformat()
            }
        ))
        
        return result

    def check_compatibility(self, other_variable: TradingVariable) -> float:
        """ë‹¤ë¥¸ ë³€ìˆ˜ì™€ì˜ í˜¸í™˜ì„± ì ìˆ˜ ë°˜í™˜ (0.0 ~ 1.0)"""
        return self.variable.is_compatible_with(other_variable)

    def to_human_readable(self) -> str:
        """ì‚¬ìš©ì ì¹œí™”ì  í‘œí˜„"""
        if self.external_variable:
            return f"{self.variable.display_name} {self.operator.get_display_name()} {self.external_variable.display_name}"
        else:
            return f"{self.variable.display_name} {self.operator.get_display_name()} {self.target_value}"
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- **ë„ë©”ì¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ**: ë³µì¡í•œ í‰ê°€ ë¡œì§ì€ ë³„ë„ ì„œë¹„ìŠ¤ë¡œ ìœ„ì„ ì˜ˆì •
- **í˜¸í™˜ì„± ê²€ì¦**: ë‹¤ë¥¸ ë„ë©”ì¸ ê°ì²´ì™€ì˜ ìƒí˜¸ì‘ìš©
- **í‘œí˜„ ë©”ì„œë“œ**: UI í‘œì‹œë¥¼ ìœ„í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

## ğŸ­ íŒ©í† ë¦¬ íŒ¨í„´ êµ¬í˜„

### Strategy Factory

```python
class StrategyFactory:
    """ì „ëµ ìƒì„±ì„ ìœ„í•œ íŒ©í† ë¦¬ í´ë˜ìŠ¤"""
    
    @staticmethod
    def create_basic_7_rule_strategy() -> Strategy:
        """ê¸°ë³¸ 7ê·œì¹™ ì „ëµ ìƒì„±"""
        strategy_id = StrategyId("BASIC_7_RULE_STRATEGY")
        config = StrategyConfig({
            "name": "ê¸°ë³¸ 7ê·œì¹™ ì „ëµ",
            "description": "RSI ê¸°ë°˜ ì§„ì… + ë¶ˆíƒ€ê¸°/ë¬¼íƒ€ê¸° + íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘",
            "risk_level": 3,
            "expected_return": 15.0
        })
        
        strategy = Strategy(id=strategy_id, config=config)
        
        # ê´€ë¦¬ ì „ëµë“¤ ì¶”ê°€
        strategy.add_management_strategy(create_scale_in_buying_rule())
        strategy.add_management_strategy(create_pyramid_buying_rule())
        strategy.add_management_strategy(create_trailing_stop_rule())
        
        return strategy

    @staticmethod  
    def create_conservative_strategy() -> Strategy:
        """ë³´ìˆ˜ì  ì „ëµ ìƒì„±"""
        strategy_id = StrategyId("CONSERVATIVE_STRATEGY")
        config = StrategyConfig({
            "name": "ë³´ìˆ˜ì  ì „ëµ",
            "description": "ì•ˆì •ì ì¸ ìˆ˜ìµ ì¶”êµ¬, ê³ ì • ì†ì ˆ/ìµì ˆë§Œ ì‚¬ìš©",
            "risk_level": 1,
            "expected_return": 8.0
        })
        
        strategy = Strategy(id=strategy_id, config=config)
        strategy.add_management_strategy(create_fixed_stop_take_rule())
        
        return strategy
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- **ë³µì¡ì„± ìº¡ìŠí™”**: ë³µì¡í•œ ê°ì²´ ìƒì„± ë¡œì§ì„ ìˆ¨ê¹€
- **í…œí”Œë¦¿ ì œê³µ**: ì¼ë°˜ì ì¸ ì‚¬ìš© íŒ¨í„´ì„ ë¯¸ë¦¬ ì •ì˜
- **í™•ì¥ì„±**: ìƒˆë¡œìš´ ì „ëµ í…œí”Œë¦¿ ì‰½ê²Œ ì¶”ê°€ ê°€ëŠ¥

## ğŸ¯ ë„ë©”ì¸ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ

### ë„ë©”ì¸ ì´ë²¤íŠ¸ ì •ì˜

```python
@dataclass
class DomainEvent:
    """ë„ë©”ì¸ ì´ë²¤íŠ¸ ê°’ ê°ì²´"""
    event_type: str
    aggregate_id: str
    timestamp: datetime = field(default_factory=datetime.now)
    event_data: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        """ì§ë ¬í™”ë¥¼ ìœ„í•œ ë”•ì…”ë„ˆë¦¬ ë³€í™˜"""
        return {
            "event_type": self.event_type,
            "aggregate_id": self.aggregate_id,
            "timestamp": self.timestamp.isoformat(),
            "event_data": self.event_data
        }
```

### ì´ë²¤íŠ¸ í™œìš© ì˜ˆì‹œ

```python
# ì „ëµ ìƒì„± ì‹œ
strategy = Strategy(id=strategy_id, config=config)
# ìë™ìœ¼ë¡œ strategy_created ì´ë²¤íŠ¸ ë°œìƒ

# ê´€ë¦¬ ì „ëµ ì¶”ê°€ ì‹œ  
strategy.add_management_strategy(rule)
# management_strategy_added ì´ë²¤íŠ¸ ë°œìƒ

# ì´ë²¤íŠ¸ ì²˜ë¦¬ (í–¥í›„ Event Handlerì—ì„œ)
for event in strategy.domain_events:
    if event.event_type == "strategy_created":
        # ê°ì‚¬ ë¡œê·¸ ê¸°ë¡, ì•Œë¦¼ ë°œì†¡ ë“±
        pass
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- **ê´€ì‹¬ì‚¬ ë¶„ë¦¬**: í•µì‹¬ ë¡œì§ê³¼ ë¶€ìˆ˜ íš¨ê³¼ ë¶„ë¦¬
- **ê°ì‚¬ ì¶”ì **: ëª¨ë“  ë„ë©”ì¸ ë³€í™” ê¸°ë¡
- **í™•ì¥ì„±**: ìƒˆë¡œìš´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì‰½ê²Œ ì¶”ê°€

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. ê°’ ê°ì²´ í…ŒìŠ¤íŠ¸

```python
def test_strategy_id_validation():
    """StrategyId ê²€ì¦ ê·œì¹™ í…ŒìŠ¤íŠ¸"""
    # ì •ìƒ ì¼€ì´ìŠ¤
    valid_id = StrategyId("BASIC_STRATEGY")
    assert str(valid_id) == "BASIC_STRATEGY"
    
    # ì˜ˆì™¸ ì¼€ì´ìŠ¤ë“¤
    with pytest.raises(InvalidStrategyIdError):
        StrategyId("AB")  # ë„ˆë¬´ ì§§ìŒ
    
    with pytest.raises(InvalidStrategyIdError):
        StrategyId("1STRATEGY")  # ìˆ«ìë¡œ ì‹œì‘
```

### 2. ì—”í‹°í‹° í…ŒìŠ¤íŠ¸

```python
def test_strategy_lifecycle():
    """ì „ëµ ìƒëª…ì£¼ê¸° í…ŒìŠ¤íŠ¸"""
    # Given
    strategy_id = StrategyId("TEST_STRATEGY")
    config = StrategyConfig({"risk_level": 3})
    strategy = Strategy(id=strategy_id, config=config)
    
    # When: ë¹„í™œì„±í™”
    strategy.deactivate()
    
    # Then: ìƒíƒœ ë³€í™” í™•ì¸
    assert strategy.is_active == False
    assert len(strategy.domain_events) == 2  # created + deactivated
    
    # When: ì¬í™œì„±í™”
    strategy.activate()
    
    # Then
    assert strategy.is_active == True
    assert len(strategy.domain_events) == 3  # created + deactivated + activated
```

### 3. íŒ©í† ë¦¬ í…ŒìŠ¤íŠ¸

```python
def test_factory_creates_valid_strategy():
    """íŒ©í† ë¦¬ê°€ ì˜¬ë°”ë¥¸ ì „ëµì„ ìƒì„±í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸"""
    # When
    strategy = create_basic_7_rule_strategy()
    
    # Then
    assert isinstance(strategy.id, StrategyId)
    assert strategy.is_active == True
    assert len(strategy.management_strategies) == 3  # ë¶ˆíƒ€ê¸°, ë¬¼íƒ€ê¸°, íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘
    assert strategy.config.name == "ê¸°ë³¸ 7ê·œì¹™ ì „ëµ"
```

**ğŸ“ í•µì‹¬ í¬ì¸íŠ¸**:
- **ë„ë©”ì¸ ê·œì¹™ ê²€ì¦**: ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì´ ì˜¬ë°”ë¥´ê²Œ ì ìš©ë˜ëŠ”ì§€ í™•ì¸
- **ìƒíƒœ ë³€í™” ì¶”ì **: ë„ë©”ì¸ ì´ë²¤íŠ¸ë¡œ ìƒíƒœ ë³€í™” ê²€ì¦
- **íŒ©í† ë¦¬ ê²€ì¦**: ë³µì¡í•œ ê°ì²´ê°€ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸

## âš ï¸ ì£¼ì˜ì‚¬í•­ê³¼ Best Practices

### 1. ìˆœí™˜ ì°¸ì¡° ë°©ì§€

```python
# âŒ ì˜ëª»ëœ ë°©ë²•
# strategy.py
from .management_rule import ManagementRule

# management_rule.py
from .strategy import Strategy  # ìˆœí™˜ ì°¸ì¡°!

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from .strategy import Strategy
```

### 2. ë„ë©”ì¸ ìˆœìˆ˜ì„± ìœ ì§€

```python
# âŒ ë„ë©”ì¸ ì—”í‹°í‹°ì— ì¸í”„ë¼ ì˜ì¡´ì„±
class Strategy:
    def save_to_database(self):  # ì˜ëª»ë¨!
        db.session.add(self)

# âœ… Repository íŒ¨í„´ìœ¼ë¡œ ë¶„ë¦¬
class StrategyRepository:
    def save(self, strategy: Strategy) -> None:
        # DB ì €ì¥ ë¡œì§
```

### 3. ë¶ˆë³€ì„± ë³´ì¥

```python
# âœ… ê°’ ê°ì²´ëŠ” ë¶ˆë³€
@dataclass(frozen=True)
class StrategyId:
    value: str

# âœ… ì—”í‹°í‹°ëŠ” ì œì–´ëœ ë³€ê²½ë§Œ í—ˆìš©
class Strategy:
    def update_name(self, new_name: str) -> None:
        # ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦ í›„ ë³€ê²½
        if len(new_name) < 3:
            raise ValueError("ì „ëµ ì´ë¦„ì€ 3ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
        self.config.name = new_name
        self.updated_at = datetime.now()
```

## ğŸ”— ë‹¤ìŒ ë‹¨ê³„

### Repository íŒ¨í„´
```python
class StrategyRepository(ABC):
    @abstractmethod
    def save(self, strategy: Strategy) -> None: pass
    
    @abstractmethod
    def find_by_id(self, strategy_id: StrategyId) -> Optional[Strategy]: pass
```

### Application Service
```python
class StrategyApplicationService:
    def __init__(self, strategy_repo: StrategyRepository):
        self.strategy_repo = strategy_repo
    
    def create_basic_strategy(self) -> StrategyId:
        strategy = create_basic_7_rule_strategy()
        self.strategy_repo.save(strategy)
        return strategy.id
```

## ğŸ“š í•™ìŠµ ìë£Œ

### ì¶”ì²œ ë„ì„œ
- "ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„" - ì—ë¦­ ì—ë°˜ìŠ¤
- "ë§Œë“¤ë©´ì„œ ë°°ìš°ëŠ” í´ë¦° ì•„í‚¤í…ì²˜" - í†° í™ˆë²„ê·¸

### í•µì‹¬ ê°œë…
- **Aggregate**: ì¼ê´€ì„± ê²½ê³„
- **Value Object**: ë¶ˆë³€ ê°’ ê°ì²´
- **Domain Event**: ë„ë©”ì¸ ë³€í™” ì¶”ì 
- **Factory**: ë³µì¡í•œ ê°ì²´ ìƒì„±

---

**ğŸ¯ ìš”ì•½**: DDDëŠ” ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ë¡ ì…ë‹ˆë‹¤. ì™„ë²½í•œ ì´ë¡ ë³´ë‹¤ëŠ” **ì‹¤ë¬´ì— ë§ëŠ” ì ì§„ì  ì ìš©**ì´ ì„±ê³µì˜ ì—´ì‡ ì…ë‹ˆë‹¤.
