# CQRS Query Layer êµ¬í˜„ ê°€ì´ë“œ

## ğŸ¯ êµ¬í˜„ ëª©í‘œ
Commandì™€ Query ì±…ì„ì„ ë¶„ë¦¬í•˜ì—¬ ë³µì¡í•œ ì½ê¸° ì¿¼ë¦¬ë¥¼ ìµœì í™”í•˜ê³ , UI ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” ì „ìš© Query Serviceë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

## ğŸ“ ì•„í‚¤í…ì²˜ ì„¤ê³„ ì›ì¹™

### 1. **Layer ë¶„ë¦¬ ì›ì¹™**
```
Application Layer
â”œâ”€â”€ Commands (ì“°ê¸° ì‘ì—…)
â””â”€â”€ Queries (ì½ê¸° ì‘ì—…) â† ì´ë²ˆ êµ¬í˜„ ë²”ìœ„
    â”œâ”€â”€ DTO: UI ìµœì í™”ëœ ë°ì´í„° êµ¬ì¡°
    â”œâ”€â”€ Handlers: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìº¡ìŠí™”
    â”œâ”€â”€ Dispatcher: ìš”ì²­ ë¼ìš°íŒ…
    â””â”€â”€ Service: íŒŒì‚¬ë“œ íŒ¨í„´
```

### 2. **ì±…ì„ ë¶„ë¦¬ ë§¤íŠ¸ë¦­ìŠ¤**

| ì»´í¬ë„ŒíŠ¸ | ì±…ì„ | ê¸ˆì§€ì‚¬í•­ |
|---------|------|----------|
| Query DTO | UI ìš”êµ¬ì‚¬í•­ ë°˜ì˜ | Domain ë¡œì§ í¬í•¨ |
| Query Handler | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ | Infrastructure ì§ì ‘ ì ‘ê·¼ |
| Query Dispatcher | ìš”ì²­ ë¼ìš°íŒ… | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ |
| Query Service | í†µí•© ì¸í„°í˜ì´ìŠ¤ ì œê³µ | Handler ë¡œì§ ì§ì ‘ êµ¬í˜„ |

## ğŸ› ï¸ ë‹¨ê³„ë³„ êµ¬í˜„ ê°€ì´ë“œ

### Step 1: í´ë” êµ¬ì¡° ìƒì„±
```bash
application/queries/
â”œâ”€â”€ dto/                    # Query ì „ìš© DTO
â”œâ”€â”€ handlers/              # Query Handler êµ¬í˜„
â”œâ”€â”€ query_dispatcher.py    # ìš”ì²­ ë¼ìš°íŒ…
â”œâ”€â”€ query_service.py       # íŒŒì‚¬ë“œ íŒ¨í„´
â””â”€â”€ query_container.py     # ì˜ì¡´ì„± ì£¼ì…
```

### Step 2: Query DTO ì„¤ê³„
```python
@dataclass
class StrategyListQuery:
    """UI í•„í„°ë§ ìš”êµ¬ì‚¬í•­ì„ ë°˜ì˜í•œ Query DTO"""
    page: int = 1
    page_size: int = 20
    status_filter: Optional[StrategyStatus] = None
    search_text: Optional[str] = None
    sort_by: SortField = SortField.CREATED_AT
    sort_direction: SortDirection = SortDirection.DESC
    date_range: Optional[DateRange] = None

@dataclass
class StrategyListResponse:
    """UI í‘œì‹œë¥¼ ìœ„í•œ ì‘ë‹µ DTO"""
    strategies: List[StrategyDTO]
    total_count: int
    page: int
    page_size: int
    has_next: bool
    performance_metrics: QueryPerformanceMetrics
```

**ì„¤ê³„ ê°€ì´ë“œë¼ì¸**:
- UI ì»´í¬ë„ŒíŠ¸ì˜ ì‹¤ì œ í•„ìš”ì‚¬í•­ ë°˜ì˜
- í˜ì´ì§•, í•„í„°ë§, ì •ë ¬ì„ í•˜ë‚˜ì˜ ê°ì²´ë¡œ í†µí•©
- ì‘ë‹µì— ì„±ëŠ¥ ë©”íŠ¸ë¦­ í¬í•¨ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ ì§€ì›

### Step 3: Query Handler êµ¬í˜„
```python
class StrategyListQueryHandler(BaseQueryHandler[StrategyListQuery, StrategyListResponse]):
    """ì „ëµ ëª©ë¡ ì¡°íšŒ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§"""

    def __init__(self, strategy_repository: StrategyRepository):
        self.strategy_repository = strategy_repository

    def handle(self, query: StrategyListQuery) -> StrategyListResponse:
        start_time = time.time()

        # 1. ì…ë ¥ ìœ íš¨ì„± ê²€ì¦
        self._validate_query(query)

        # 2. Repository í˜¸ì¶œ
        strategies, total_count = self.strategy_repository.find_strategies_with_filters(
            status=query.status_filter,
            search_text=query.search_text,
            sort_by=query.sort_by,
            sort_direction=query.sort_direction,
            date_range=query.date_range,
            offset=(query.page - 1) * query.page_size,
            limit=query.page_size
        )

        # 3. DTO ë³€í™˜
        strategy_dtos = [StrategyDTO.from_entity(s) for s in strategies]

        # 4. ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚°
        execution_time = time.time() - start_time
        metrics = QueryPerformanceMetrics(
            execution_time=execution_time,
            query_type="StrategyList",
            record_count=len(strategy_dtos)
        )

        return StrategyListResponse(
            strategies=strategy_dtos,
            total_count=total_count,
            page=query.page,
            page_size=query.page_size,
            has_next=total_count > query.page * query.page_size,
            performance_metrics=metrics
        )
```

**êµ¬í˜„ ê°€ì´ë“œë¼ì¸**:
- ì…ë ¥ ìœ íš¨ì„± ê²€ì¦ í•„ìˆ˜
- Repository íŒ¨í„´ìœ¼ë¡œ ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™”
- ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìë™ ê³„ì‚°
- Domain Entity â†’ DTO ë³€í™˜ ëª…ì‹œì  ì²˜ë¦¬

### Step 4: Query Dispatcher êµ¬í˜„
```python
class QueryDispatcher:
    """Queryì™€ Handler ë§¤í•‘ ê´€ë¦¬"""

    def __init__(self):
        self._handlers: Dict[Type, Callable] = {}

    def register_handler(self, query_type: Type[TQuery], handler: Callable[[TQuery], TResponse]):
        """Handler ë“±ë¡"""
        self._handlers[query_type] = handler

    def dispatch(self, query: TQuery) -> TResponse:
        """Query ì‹¤í–‰"""
        query_type = type(query)
        if query_type not in self._handlers:
            raise ValueError(f"No handler registered for {query_type}")

        handler = self._handlers[query_type]
        return handler(query)
```

### Step 5: Query Service Facade êµ¬í˜„
```python
class QueryService:
    """ê³ ìˆ˜ì¤€ Query ì‹¤í–‰ ì¸í„°í˜ì´ìŠ¤"""

    def __init__(self, dispatcher: QueryDispatcher):
        self.dispatcher = dispatcher

    def get_strategy_list(self, query: StrategyListQuery) -> StrategyListResponse:
        """ì „ëµ ëª©ë¡ ì¡°íšŒ"""
        return self.dispatcher.dispatch(query)

    def get_strategy_detail(self, query: StrategyDetailQuery) -> StrategyDetailResponse:
        """ì „ëµ ìƒì„¸ ì¡°íšŒ"""
        return self.dispatcher.dispatch(query)
```

### Step 6: ì˜ì¡´ì„± ì£¼ì… Container êµ¬í˜„
```python
class QueryServiceContainer:
    """Query Layer ì˜ì¡´ì„± ê´€ë¦¬"""

    def __init__(self):
        self._query_service = None
        self._dispatcher = None

    def get_query_service(self) -> QueryService:
        """Query Service ì‹±ê¸€í†¤ ì œê³µ"""
        if self._query_service is None:
            self._query_service = self._create_query_service()
        return self._query_service

    def _create_query_service(self) -> QueryService:
        """Query Service ìƒì„± ë° Handler ë“±ë¡"""
        dispatcher = QueryDispatcher()

        # Handler ë“±ë¡
        strategy_handler = StrategyListQueryHandler(MockStrategyRepository())
        dispatcher.register_handler(StrategyListQuery, strategy_handler.handle)

        return QueryService(dispatcher)
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - Handler ë…ë¦½ ê²€ì¦**
```python
def test_strategy_list_query_handler():
    # Mock Repository ìƒì„±
    mock_repo = Mock()
    mock_repo.find_strategies_with_filters.return_value = ([mock_strategy], 1)

    # Handler í…ŒìŠ¤íŠ¸
    handler = StrategyListQueryHandler(mock_repo)
    result = handler.handle(query)

    # ê²€ì¦
    assert len(result.strategies) == 1
    assert result.total_count == 1
    mock_repo.find_strategies_with_filters.assert_called_once()
```

### 2. **í†µí•© í…ŒìŠ¤íŠ¸ - ì „ì²´ í”Œë¡œìš° ê²€ì¦**
```python
def test_query_service_integration():
    # Containerë¥¼ í†µí•œ ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
    container = QueryServiceContainer()
    query_service = container.get_query_service()

    # ì‹¤ì œ Query ì‹¤í–‰
    query = StrategyListQuery(page=1, page_size=10)
    result = query_service.get_strategy_list(query)

    # ì „ì²´ í”Œë¡œìš° ê²€ì¦
    assert result.strategies is not None
    assert result.performance_metrics.execution_time > 0
```

## ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 1. **Query ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸**
- [ ] ì ì ˆí•œ í˜ì´ì§• í¬ê¸° ì„¤ì • (ê¸°ë³¸ 20ê°œ)
- [ ] ë¶ˆí•„ìš”í•œ JOIN íšŒí”¼
- [ ] ì¸ë±ìŠ¤ í™œìš© ê°€ëŠ¥í•œ í•„í„°ë§ ì¡°ê±´
- [ ] ì„±ëŠ¥ ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§

### 2. **ë©”ëª¨ë¦¬ ê´€ë¦¬**
- ëŒ€ìš©ëŸ‰ ê²°ê³¼ì…‹ì— ëŒ€í•œ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ê³ ë ¤
- DTO ë³€í™˜ ì‹œ ë¶ˆí•„ìš”í•œ ë°ì´í„° ì œì™¸
- Cache ì „ëµìœ¼ë¡œ ë°˜ë³µ ì¿¼ë¦¬ ìµœì í™”

## ğŸ” ë””ë²„ê¹… ê°€ì´ë“œ

### ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œì™€ í•´ê²°ì±…

1. **Handler ë“±ë¡ ëˆ„ë½**
   ```python
   # ì¦ìƒ: ValueError: No handler registered for <query_type>
   # í•´ê²°: Containerì—ì„œ Handler ë“±ë¡ í™•ì¸
   dispatcher.register_handler(StrategyListQuery, handler.handle)
   ```

2. **Mock Repository ì„¤ì • ì˜¤ë¥˜**
   ```python
   # ì¦ìƒ: AttributeError: Mock object has no attribute
   # í•´ê²°: Mock ë©”ì„œë“œ ëª…ì‹œì  ì„¤ì •
   mock_repo.find_strategies_with_filters = Mock(return_value=([], 0))
   ```

3. **ì„±ëŠ¥ ì €í•˜**
   ```python
   # ì¦ìƒ: Query ì‹¤í–‰ ì‹œê°„ 1ì´ˆ ì´ˆê³¼
   # í•´ê²°: ì„±ëŠ¥ ë©”íŠ¸ë¦­ í™•ì¸ ë° ì¿¼ë¦¬ ìµœì í™”
   assert result.performance_metrics.execution_time < 1.0
   ```

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### êµ¬í˜„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] Query DTO ì„¤ê³„ ì™„ë£Œ
- [ ] Query Handler êµ¬í˜„ ì™„ë£Œ
- [ ] Query Dispatcher êµ¬í˜„ ì™„ë£Œ
- [ ] Query Service Facade êµ¬í˜„ ì™„ë£Œ
- [ ] ì˜ì¡´ì„± ì£¼ì… Container êµ¬í˜„ ì™„ë£Œ
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ì™„ë£Œ
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„± ì™„ë£Œ
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í†µê³¼ (1ms ì´ë‚´)

### ì½”ë“œ í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ê° ì»´í¬ë„ŒíŠ¸ ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì¤€ìˆ˜
- [ ] Domain Entityì™€ DTO ë¶„ë¦¬
- [ ] Mockì„ í™œìš©í•œ ë…ë¦½ì  í…ŒìŠ¤íŠ¸
- [ ] ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìë™ ê³„ì‚°
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ìœ íš¨ì„± ê²€ì¦

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼ êµ¬í˜„í•˜ë©´ í™•ì¥ ê°€ëŠ¥í•˜ê³  í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ CQRS Query Layerë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
