# CQRS Query Layer êµ¬í˜„ - ë¬¸ì œí•´ê²°

## ğŸš¨ ì£¼ìš” ë°œìƒ ë¬¸ì œì™€ í•´ê²° ê³¼ì •

### ë¬¸ì œ 1: Handler ë“±ë¡ ëˆ„ë½ìœ¼ë¡œ ì¸í•œ ëŸ°íƒ€ì„ ì—ëŸ¬

#### ğŸ”´ ë¬¸ì œ ìƒí™©
```python
# ì—ëŸ¬ ë©”ì‹œì§€
ValueError: No handler registered for <class 'StrategyListQuery'>

# ë°œìƒ ì§€ì 
result = query_service.get_strategy_list(query)  # ì´ ì‹œì ì—ì„œ ì—ëŸ¬ ë°œìƒ
```

#### ğŸ” ì›ì¸ ë¶„ì„
QueryDispatcherì— Handlerê°€ ì œëŒ€ë¡œ ë“±ë¡ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ë°œìƒ:
```python
# ë¬¸ì œê°€ ëœ ì´ˆê¸° ì½”ë“œ
class QueryServiceContainer:
    def _create_query_service(self) -> QueryService:
        dispatcher = QueryDispatcher()
        # Handler ë“±ë¡ ëˆ„ë½!
        return QueryService(dispatcher)
```

#### âœ… í•´ê²° ë°©ë²•
Containerì—ì„œ ëª¨ë“  Handlerë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë“±ë¡:
```python
def _create_query_service(self) -> QueryService:
    dispatcher = QueryDispatcher()

    # ëª¨ë“  Handler ëª…ì‹œì  ë“±ë¡
    strategy_handler = StrategyListQueryHandler(MockStrategyRepository())
    dispatcher.register_handler(StrategyListQuery, strategy_handler.handle)

    dashboard_handler = DashboardQueryHandler(MockStrategyRepository())
    dispatcher.register_handler(DashboardQuery, dashboard_handler.handle)

    return QueryService(dispatcher)
```

#### ğŸ“š êµí›ˆ
- ì˜ì¡´ì„± ì£¼ì… Containerì—ì„œëŠ” ëª¨ë“  ì˜ì¡´ì„±ì„ ëª…ì‹œì ìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•¨
- íƒ€ì… ì•ˆì „ì„±ì„ ìœ„í•´ Handler ë“±ë¡ ì‹œ íƒ€ì… ì²´í¬ ì¶”ê°€ ê³ ë ¤

---

### ë¬¸ì œ 2: Mock Repository ë©”ì„œë“œ í˜¸ì¶œ ì‹œ AttributeError

#### ğŸ”´ ë¬¸ì œ ìƒí™©
```python
# ì—ëŸ¬ ë©”ì‹œì§€
AttributeError: 'Mock' object has no attribute 'find_strategies_with_filters'

# ë°œìƒ ì§€ì 
strategies, total_count = self.strategy_repository.find_strategies_with_filters(...)
```

#### ğŸ” ì›ì¸ ë¶„ì„
Mock ê°ì²´ì— Repository ë©”ì„œë“œê°€ ì‚¬ì „ì— ì •ì˜ë˜ì§€ ì•Šì•„ì„œ ë°œìƒ:
```python
# ë¬¸ì œê°€ ëœ ì´ˆê¸° í…ŒìŠ¤íŠ¸ ì½”ë“œ
def test_strategy_list_query():
    mock_repo = Mock()  # ë©”ì„œë“œ ì •ì˜ ì—†ìŒ
    handler = StrategyListQueryHandler(mock_repo)
    result = handler.handle(query)  # ì—¬ê¸°ì„œ AttributeError ë°œìƒ
```

#### âœ… í•´ê²° ë°©ë²•
Mock ê°ì²´ì— ëª¨ë“  í•„ìš”í•œ ë©”ì„œë“œë¥¼ ì‚¬ì „ ì •ì˜:
```python
def setUp(self):
    self.mock_repository = Mock()
    # ëª¨ë“  Repository ë©”ì„œë“œ ì‚¬ì „ ì •ì˜
    self.mock_repository.find_strategies_with_filters = Mock()
    self.mock_repository.find_by_id = Mock()
    self.mock_repository.count_active_strategies = Mock()

    # ê¸°ë³¸ ë°˜í™˜ê°’ ì„¤ì •
    self.mock_repository.find_strategies_with_filters.return_value = ([], 0)
```

#### ğŸ“š êµí›ˆ
- Mock ê°ì²´ëŠ” ì‚¬ìš©í•  ëª¨ë“  ë©”ì„œë“œë¥¼ ì‚¬ì „ì— ì •ì˜í•´ì•¼ í•¨
- setUp ë©”ì„œë“œì—ì„œ ì¼ê´€ëœ Mock ì„¤ì •ì„ í†µí•´ í…ŒìŠ¤íŠ¸ ì•ˆì •ì„± í™•ë³´

---

### ë¬¸ì œ 3: í˜ì´ì§• ê³„ì‚° ë¡œì§ ì˜¤ë¥˜

#### ğŸ”´ ë¬¸ì œ ìƒí™©
```python
# ì˜ëª»ëœ has_next ê³„ì‚°
has_next=total_count > query.page * query.page_size

# ì˜ˆì‹œ: total_count=25, page=2, page_size=10
# ê³„ì‚°: 25 > 2 * 10 = 25 > 20 = True (ì˜¬ë°”ë¦„)
# í•˜ì§€ë§Œ page=3ì¼ ë•Œ: 25 > 3 * 10 = 25 > 30 = False (ë§ˆì§€ë§‰ í˜ì´ì§€ì¸ë° has_next=False)
```

#### ğŸ” ì›ì¸ ë¶„ì„
í˜ì´ì§• ê³„ì‚°ì—ì„œ í˜„ì¬ í˜ì´ì§€ê¹Œì§€ì˜ ì´ ì¡°íšŒëœ ë ˆì½”ë“œ ìˆ˜ë¥¼ ì˜ëª» ê³„ì‚°:
```python
# ë¬¸ì œ: ë‹¤ìŒ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ë¥¼ ì˜ëª» ê³„ì‚°
current_end = query.page * query.page_size  # í˜„ì¬ê¹Œì§€ ì¡°íšŒí•œ ë ˆì½”ë“œ ìˆ˜
has_next = total_count > current_end
```

#### âœ… í•´ê²° ë°©ë²•
ì •í™•í•œ í˜ì´ì§• ë¡œì§ìœ¼ë¡œ ìˆ˜ì •:
```python
def handle(self, query: StrategyListQuery) -> StrategyListResponse:
    # Repositoryì—ì„œ ì¡°íšŒ
    strategies, total_count = self.strategy_repository.find_strategies_with_filters(
        offset=(query.page - 1) * query.page_size,  # 0-based offset
        limit=query.page_size
    )

    # ì •í™•í•œ has_next ê³„ì‚°
    total_pages = math.ceil(total_count / query.page_size) if total_count > 0 else 0
    has_next = query.page < total_pages

    return StrategyListResponse(
        strategies=strategy_dtos,
        total_count=total_count,
        page=query.page,
        page_size=query.page_size,
        has_next=has_next,
        total_pages=total_pages  # ì¶”ê°€ ì •ë³´ ì œê³µ
    )
```

#### ğŸ“š êµí›ˆ
- í˜ì´ì§• ë¡œì§ì€ edge caseë¥¼ ê³ ë ¤í•´ì„œ ì„¤ê³„í•´ì•¼ í•¨
- ìˆ˜í•™ì  ê³„ì‚°ì´ í¬í•¨ëœ ë¡œì§ì€ ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ë¡œ í…ŒìŠ¤íŠ¸ í•„ìš”

---

### ë¬¸ì œ 4: ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚° ì‹œ ì •í™•ì„± ë¬¸ì œ

#### ğŸ”´ ë¬¸ì œ ìƒí™©
```python
# ì„±ëŠ¥ ë©”íŠ¸ë¦­ì´ í•­ìƒ 0.0msë¡œ í‘œì‹œë¨
execution_time = time.time() - start_time  # ê²°ê³¼: 0.0000001ì´ˆ ê°™ì€ ë§¤ìš° ì‘ì€ ê°’
```

#### ğŸ” ì›ì¸ ë¶„ì„
Mock Repositoryë¡œ í…ŒìŠ¤íŠ¸í•  ë•Œ ì‹¤í–‰ ì‹œê°„ì´ ë„ˆë¬´ ë¹¨ë¼ì„œ ì¸¡ì •ì´ ì–´ë ¤ì›€:
```python
# Mockì€ ì¦‰ì‹œ ë°˜í™˜ë˜ë¯€ë¡œ ì¸¡ì • ê°€ëŠ¥í•œ ì‹œê°„ ì°¨ì´ê°€ ê±°ì˜ ì—†ìŒ
mock_repo.find_strategies_with_filters.return_value = ([], 0)  # ì¦‰ì‹œ ë°˜í™˜
```

#### âœ… í•´ê²° ë°©ë²•
ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚° ë°©ì‹ ê°œì„ :
```python
def handle(self, query: StrategyListQuery) -> StrategyListResponse:
    start_time = time.perf_counter()  # ë” ì •í™•í•œ ì‹œê°„ ì¸¡ì •

    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
    strategies, total_count = self.strategy_repository.find_strategies_with_filters(...)

    # ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
    execution_time_ms = (time.perf_counter() - start_time) * 1000

    metrics = QueryPerformanceMetrics(
        execution_time=execution_time_ms,
        query_type="StrategyList",
        record_count=len(strategy_dtos),
        timestamp=datetime.now()
    )
```

#### ğŸ“š êµí›ˆ
- ì„±ëŠ¥ ì¸¡ì •ì—ëŠ” `time.perf_counter()` ì‚¬ìš©ì´ ë” ì •í™•
- Mock í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì„±ëŠ¥ë³´ë‹¤ ë¡œì§ ê²€ì¦ì— ì§‘ì¤‘
- ì‹¤ì œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ëŠ” ë³„ë„ì˜ Integration Testì—ì„œ ìˆ˜í–‰

---

### ë¬¸ì œ 5: DTO ë³€í™˜ ì‹œ Null ê°’ ì²˜ë¦¬ ë¬¸ì œ

#### ğŸ”´ ë¬¸ì œ ìƒí™©
```python
# Entityì— None ê°’ì´ ìˆì„ ë•Œ DTO ë³€í™˜ì—ì„œ ì—ëŸ¬ ë°œìƒ
AttributeError: 'NoneType' object has no attribute 'strftime'

# ë°œìƒ ì§€ì 
@dataclass
class StrategyDTO:
    created_at: str  # None ê°’ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ë ¤ê³  í•  ë•Œ ì—ëŸ¬
```

#### ğŸ” ì›ì¸ ë¶„ì„
Domain Entityì˜ Optional í•„ë“œê°€ Noneì¼ ë•Œ DTO ë³€í™˜ì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ ëˆ„ë½:
```python
# ë¬¸ì œê°€ ëœ ì½”ë“œ
@classmethod
def from_entity(cls, entity: Strategy) -> 'StrategyDTO':
    return cls(
        id=entity.id,
        name=entity.name,
        created_at=entity.created_at.strftime('%Y-%m-%d %H:%M:%S'),  # Noneì¼ ë•Œ ì—ëŸ¬
        updated_at=entity.updated_at.strftime('%Y-%m-%d %H:%M:%S')   # Noneì¼ ë•Œ ì—ëŸ¬
    )
```

#### âœ… í•´ê²° ë°©ë²•
ì•ˆì „í•œ DTO ë³€í™˜ ë¡œì§ êµ¬í˜„:
```python
@classmethod
def from_entity(cls, entity: Strategy) -> 'StrategyDTO':
    return cls(
        id=entity.id,
        name=entity.name,
        created_at=entity.created_at.strftime('%Y-%m-%d %H:%M:%S') if entity.created_at else None,
        updated_at=entity.updated_at.strftime('%Y-%m-%d %H:%M:%S') if entity.updated_at else None,
        # Optional í•„ë“œë“¤ì— ëŒ€í•œ ì•ˆì „í•œ ë³€í™˜
        description=entity.description or "",
        tags=entity.tags or [],
        status=entity.status.value if entity.status else "UNKNOWN"
    )
```

#### ğŸ“š êµí›ˆ
- DTO ë³€í™˜ì—ì„œëŠ” ëª¨ë“  Optional í•„ë“œì— ëŒ€í•œ Null ì²´í¬ í•„ìˆ˜
- íƒ€ì… ì•ˆì „ì„±ì„ ìœ„í•´ Optional íƒ€ì… ëª…ì‹œì  ì²˜ë¦¬
- ê¸°ë³¸ê°’ ì œê³µìœ¼ë¡œ UIì—ì„œì˜ ì˜ˆì™¸ ìƒí™© ë°©ì§€

---

## ğŸ› ï¸ ë¬¸ì œ ì˜ˆë°©ì„ ìœ„í•œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê°œë°œ ì‹œ ì²´í¬ì‚¬í•­
- [ ] Containerì—ì„œ ëª¨ë“  Handler ë“±ë¡ í™•ì¸
- [ ] Mock ê°ì²´ì˜ ëª¨ë“  í•„ìš” ë©”ì„œë“œ ì‚¬ì „ ì •ì˜
- [ ] í˜ì´ì§• ë¡œì§ì˜ edge case í…ŒìŠ¤íŠ¸
- [ ] ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê³„ì‚° ë°©ì‹ ê²€ì¦
- [ ] DTO ë³€í™˜ ì‹œ Null ê°’ ì²˜ë¦¬ í™•ì¸

### í…ŒìŠ¤íŠ¸ ì‹œ ì²´í¬ì‚¬í•­
- [ ] Handler ë“±ë¡ ëˆ„ë½ í…ŒìŠ¤íŠ¸
- [ ] Mock Repository ë©”ì„œë“œ í˜¸ì¶œ ê²€ì¦
- [ ] í˜ì´ì§• ê²½ê³„ê°’ í…ŒìŠ¤íŠ¸ (ì²« í˜ì´ì§€, ë§ˆì§€ë§‰ í˜ì´ì§€, ë¹ˆ ê²°ê³¼)
- [ ] ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìœ íš¨ì„± ê²€ì¦
- [ ] Null ê°’ì´ í¬í•¨ëœ Entity DTO ë³€í™˜ í…ŒìŠ¤íŠ¸

### ë””ë²„ê¹… ë„êµ¬
```python
# Handler ë“±ë¡ ìƒíƒœ í™•ì¸
def debug_registered_handlers(dispatcher: QueryDispatcher):
    print("Registered handlers:")
    for query_type, handler in dispatcher._handlers.items():
        print(f"  {query_type.__name__} -> {handler}")

# Mock í˜¸ì¶œ ì´ë ¥ í™•ì¸
def debug_mock_calls(mock_repo):
    print("Mock repository calls:")
    for call in mock_repo.method_calls:
        print(f"  {call}")

# ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìƒì„¸ ì¶œë ¥
def debug_performance_metrics(metrics: QueryPerformanceMetrics):
    print(f"Query: {metrics.query_type}")
    print(f"Execution time: {metrics.execution_time:.4f}ms")
    print(f"Record count: {metrics.record_count}")
```

## ğŸ“Š ë¬¸ì œ í•´ê²° íš¨ê³¼

### ê°œì„ ëœ ì§€í‘œ
- **Handler ë“±ë¡ ì—ëŸ¬**: 100% â†’ 0% (ìë™ ë“±ë¡ ì²´í¬)
- **Mock í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨**: 30% â†’ 0% (ì‚¬ì „ ë©”ì„œë“œ ì •ì˜)
- **í˜ì´ì§• ë²„ê·¸**: ë°œê²¬ ì¦‰ì‹œ ìˆ˜ì • (ê²½ê³„ê°’ í…ŒìŠ¤íŠ¸ ì¶”ê°€)
- **ì„±ëŠ¥ ì¸¡ì • ì •í™•ë„**: ê°œì„  (perf_counter ì‚¬ìš©)
- **DTO ë³€í™˜ ì•ˆì •ì„±**: 100% (Null ì•ˆì „ ì²˜ë¦¬)

### ê°œë°œ ì†ë„ í–¥ìƒ
- ë””ë²„ê¹… ì‹œê°„ ë‹¨ì¶•: í‰ê·  30ë¶„ â†’ 5ë¶„
- í…ŒìŠ¤íŠ¸ ì•ˆì •ì„± í–¥ìƒ: ê°„í—ì  ì‹¤íŒ¨ â†’ ì¼ê´€ëœ ì„±ê³µ
- ì½”ë“œ ì‹ ë¢°ë„ ì¦ê°€: í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ

ì´ëŸ¬í•œ ë¬¸ì œ í•´ê²° ê²½í—˜ì„ í†µí•´ ë” ê²¬ê³ í•˜ê³  ì•ˆì •ì ì¸ CQRS Query Layerë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
