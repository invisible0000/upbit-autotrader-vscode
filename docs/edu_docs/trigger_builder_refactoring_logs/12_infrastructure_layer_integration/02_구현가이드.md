# TASK-12 Infrastructure Layer í†µí•© êµ¬í˜„ ê°€ì´ë“œ

## ğŸ¯ ì´ ê°€ì´ë“œì˜ ëª©ì 
ê¸°ì¡´ ë ˆê±°ì‹œ ì‹œìŠ¤í…œì— Infrastructure Layerë¥¼ ì•ˆì „í•˜ê²Œ í†µí•©í•˜ëŠ” ì‹¤ë¬´ ê°€ì´ë“œì…ë‹ˆë‹¤. DI Container, Configuration Management, Smart Loggingì„ ë‹¨ê³„ë³„ë¡œ ë„ì…í•˜ëŠ” ê²€ì¦ëœ ë°©ë²•ë¡ ì„ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ“‹ ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

### 1. ë°±ì—… ì‹œìŠ¤í…œ êµ¬ì¶•
```bash
# í•µì‹¬ íŒŒì¼ ë°±ì—… (PowerShell)
Copy-Item "run_desktop_ui.py" "run_desktop_ui_old.py"
Copy-Item "upbit_auto_trading/ui/desktop/main_window.py" "main_window_old.py"

# ì‹œìŠ¤í…œ ë°±ì—… (ë‚ ì§œë³„)
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
Copy-Item "upbit_auto_trading/logging/" "backups/logging_system_backup_$timestamp/" -Recurse
```

### 2. Infrastructure Layer ìƒíƒœ í™•ì¸
```python
# í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ ì¡´ì¬ í™•ì¸
from upbit_auto_trading.infrastructure.application_context import ApplicationContext
from upbit_auto_trading.infrastructure.dependency_injection.container import DIContainer
from upbit_auto_trading.infrastructure.services.settings_service import ISettingsService
```

## ğŸ”§ ë‹¨ê³„ë³„ êµ¬í˜„ ê°€ì´ë“œ

### 1ë‹¨ê³„: ApplicationContext í†µí•©

#### run_desktop_ui.py ë¦¬íŒ©í† ë§
```python
# Before: ê¸°ì¡´ ë°©ì‹
def main():
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())

# After: Infrastructure Layer ê¸°ë°˜
def create_application_context():
    """ApplicationContext ì´ˆê¸°í™”"""
    try:
        ApplicationContext.initialize()
        logger = LoggerFactory.get_logger(__name__)
        logger.info("âœ… ApplicationContext ì´ˆê¸°í™” ì™„ë£Œ")
        return ApplicationContext
    except Exception as e:
        print(f"âŒ ApplicationContext ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        raise

def register_ui_services(app_context):
    """UI ì„œë¹„ìŠ¤ DI Container ë“±ë¡"""
    di_container = app_context.get_di_container()

    # ê¸°ì¡´ ë¡œê¹… ì‹œìŠ¤í…œ ì—°ê²°
    di_container.register_singleton('LoggerFactory', LoggerFactory)

    # UI ì„œë¹„ìŠ¤ ë“±ë¡
    di_container.register_singleton('StyleManager', StyleManager)
    di_container.register_transient('NavigationBar', NavigationBar)
    di_container.register_transient('StatusBar', StatusBar)

    return di_container
```

### 2ë‹¨ê³„: MainWindow DI Container ì§€ì›

#### ìƒì„±ì í™•ì¥
```python
class MainWindow(QMainWindow):
    def __init__(self, di_container=None):
        super().__init__()

        # DI Container ì„¤ì • (ì„ íƒì )
        self.di_container = di_container

        # ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        if di_container:
            try:
                logger_factory = di_container.resolve('LoggerFactory')
                self.logger = logger_factory.create_component_logger("MainWindow")
                self.logger.info("MainWindow IL ìŠ¤ë§ˆíŠ¸ ë¡œê¹… ì´ˆê¸°í™” ì™„ë£Œ")
            except Exception as e:
                print(f"ë¡œê¹… ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
                self.logger = None
        else:
            self.logger = None
```

#### ì˜ì¡´ì„± ì£¼ì… íŒ¨í„´
```python
def _initialize_ui_components(self):
    """UI ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” - DI ìš°ì„ , í´ë°± ì§€ì›"""

    # StyleManager DI ì£¼ì…
    if self.di_container:
        try:
            self.style_manager = self.di_container.resolve('StyleManager')
            self._log_info("âœ… StyleManager DI ì£¼ì… ì„±ê³µ")
        except Exception as e:
            self._log_warning(f"StyleManager DI ì‹¤íŒ¨: {e}, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©")
            self.style_manager = StyleManager()  # í´ë°±
    else:
        self.style_manager = StyleManager()

    # NavigationBar DI ì£¼ì…
    if self.di_container:
        try:
            self.navigation_bar = self.di_container.resolve('NavigationBar', self)
            self._log_info("âœ… NavigationBar DI ì£¼ì… ì„±ê³µ")
        except Exception as e:
            self._log_warning(f"NavigationBar DI ì‹¤íŒ¨: {e}")
            self.navigation_bar = self._create_fallback_navigation()
    else:
        self.navigation_bar = self._create_fallback_navigation()
```

### 3ë‹¨ê³„: ì„¤ì • ì‹œìŠ¤í…œ í†µí•©

#### SettingsService ì—°ê²°
```python
def _initialize_settings_service(self):
    """ì„¤ì • ì„œë¹„ìŠ¤ ì´ˆê¸°í™”"""
    if self.di_container:
        try:
            self.settings_service = self.di_container.resolve(ISettingsService)
            self._log_info("âœ… SettingsService DI ì£¼ì… ì„±ê³µ")
        except Exception as e:
            self._log_warning(f"SettingsService DI ì‹¤íŒ¨: {e}, QSettings ì‚¬ìš©")
            self.settings_service = None
    else:
        self.settings_service = None

def _load_window_state(self):
    """ì°½ ìƒíƒœ ë¡œë“œ - Infrastructure Layer ìš°ì„ """
    if self.settings_service:
        # Infrastructure Layer ë°©ì‹
        try:
            window_state = self.settings_service.load_window_state()
            self.resize(window_state.get('width', 1200),
                      window_state.get('height', 800))
            if window_state.get('maximized', False):
                self.showMaximized()
            return
        except Exception as e:
            self._log_warning(f"IL ì°½ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨: {e}, QSettings ì‚¬ìš©")

    # QSettings í´ë°±
    settings = QSettings('UpbitAutoTrader', 'MainWindow')
    self.resize(settings.value('size', QSize(1200, 800)))
    if settings.value('maximized', False, type=bool):
        self.showMaximized()
```

### 4ë‹¨ê³„: í…Œë§ˆ ì‹œìŠ¤í…œ í†µí•©

#### ThemeService êµ¬í˜„
```python
# upbit_auto_trading/infrastructure/services/theme_service.py
class ThemeService(IThemeService):
    def __init__(self, settings_service: ISettingsService, style_manager):
        self.settings_service = settings_service
        self.style_manager = style_manager
        self.theme_changed = pyqtSignal(str)  # í…Œë§ˆ ë³€ê²½ ì‹œê·¸ë„

    def set_theme(self, theme_name: str):
        """í…Œë§ˆ ì„¤ì • ë° ì¦‰ì‹œ ì ìš©"""
        try:
            # 1. StyleManagerë¡œ ì‹¤ì œ í…Œë§ˆ ì ìš©
            self.style_manager.apply_theme(theme_name)

            # 2. ì„¤ì • ì €ì¥
            self.settings_service.save_setting('ui.theme', theme_name)

            # 3. ì´ë²¤íŠ¸ ë°œí–‰
            self.theme_changed.emit(theme_name)
            self._notify_theme_changed(theme_name)

        except Exception as e:
            raise ThemeServiceError(f"í…Œë§ˆ ì„¤ì • ì‹¤íŒ¨: {e}")

    def _notify_theme_changed(self, theme_name: str):
        """ê¸°ì¡´ theme_notifier ì‹œìŠ¤í…œê³¼ ì—°ê²°"""
        from upbit_auto_trading.ui.desktop.components.style.theme_notifier import theme_notifier
        theme_notifier.theme_changed.emit(theme_name)
```

#### UI ì„¤ì • íƒ­ ì—°ê²°
```python
# UI ì„¤ì • íƒ­ì—ì„œ í…Œë§ˆ ë³€ê²½
class UISettings(QWidget):
    def __init__(self, settings_service=None):
        super().__init__()
        self.settings_service = settings_service
        self.setup_ui()

    def _on_theme_changed(self, theme_name):
        """í…Œë§ˆ ì¦‰ì‹œ ë³€ê²½"""
        if self.settings_service and hasattr(self.settings_service, 'theme_service'):
            try:
                self.settings_service.theme_service.set_theme(theme_name)
                self.theme_changed.emit(theme_name)  # ë¶€ëª¨ì—ê²Œ ì•Œë¦¼
            except Exception as e:
                QMessageBox.warning(self, "ì˜¤ë¥˜", f"í…Œë§ˆ ë³€ê²½ ì‹¤íŒ¨: {e}")
```

### 5ë‹¨ê³„: ìŠ¤ë§ˆíŠ¸ ë¡œê¹… v3.1 í†µí•©

#### print() â†’ êµ¬ì¡°í™”ëœ ë¡œê¹… ì „í™˜
```python
def _log_info(self, message):
    """ì •ë³´ ë¡œê·¸ (LLM ë¶„ë¦¬ ì§€ì›)"""
    if self.logger:
        self.logger.info(message)
        # LLM ë¡œê·¸ ë¶„ë¦¬
        if "âœ…" in message or "DI ì£¼ì…" in message:
            self.logger.info(f"ğŸ¤– LLM_REPORT: {message}")
    else:
        print(message)  # í´ë°±

def _log_warning(self, message):
    """ê²½ê³  ë¡œê·¸"""
    if self.logger:
        self.logger.warning(message)
    else:
        print(f"âš ï¸ {message}")

def _log_error(self, message):
    """ì˜¤ë¥˜ ë¡œê·¸"""
    if self.logger:
        self.logger.error(message)
    else:
        print(f"âŒ {message}")
```

## ğŸ”— ì„œë¹„ìŠ¤ ë“±ë¡ íŒ¨í„´

### DI Container ë“±ë¡ ì²´ê³„
```python
def register_ui_services(app_context):
    """UI ì„œë¹„ìŠ¤ ë“±ë¡ - ì˜ì¡´ì„± ìˆœì„œ ì¤‘ìš”"""
    di_container = app_context.get_di_container()
    config_loader = app_context.get_config_loader()

    # 1. ê¸°ë³¸ ì„œë¹„ìŠ¤ (ì˜ì¡´ì„± ì—†ìŒ)
    di_container.register_singleton('LoggerFactory', LoggerFactory)
    di_container.register_singleton('StyleManager', StyleManager)

    # 2. ì„¤ì • ì„œë¹„ìŠ¤ (ConfigLoader ì˜ì¡´)
    settings_service = SettingsService(config_loader)
    di_container.register_singleton(ISettingsService, settings_service)

    # 3. í…Œë§ˆ ì„œë¹„ìŠ¤ (SettingsService, StyleManager ì˜ì¡´)
    style_manager = di_container.resolve('StyleManager')
    theme_service = ThemeService(settings_service, style_manager)
    di_container.register_singleton(IThemeService, theme_service)

    # 4. UI ì»´í¬ë„ŒíŠ¸ (ë§¤ë²ˆ ìƒˆ ì¸ìŠ¤í„´ìŠ¤)
    di_container.register_transient('NavigationBar', NavigationBar)
    di_container.register_transient('StatusBar', StatusBar)
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
# Infrastructure Layer í…ŒìŠ¤íŠ¸
python -m pytest tests/infrastructure/ -v

# ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í…ŒìŠ¤íŠ¸
python test_memory_leak.py

# ì „ì²´ í…ŒìŠ¤íŠ¸
python -m pytest tests/ --tb=short
```

### í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
```python
def test_integration_flow():
    """í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤"""
    # 1. ApplicationContext ì´ˆê¸°í™”
    app_context = create_application_context()
    assert app_context is not None

    # 2. DI Container ì„œë¹„ìŠ¤ ë“±ë¡
    di_container = register_ui_services(app_context)
    assert di_container.can_resolve('StyleManager')

    # 3. MainWindow ìƒì„± ë° DI ì£¼ì…
    app = QApplication([])
    window = MainWindow(di_container)
    assert window.style_manager is not None

    # 4. í…Œë§ˆ ë³€ê²½ í…ŒìŠ¤íŠ¸
    theme_service = di_container.resolve(IThemeService)
    theme_service.set_theme('dark')

    # 5. ì •ë¦¬
    app_context.dispose()
```

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì¼ë°˜ì ì¸ ë¬¸ì œë“¤

#### 1. ì˜ì¡´ì„± ìˆœí™˜ ì°¸ì¡°
```python
# ë¬¸ì œ: A â†’ B â†’ A ìˆœí™˜ ì°¸ì¡°
# í•´ê²°: ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ë‚˜ ì´ë²¤íŠ¸ ê¸°ë°˜ í†µì‹ 

# Before (ìˆœí™˜ ì°¸ì¡°)
class ServiceA:
    def __init__(self, service_b: ServiceB):
        self.service_b = service_b

class ServiceB:
    def __init__(self, service_a: ServiceA):  # ìˆœí™˜!
        self.service_a = service_a

# After (ì´ë²¤íŠ¸ ê¸°ë°˜)
class ServiceA:
    def __init__(self, event_bus: IEventBus):
        self.event_bus = event_bus
        self.event_bus.subscribe('service_b_event', self.handle_event)
```

#### 2. Qt ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸ ë¬¸ì œ
```python
# ë¬¸ì œ: Qt ë©”íƒ€í´ë˜ìŠ¤ ì¶©ëŒ
# í•´ê²°: Mock ê°ì²´ ì‚¬ìš©

class MockThemeService(IThemeService):
    def __init__(self):
        self.current_theme = 'light'

    def set_theme(self, theme_name: str):
        self.current_theme = theme_name
        # Qt ì‹œê·¸ë„ ì—†ì´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
```

#### 3. ì„¤ì • ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬¸ì œ
```python
# ë¬¸ì œ: ê¸°ì¡´ QSettings â†’ Infrastructure Layer ë§ˆì´ê·¸ë ˆì´ì…˜
# í•´ê²°: ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ + í´ë°±

def load_setting_with_migration(key, default_value):
    """ì„¤ì • ë¡œë“œ - ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì›"""
    # 1. Infrastructure Layer ì‹œë„
    if self.settings_service:
        try:
            return self.settings_service.get_setting(key, default_value)
        except Exception:
            pass

    # 2. QSettings í´ë°±
    settings = QSettings('UpbitAutoTrader', 'MainWindow')
    return settings.value(key, default_value)
```

## ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### DI Container ìµœì í™”
```python
# ì‹±ê¸€í†¤ vs ì„ì‹œ ê°ì²´ ì„ íƒ ê¸°ì¤€
di_container.register_singleton('StyleManager', StyleManager)  # ë¬´ê±°ìš´ ê°ì²´
di_container.register_transient('ScreenFactory', ScreenFactory)  # ê°€ë²¼ìš´ íŒ©í† ë¦¬
```

### ì§€ì—° ë¡œë”© íŒ¨í„´
```python
class MainWindow(QMainWindow):
    def __init__(self, di_container=None):
        super().__init__()
        self.di_container = di_container
        self._screens = {}  # í™”ë©´ ìºì‹œ

    def _get_screen(self, screen_name):
        """í™”ë©´ ì§€ì—° ë¡œë”©"""
        if screen_name not in self._screens:
            self._screens[screen_name] = self.di_container.resolve(screen_name)
        return self._screens[screen_name]
```

## ğŸ‰ ì„±ê³µ ì§€í‘œ

### ê¸°ëŠ¥ì  ê²€ì¦
- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹œì‘ (3ì´ˆ ì´ë‚´)
- [ ] DI Container ì„œë¹„ìŠ¤ ì£¼ì… ì„±ê³µ
- [ ] ì„¤ì • ë³€ê²½ ì¦‰ì‹œ UI ë°˜ì˜
- [ ] í…Œë§ˆ ë³€ê²½ í†µí•© ì‹œìŠ¤í…œ ë™ì‘
- [ ] ê¸°ì¡´ ê¸°ëŠ¥ ì†ì‹¤ ì—†ìŒ

### í’ˆì§ˆ ì§€í‘œ
- [ ] Infrastructure Layer í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨ 70% ì´ìƒ
- [ ] ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì—†ìŒ
- [ ] ë¡œê¹… ì‹œìŠ¤í…œ ì •ìƒ ë™ì‘
- [ ] í˜¸í™˜ì„± ìœ ì§€ (ê¸°ì¡´ ì‚¬ìš©ì ì„¤ì • ë³´ì¡´)

ì´ ê°€ì´ë“œë¥¼ í†µí•´ ì•ˆì „í•˜ê³  ì²´ê³„ì ì¸ Infrastructure Layer í†µí•©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
