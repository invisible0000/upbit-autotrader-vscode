# TASK-12 Infrastructure Layer 통합 구현 가이드

## 🎯 이 가이드의 목적
기존 레거시 시스템에 Infrastructure Layer를 안전하게 통합하는 실무 가이드입니다. DI Container, Configuration Management, Smart Logging을 단계별로 도입하는 검증된 방법론을 제공합니다.

## 📋 사전 준비사항

### 1. 백업 시스템 구축
```bash
# 핵심 파일 백업 (PowerShell)
Copy-Item "run_desktop_ui.py" "run_desktop_ui_old.py"
Copy-Item "upbit_auto_trading/ui/desktop/main_window.py" "main_window_old.py"

# 시스템 백업 (날짜별)
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
Copy-Item "upbit_auto_trading/logging/" "backups/logging_system_backup_$timestamp/" -Recurse
```

### 2. Infrastructure Layer 상태 확인
```python
# 필수 컴포넌트 존재 확인
from upbit_auto_trading.infrastructure.application_context import ApplicationContext
from upbit_auto_trading.infrastructure.dependency_injection.container import DIContainer
from upbit_auto_trading.infrastructure.services.settings_service import ISettingsService
```

## 🔧 단계별 구현 가이드

### 1단계: ApplicationContext 통합

#### run_desktop_ui.py 리팩토링
```python
# Before: 기존 방식
def main():
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())

# After: Infrastructure Layer 기반
def create_application_context():
    """ApplicationContext 초기화"""
    try:
        ApplicationContext.initialize()
        logger = LoggerFactory.get_logger(__name__)
        logger.info("✅ ApplicationContext 초기화 완료")
        return ApplicationContext
    except Exception as e:
        print(f"❌ ApplicationContext 초기화 실패: {e}")
        raise

def register_ui_services(app_context):
    """UI 서비스 DI Container 등록"""
    di_container = app_context.get_di_container()

    # 기존 로깅 시스템 연결
    di_container.register_singleton('LoggerFactory', LoggerFactory)

    # UI 서비스 등록
    di_container.register_singleton('StyleManager', StyleManager)
    di_container.register_transient('NavigationBar', NavigationBar)
    di_container.register_transient('StatusBar', StatusBar)

    return di_container
```

### 2단계: MainWindow DI Container 지원

#### 생성자 확장
```python
class MainWindow(QMainWindow):
    def __init__(self, di_container=None):
        super().__init__()

        # DI Container 설정 (선택적)
        self.di_container = di_container

        # 로깅 시스템 초기화
        if di_container:
            try:
                logger_factory = di_container.resolve('LoggerFactory')
                self.logger = logger_factory.create_component_logger("MainWindow")
                self.logger.info("MainWindow IL 스마트 로깅 초기화 완료")
            except Exception as e:
                print(f"로깅 초기화 실패: {e}")
                self.logger = None
        else:
            self.logger = None
```

#### 의존성 주입 패턴
```python
def _initialize_ui_components(self):
    """UI 컴포넌트 초기화 - DI 우선, 폴백 지원"""

    # StyleManager DI 주입
    if self.di_container:
        try:
            self.style_manager = self.di_container.resolve('StyleManager')
            self._log_info("✅ StyleManager DI 주입 성공")
        except Exception as e:
            self._log_warning(f"StyleManager DI 실패: {e}, 기존 방식 사용")
            self.style_manager = StyleManager()  # 폴백
    else:
        self.style_manager = StyleManager()

    # NavigationBar DI 주입
    if self.di_container:
        try:
            self.navigation_bar = self.di_container.resolve('NavigationBar', self)
            self._log_info("✅ NavigationBar DI 주입 성공")
        except Exception as e:
            self._log_warning(f"NavigationBar DI 실패: {e}")
            self.navigation_bar = self._create_fallback_navigation()
    else:
        self.navigation_bar = self._create_fallback_navigation()
```

### 3단계: 설정 시스템 통합

#### SettingsService 연결
```python
def _initialize_settings_service(self):
    """설정 서비스 초기화"""
    if self.di_container:
        try:
            self.settings_service = self.di_container.resolve(ISettingsService)
            self._log_info("✅ SettingsService DI 주입 성공")
        except Exception as e:
            self._log_warning(f"SettingsService DI 실패: {e}, QSettings 사용")
            self.settings_service = None
    else:
        self.settings_service = None

def _load_window_state(self):
    """창 상태 로드 - Infrastructure Layer 우선"""
    if self.settings_service:
        # Infrastructure Layer 방식
        try:
            window_state = self.settings_service.load_window_state()
            self.resize(window_state.get('width', 1200),
                      window_state.get('height', 800))
            if window_state.get('maximized', False):
                self.showMaximized()
            return
        except Exception as e:
            self._log_warning(f"IL 창 상태 로드 실패: {e}, QSettings 사용")

    # QSettings 폴백
    settings = QSettings('UpbitAutoTrader', 'MainWindow')
    self.resize(settings.value('size', QSize(1200, 800)))
    if settings.value('maximized', False, type=bool):
        self.showMaximized()
```

### 4단계: 테마 시스템 통합

#### ThemeService 구현
```python
# upbit_auto_trading/infrastructure/services/theme_service.py
class ThemeService(IThemeService):
    def __init__(self, settings_service: ISettingsService, style_manager):
        self.settings_service = settings_service
        self.style_manager = style_manager
        self.theme_changed = pyqtSignal(str)  # 테마 변경 시그널

    def set_theme(self, theme_name: str):
        """테마 설정 및 즉시 적용"""
        try:
            # 1. StyleManager로 실제 테마 적용
            self.style_manager.apply_theme(theme_name)

            # 2. 설정 저장
            self.settings_service.save_setting('ui.theme', theme_name)

            # 3. 이벤트 발행
            self.theme_changed.emit(theme_name)
            self._notify_theme_changed(theme_name)

        except Exception as e:
            raise ThemeServiceError(f"테마 설정 실패: {e}")

    def _notify_theme_changed(self, theme_name: str):
        """기존 theme_notifier 시스템과 연결"""
        from upbit_auto_trading.ui.desktop.components.style.theme_notifier import theme_notifier
        theme_notifier.theme_changed.emit(theme_name)
```

#### UI 설정 탭 연결
```python
# UI 설정 탭에서 테마 변경
class UISettings(QWidget):
    def __init__(self, settings_service=None):
        super().__init__()
        self.settings_service = settings_service
        self.setup_ui()

    def _on_theme_changed(self, theme_name):
        """테마 즉시 변경"""
        if self.settings_service and hasattr(self.settings_service, 'theme_service'):
            try:
                self.settings_service.theme_service.set_theme(theme_name)
                self.theme_changed.emit(theme_name)  # 부모에게 알림
            except Exception as e:
                QMessageBox.warning(self, "오류", f"테마 변경 실패: {e}")
```

### 5단계: 스마트 로깅 v3.1 통합

#### print() → 구조화된 로깅 전환
```python
def _log_info(self, message):
    """정보 로그 (LLM 분리 지원)"""
    if self.logger:
        self.logger.info(message)
        # LLM 로그 분리
        if "✅" in message or "DI 주입" in message:
            self.logger.info(f"🤖 LLM_REPORT: {message}")
    else:
        print(message)  # 폴백

def _log_warning(self, message):
    """경고 로그"""
    if self.logger:
        self.logger.warning(message)
    else:
        print(f"⚠️ {message}")

def _log_error(self, message):
    """오류 로그"""
    if self.logger:
        self.logger.error(message)
    else:
        print(f"❌ {message}")
```

## 🔗 서비스 등록 패턴

### DI Container 등록 체계
```python
def register_ui_services(app_context):
    """UI 서비스 등록 - 의존성 순서 중요"""
    di_container = app_context.get_di_container()
    config_loader = app_context.get_config_loader()

    # 1. 기본 서비스 (의존성 없음)
    di_container.register_singleton('LoggerFactory', LoggerFactory)
    di_container.register_singleton('StyleManager', StyleManager)

    # 2. 설정 서비스 (ConfigLoader 의존)
    settings_service = SettingsService(config_loader)
    di_container.register_singleton(ISettingsService, settings_service)

    # 3. 테마 서비스 (SettingsService, StyleManager 의존)
    style_manager = di_container.resolve('StyleManager')
    theme_service = ThemeService(settings_service, style_manager)
    di_container.register_singleton(IThemeService, theme_service)

    # 4. UI 컴포넌트 (매번 새 인스턴스)
    di_container.register_transient('NavigationBar', NavigationBar)
    di_container.register_transient('StatusBar', StatusBar)
```

## 🧪 테스트 및 검증

### 단위 테스트 실행
```bash
# Infrastructure Layer 테스트
python -m pytest tests/infrastructure/ -v

# 메모리 누수 테스트
python test_memory_leak.py

# 전체 테스트
python -m pytest tests/ --tb=short
```

### 통합 테스트 시나리오
```python
def test_integration_flow():
    """통합 테스트 시나리오"""
    # 1. ApplicationContext 초기화
    app_context = create_application_context()
    assert app_context is not None

    # 2. DI Container 서비스 등록
    di_container = register_ui_services(app_context)
    assert di_container.can_resolve('StyleManager')

    # 3. MainWindow 생성 및 DI 주입
    app = QApplication([])
    window = MainWindow(di_container)
    assert window.style_manager is not None

    # 4. 테마 변경 테스트
    theme_service = di_container.resolve(IThemeService)
    theme_service.set_theme('dark')

    # 5. 정리
    app_context.dispose()
```

## ⚠️ 주의사항 및 트러블슈팅

### 일반적인 문제들

#### 1. 의존성 순환 참조
```python
# 문제: A → B → A 순환 참조
# 해결: 인터페이스 분리나 이벤트 기반 통신

# Before (순환 참조)
class ServiceA:
    def __init__(self, service_b: ServiceB):
        self.service_b = service_b

class ServiceB:
    def __init__(self, service_a: ServiceA):  # 순환!
        self.service_a = service_a

# After (이벤트 기반)
class ServiceA:
    def __init__(self, event_bus: IEventBus):
        self.event_bus = event_bus
        self.event_bus.subscribe('service_b_event', self.handle_event)
```

#### 2. Qt 컴포넌트 테스트 문제
```python
# 문제: Qt 메타클래스 충돌
# 해결: Mock 객체 사용

class MockThemeService(IThemeService):
    def __init__(self):
        self.current_theme = 'light'

    def set_theme(self, theme_name: str):
        self.current_theme = theme_name
        # Qt 시그널 없이 테스트 가능
```

#### 3. 설정 마이그레이션 문제
```python
# 문제: 기존 QSettings → Infrastructure Layer 마이그레이션
# 해결: 점진적 마이그레이션 + 폴백

def load_setting_with_migration(key, default_value):
    """설정 로드 - 마이그레이션 지원"""
    # 1. Infrastructure Layer 시도
    if self.settings_service:
        try:
            return self.settings_service.get_setting(key, default_value)
        except Exception:
            pass

    # 2. QSettings 폴백
    settings = QSettings('UpbitAutoTrader', 'MainWindow')
    return settings.value(key, default_value)
```

## 📊 성능 고려사항

### DI Container 최적화
```python
# 싱글톤 vs 임시 객체 선택 기준
di_container.register_singleton('StyleManager', StyleManager)  # 무거운 객체
di_container.register_transient('ScreenFactory', ScreenFactory)  # 가벼운 팩토리
```

### 지연 로딩 패턴
```python
class MainWindow(QMainWindow):
    def __init__(self, di_container=None):
        super().__init__()
        self.di_container = di_container
        self._screens = {}  # 화면 캐시

    def _get_screen(self, screen_name):
        """화면 지연 로딩"""
        if screen_name not in self._screens:
            self._screens[screen_name] = self.di_container.resolve(screen_name)
        return self._screens[screen_name]
```

## 🎉 성공 지표

### 기능적 검증
- [ ] 애플리케이션 정상 시작 (3초 이내)
- [ ] DI Container 서비스 주입 성공
- [ ] 설정 변경 즉시 UI 반영
- [ ] 테마 변경 통합 시스템 동작
- [ ] 기존 기능 손실 없음

### 품질 지표
- [ ] Infrastructure Layer 테스트 통과율 70% 이상
- [ ] 메모리 누수 없음
- [ ] 로깅 시스템 정상 동작
- [ ] 호환성 유지 (기존 사용자 설정 보존)

이 가이드를 통해 안전하고 체계적인 Infrastructure Layer 통합을 수행할 수 있습니다.
