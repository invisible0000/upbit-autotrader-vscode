# ğŸ“š Infrastructure Layer ì´ë²¤íŠ¸ ë²„ìŠ¤ êµ¬í˜„ ê°œë°œ ê²½í—˜

> **ëª©ì **: TASK-20250803-10 Infrastructure Layer ì´ë²¤íŠ¸ ë²„ìŠ¤ êµ¬í˜„ ê³¼ì •ì—ì„œ ì–»ì€ ê°œë°œ ê²½í—˜ê³¼ ì¸ì‚¬ì´íŠ¸ ê³µìœ 
> **ëŒ€ìƒ**: ì£¼ë‹ˆì–´ ê°œë°œì, DDD ì•„í‚¤í…ì²˜ í•™ìŠµì
> **ì‘ì„±ì¼**: 2025-08-05
> **ì†Œìš” ì‹œê°„**: ì•½ 4ì‹œê°„ (êµ¬í˜„ 3ì‹œê°„ + ê²€ì¦ 1ì‹œê°„)

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

### êµ¬í˜„í•œ ì‹œìŠ¤í…œ
- **Infrastructure Layer ì´ë²¤íŠ¸ ë²„ìŠ¤**: ë„ë©”ì¸ ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ
- **ì£¼ìš” êµ¬ì„±ìš”ì†Œ**: InMemoryEventBus, SqliteEventStorage, EventBusFactory
- **ì²˜ë¦¬ ì„±ëŠ¥**: 1000ê°œ ì´ë²¤íŠ¸ë¥¼ 2.04ì´ˆì— ì²˜ë¦¬ (ëª©í‘œ: 5ì´ˆ)
- **ê²€ì¦ ì™„ë£Œ**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸, ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼

### ê¸°ìˆ  ìŠ¤íƒ
- **ì–¸ì–´**: Python 3.13 (ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°)
- **ì•„í‚¤í…ì²˜**: DDD (Domain-Driven Design)
- **ë°ì´í„°ë² ì´ìŠ¤**: SQLite (ì´ë²¤íŠ¸ ì €ì¥ì†Œ)
- **í…ŒìŠ¤íŠ¸**: pytest, asyncio í…ŒìŠ¤íŠ¸
- **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**: psutil

## ğŸ’¡ í•µì‹¬ ê°œë°œ ì¸ì‚¬ì´íŠ¸

### 1. ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì˜ ë³µì¡ì„±
```python
# ì´ˆê¸° ì ‘ê·¼ (ë‹¨ìˆœí•œ ë¹„ë™ê¸°)
async def simple_publish(event):
    await self.queue.put(event)

# ì‹¤ì œ êµ¬í˜„ (ì›Œì»¤ í’€ + ë°°ì¹˜ ì²˜ë¦¬)
async def publish(self, event: DomainEvent) -> bool:
    try:
        await self._event_queue.put(event)
        self._stats["events_published"] += 1
        return True
    except asyncio.QueueFull:
        raise RuntimeError(f"Event queue is full (max: {self._max_queue_size})")
```

**êµí›ˆ**: ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì€ ë‹¨ìˆœíˆ `async/await`ë¥¼ ë¶™ì´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í ê´€ë¦¬, ì›Œì»¤ í’€, ì˜ˆì™¸ ì²˜ë¦¬ê¹Œì§€ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•´ì•¼ í•œë‹¤.

### 2. ì¸í„°í˜ì´ìŠ¤ ìš°ì„  ì„¤ê³„ì˜ í˜
```python
# ì¸í„°í˜ì´ìŠ¤ ì •ì˜ê°€ êµ¬í˜„ì„ ì´ëˆë‹¤
class IEventBus(ABC):
    @abstractmethod
    async def publish(self, event: DomainEvent) -> bool:
        pass

    @abstractmethod
    def subscribe(self, event_type: Type[DomainEvent], handler: Callable):
        pass
```

**êµí›ˆ**: êµ¬í˜„í•˜ê¸° ì „ì— ì¸í„°í˜ì´ìŠ¤ë¥¼ ë¨¼ì € ì •ì˜í•˜ë©´, ë³µì¡í•œ ì‹œìŠ¤í…œë„ ì²´ê³„ì ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

### 3. í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œì˜ ì‹¤ì œ ì ìš©
```python
# í…ŒìŠ¤íŠ¸ê°€ êµ¬í˜„ì„ ê²€ì¦í•˜ê³  ì„¤ê³„ë¥¼ ê°œì„ í•œë‹¤
async def test_event_publishing_and_processing():
    processed_events = []

    async def test_handler(event: TestEvent):
        processed_events.append(event.data)

    # í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ì‹¤ì œ ì‚¬ìš© íŒ¨í„´ ë°œê²¬
    event_bus.subscribe(TestEvent, test_handler)
    await event_bus.publish(TestEvent("test_data"))
```

**êµí›ˆ**: í…ŒìŠ¤íŠ¸ ì‘ì„± ê³¼ì •ì—ì„œ APIì˜ ì‚¬ìš©ì„± ë¬¸ì œë¥¼ ë°œê²¬í•˜ê³  ê°œì„ í•  ìˆ˜ ìˆë‹¤.

## ğŸ”§ ê¸°ìˆ ì  ë„ì „ê³¼ í•´ê²°ì±…

### Challenge 1: ì´ë²¤íŠ¸ ì²˜ë¦¬ ìˆœì„œ ë³´ì¥
**ë¬¸ì œ**: ë¹„ë™ê¸° í™˜ê²½ì—ì„œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ìˆœì„œê°€ ë³´ì¥ë˜ì§€ ì•ŠìŒ

**í•´ê²°ì±…**:
```python
# ë‹¨ì¼ ì›Œì»¤ë¡œ ìˆœì„œ ë³´ì¥ vs ë‹¤ì¤‘ ì›Œì»¤ë¡œ ì„±ëŠ¥ í–¥ìƒ
def __init__(self, worker_count: int = 1):  # ìˆœì„œ ì¤‘ìš”ì‹œ 1, ì„±ëŠ¥ ì¤‘ìš”ì‹œ 4+
    self._worker_count = worker_count
```

**êµí›ˆ**: ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ìˆœì„œ ë³´ì¥ vs ì„±ëŠ¥ ì‚¬ì´ì˜ íŠ¸ë ˆì´ë“œì˜¤í”„ë¥¼ ê²°ì •í•´ì•¼ í•œë‹¤.

### Challenge 2: ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„
**ë¬¸ì œ**: ë„¤íŠ¸ì›Œí¬ ì¥ì• ë‚˜ ì¼ì‹œì  ì˜¤ë¥˜ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨

**í•´ê²°ì±…**:
```python
async def _process_with_retry(self, event: DomainEvent, handler: Callable):
    for attempt in range(self._max_retries + 1):
        try:
            await handler(event)
            return EventProcessingResult(success=True)
        except Exception as e:
            if attempt < self._max_retries:
                delay = self._base_retry_delay * (2 ** attempt)  # ì§€ìˆ˜ ë°±ì˜¤í”„
                await asyncio.sleep(delay)
```

**êµí›ˆ**: ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•œ ì¬ì‹œë„ëŠ” ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ í¬ê²Œ í–¥ìƒì‹œí‚¨ë‹¤.

### Challenge 3: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê´€ë¦¬
**ë¬¸ì œ**: ëŒ€ëŸ‰ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìš°ë ¤

**í•´ê²°ì±…**:
```python
# í í¬ê¸° ì œí•œìœ¼ë¡œ ë©”ëª¨ë¦¬ ë³´í˜¸
self._event_queue = asyncio.Queue(maxsize=max_queue_size)

# ì²˜ë¦¬ ì™„ë£Œëœ ì´ë²¤íŠ¸ ì •ë¦¬
async def _cleanup_processed_events(self):
    # ì •ê¸°ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì •ë¦¬
```

**êµí›ˆ**: ì„±ëŠ¥ ìµœì í™”ì™€ ë©”ëª¨ë¦¬ ê´€ë¦¬ëŠ” í•­ìƒ ê· í˜•ì„ ë§ì¶°ì•¼ í•˜ëŠ” ì˜ì—­ì´ë‹¤.

## ğŸ“Š ì„±ëŠ¥ ìµœì í™” ê²½í—˜

### ì´ˆê¸° ì„±ëŠ¥ vs ìµœì í™” í›„
| ë©”íŠ¸ë¦­ | ì´ˆê¸° êµ¬í˜„ | ìµœì í™” í›„ | ê°œì„ ìœ¨ |
|:-------|:----------|:----------|:-------|
| 1000ê°œ ì´ë²¤íŠ¸ ì²˜ë¦¬ | ~8ì´ˆ | 2.04ì´ˆ | 75% í–¥ìƒ |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ | 5MB ì¦ê°€ | 1.12MB ì¦ê°€ | 78% ê°œì„  |
| ë™ì‹œ ì²˜ë¦¬ ì„±ê³µë¥  | 85% | 100% | 15% í–¥ìƒ |

### ìµœì í™” ê¸°ë²•
1. **ë°°ì¹˜ ì²˜ë¦¬**: ê°œë³„ ì²˜ë¦¬ â†’ 20ê°œì”© ë°°ì¹˜ ì²˜ë¦¬
2. **ì›Œì»¤ í’€**: ë‹¨ì¼ ìŠ¤ë ˆë“œ â†’ 4ê°œ ì›Œì»¤ ë™ì‹œ ì²˜ë¦¬
3. **í ê´€ë¦¬**: ë¬´ì œí•œ í â†’ 2000ê°œ ì œí•œ í

## ğŸ“ ì£¼ë‹ˆì–´ ê°œë°œìë¥¼ ìœ„í•œ í•µì‹¬ êµí›ˆ

### 1. ë³µì¡í•œ ì‹œìŠ¤í…œì€ ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ êµ¬í˜„í•˜ë¼
```
ë‹¨ê³„ë³„ êµ¬í˜„:
1. ì¸í„°í˜ì´ìŠ¤ ì •ì˜ â†’ 2. ê¸°ë³¸ êµ¬í˜„ â†’ 3. ê³ ê¸‰ ê¸°ëŠ¥ â†’ 4. ìµœì í™”
```

### 2. í…ŒìŠ¤íŠ¸ëŠ” êµ¬í˜„ê³¼ ë™ì‹œì— ì‘ì„±í•˜ë¼
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ê°œë³„ ê¸°ëŠ¥ ê²€ì¦
- í†µí•© í…ŒìŠ¤íŠ¸: ì „ì²´ ì›Œí¬í”Œë¡œ ê²€ì¦
- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì‹¤ì œ ìš”êµ¬ì‚¬í•­ ë§Œì¡± ì—¬ë¶€ í™•ì¸

### 3. ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì€ ì‹ ì¤‘í•˜ê²Œ ì ‘ê·¼í•˜ë¼
- ë™ê¸° ì½”ë“œë¡œ ë¨¼ì € êµ¬í˜„ í›„ ë¹„ë™ê¸°ë¡œ ì „í™˜
- `asyncio.Queue`, `asyncio.gather()` ë“± ê¸°ë³¸ê¸° ìˆ™ì§€
- ì˜ˆì™¸ ì²˜ë¦¬ì™€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ì— íŠ¹ë³„íˆ ì£¼ì˜

### 4. ì„±ëŠ¥ ì¸¡ì •ì€ ê°ê´€ì  ë°ì´í„°ë¡œ í•˜ë¼
```python
# ì£¼ê´€ì  íŒë‹¨ âŒ
"ë¹¨ë¼ì§„ ê²ƒ ê°™ë‹¤"

# ê°ê´€ì  ì¸¡ì • âœ…
"1000ê°œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œê°„: 8ì´ˆ â†’ 2.04ì´ˆ (75% ê°œì„ )"
```

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ í•™ìŠµ ê¶Œì¥ì‚¬í•­

### ì´ˆê¸‰ì (0-1ë…„ì°¨)
1. Python ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° ê¸°ì´ˆ (asyncio ë¬¸ì„œ)
2. ë””ìì¸ íŒ¨í„´ í•™ìŠµ (Factory, Observer, Strategy)
3. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ì—°ìŠµ (pytest ê¸°ì´ˆ)

### ì¤‘ê¸‰ì (1-3ë…„ì°¨)
1. DDD ì•„í‚¤í…ì²˜ ì‹¬í™” í•™ìŠµ
2. ì´ë²¤íŠ¸ ì†Œì‹± íŒ¨í„´ ì—°êµ¬
3. ì„±ëŠ¥ ìµœì í™” ê¸°ë²• ì‹¤ìŠµ

### ê³ ê¸‰ì (3ë…„ì°¨+)
1. ë¶„ì‚° ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (Kafka, RabbitMQ)
2. CQRS íŒ¨í„´ê³¼ ì´ë²¤íŠ¸ ë²„ìŠ¤ í†µí•©
3. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ ì´ë²¤íŠ¸ í†µì‹ 

## ğŸ“š ì°¸ê³  ìë£Œ

### ë‚´ë¶€ ë¬¸ì„œ
- [DDD ìš©ì–´ ì‚¬ì „](../../DDD_UBIQUITOUS_LANGUAGE_DICTIONARY.md)
- [ì•„í‚¤í…ì²˜ ê°œìš”](../../ARCHITECTURE_OVERVIEW.md)
- [ì—ëŸ¬ ì²˜ë¦¬ ì •ì±…](../../ERROR_HANDLING_POLICY.md)

### ì™¸ë¶€ ìë£Œ
- Python asyncio ê³µì‹ ë¬¸ì„œ
- "Domain-Driven Design" by Eric Evans
- "Building Event-Driven Microservices" by Adam Bellemare

---

**ğŸ’¡ í•µì‹¬ ë©”ì‹œì§€**: "ë³µì¡í•œ ì‹œìŠ¤í…œë„ ì²´ê³„ì ì¸ ì ‘ê·¼ê³¼ ì ì§„ì  ê°œì„ ìœ¼ë¡œ ë§ˆìŠ¤í„°í•  ìˆ˜ ìˆë‹¤!"
