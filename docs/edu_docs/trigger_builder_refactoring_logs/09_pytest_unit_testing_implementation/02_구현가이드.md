# π› οΈ pytest λ‹¨μ„ν…μ¤νΈ μ‹μ¤ν… κµ¬ν„ κ°€μ΄λ“

> **λ€μƒ**: μ£Όλ‹μ–΄ κ°λ°μ
> **λ©μ **: Infrastructure Layer pytest ν…μ¤νΈ μ‹μ¤ν… κµ¬ν„ λ°©λ²•λ΅ 
> **λ‚μ΄λ„**: μ¤‘κΈ‰
> **μ†μ”μ‹κ°„**: 2-3μ‹κ°„

## π“‹ μ‚¬μ „ μ¤€λΉ„μ‚¬ν•­

### ν•„μ λΌμ΄λΈλ¬λ¦¬
```bash
# κΈ°λ³Έ ν…μ¤νΈ λ„κµ¬
pip install pytest pytest-asyncio pytest-cov

# Mock λ° ν¨μΉ λ„κµ¬
pip install pytest-mock

# API ν‚¤ μ•”νΈν™” (μ„ νƒμ‚¬ν•­)
pip install cryptography
```

### ν”„λ΅μ νΈ κµ¬μ΅°
```
tests/
β”β”€β”€ utils/
β”‚   β””β”€β”€ api_key_loader.py      # API ν‚¤ λ΅λ”© μ ν‹Έλ¦¬ν‹°
β”β”€β”€ infrastructure/
β”‚   β””β”€β”€ external_apis/
β”‚       β””β”€β”€ test_upbit_clients.py  # λ©”μΈ ν…μ¤νΈ νμΌ
β””β”€β”€ conftest.py                # pytest μ„¤μ •
```

## π― 1λ‹¨κ³„: API ν‚¤ λ΅λ”© μ‹μ¤ν… κµ¬μ¶•

### API ν‚¤ λ΅λ” μ ν‹Έλ¦¬ν‹° μ‘μ„±
```python
# tests/utils/api_key_loader.py
import os
from pathlib import Path
from typing import Tuple, Optional

def get_test_api_keys() -> Tuple[Optional[str], Optional[str]]:
    """ν…μ¤νΈμ© API ν‚¤ λ΅λ“ (μ΄μ¤‘ μ†μ¤ μ§€μ›)"""

    # 1μμ„: .env νμΌ (κ°λ° νΈμμ„±)
    try:
        access_key, secret_key = load_from_env()
        if access_key and secret_key:
            print("β… .env νμΌμ—μ„ API ν‚¤ λ΅λ“ μ„±κ³µ")
            return access_key, secret_key
    except Exception as e:
        print(f"β οΈ .env λ΅λ“ μ‹¤ν¨: {e}")

    # 2μμ„: μ•”νΈν™” νμΌ (ν”„λ΅λ•μ… λ³΄μ•)
    try:
        access_key, secret_key = load_from_encrypted()
        if access_key and secret_key:
            print("β… μ•”νΈν™” νμΌμ—μ„ API ν‚¤ λ΅λ“ μ„±κ³µ")
            return access_key, secret_key
    except Exception as e:
        print(f"β οΈ μ•”νΈν™” νμΌ λ΅λ“ μ‹¤ν¨: {e}")

    print("β API ν‚¤λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤")
    return None, None

def load_from_env() -> Tuple[Optional[str], Optional[str]]:
    """ν™κ²½λ³€μ/.env νμΌμ—μ„ λ΅λ“"""
    from dotenv import load_dotenv
    load_dotenv()

    return (
        os.getenv('UPBIT_ACCESS_KEY'),
        os.getenv('UPBIT_SECRET_KEY')
    )

def load_from_encrypted() -> Tuple[Optional[str], Optional[str]]:
    """μ•”νΈν™”λ νμΌμ—μ„ λ΅λ“"""
    try:
        from cryptography.fernet import Fernet

        # μ•”νΈν™” ν‚¤μ™€ νμΌ κ²½λ΅ μ„¤μ •
        key_file = Path("config/secure/encryption.key")
        data_file = Path("config/secure/api_keys.enc")

        if not key_file.exists() or not data_file.exists():
            return None, None

        # λ³µνΈν™” κ³Όμ •
        with open(key_file, 'rb') as kf:
            key = kf.read()

        fernet = Fernet(key)

        with open(data_file, 'rb') as df:
            encrypted_data = df.read()

        decrypted_data = fernet.decrypt(encrypted_data)
        lines = decrypted_data.decode().strip().split('\n')

        access_key = lines[0].split('=')[1] if len(lines) > 0 else None
        secret_key = lines[1].split('=')[1] if len(lines) > 1 else None

        return access_key, secret_key

    except Exception:
        return None, None
```

### ν•µμ‹¬ μ„¤κ³„ μ›μΉ™
1. **μ¥μ•  ν—μ©**: ν• λ°©μ‹μ΄ μ‹¤ν¨ν•΄λ„ λ‹¤λ¥Έ λ°©μ‹ μ‹λ„
2. **λ…ν™•ν• ν”Όλ“λ°±**: κ° λ‹¨κ³„μ μ„±κ³µ/μ‹¤ν¨ μƒνƒ μ¶λ ¥
3. **λ³΄μ• μ°μ„ **: λ―Όκ° μ •λ³΄ λ΅κΉ…ν•μ§€ μ•μ

## π― 2λ‹¨κ³„: pytest κµ¬μ„± νμΌ μ„¤μ •

### pyproject.toml μ„¤μ •
```toml
[tool.pytest.ini_options]
minversion = "6.0"
addopts = "-ra -q --strict-markers"
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
asyncio_mode = "auto"

# ν…μ¤νΈ λ§μ»¤ μ •μ
markers = [
    "unit: λΉ λ¥Έ λ‹¨μ„ ν…μ¤νΈ",
    "integration: λλ¦° ν†µν•© ν…μ¤νΈ",
    "real_api: μ‹¤μ  API νΈμ¶ ν…μ¤νΈ",
    "slow: μ‹κ°„μ΄ μ¤λ κ±Έλ¦¬λ” ν…μ¤νΈ"
]
```

### ν•µμ‹¬ μ„¤μ • ν¬μΈνΈ
- `asyncio_mode = "auto"`: λΉ„λ™κΈ° ν…μ¤νΈ μλ™ μ²λ¦¬
- `markers`: ν…μ¤νΈ λ¶„λ¥λ΅ μ„ νƒμ  μ‹¤ν–‰ κ°€λ¥
- `python_*`: pytest λ°κ²¬ κ·μΉ™ λ…μ‹

## π― 3λ‹¨κ³„: Mock λ‹¨μ„ ν…μ¤νΈ κµ¬ν„

### κΈ°λ³Έ ν…μ¤νΈ ν΄λμ¤ κµ¬μ΅°
```python
import pytest
from unittest.mock import Mock, patch, AsyncMock
from datetime import datetime

class TestUpbitPublicClient:
    """κ³µκ° API ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ"""

    @pytest.fixture
    async def client(self):
        """ν…μ¤νΈμ© ν΄λΌμ΄μ–ΈνΈ ν”½μ¤μ²"""
        client = UpbitPublicClient()
        yield client
        await client.close()  # λ¦¬μ†μ¤ μ •λ¦¬

    @pytest.mark.asyncio
    async def test_get_markets_success(self, client):
        """λ§μΌ“ μ΅°ν μ„±κ³µ μΌ€μ΄μ¤"""
        # 1. Mock λ°μ΄ν„° μ¤€λΉ„
        mock_response_data = [
            {"market": "KRW-BTC", "korean_name": "λΉ„νΈμ½”μΈ"},
            {"market": "KRW-ETH", "korean_name": "μ΄λ”λ¦¬μ›€"}
        ]

        # 2. API μ‘λ‹µ Mock μ„¤μ •
        with patch.object(client, '_make_request', new_callable=AsyncMock) as mock_request:
            # μ‹¤μ  ApiResponse κµ¬μ΅°μ— λ§μ¶ Mock
            from upbit_auto_trading.infrastructure.external_apis.common.api_client_base import ApiResponse

            mock_response = ApiResponse(
                success=True,
                data=mock_response_data,
                status_code=200,
                headers={},
                request_time=datetime.now(),
                response_time_ms=100.0  # μ •ν™•ν• νλΌλ―Έν„°λ…!
            )
            mock_request.return_value = mock_response

            # 3. μ‹¤μ  λ©”μ„λ“ νΈμ¶
            result = await client.get_markets()

            # 4. κ²°κ³Ό κ²€μ¦
            assert len(result) == 2
            assert result[0]["market"] == "KRW-BTC"

            # 5. νΈμ¶ κ²€μ¦ (μ‹¤μ  κµ¬ν„κ³Ό μΌμΉν•λ” νλΌλ―Έν„°)
            mock_request.assert_called_once_with(
                "GET", "/market/all",
                params={"isDetails": "false"}  # κΈ°λ³Έκ°’ ν™•μΈ ν•„μ”!
            )
```

### Mock κµ¬ν„ μ‹ μ£Όμμ‚¬ν•­
1. **μ •ν™•ν• νλΌλ―Έν„°λ…**: `response_time_ms` (not `response_time`)
2. **μ‹¤μ  κΈ°λ³Έκ°’**: μ†μ¤μ½”λ“μ—μ„ ν™•μΈν• μ •ν™•ν• κΈ°λ³Έκ°’ μ‚¬μ©
3. **λ¦¬μ†μ¤ μ •λ¦¬**: `yield` ν¨ν„΄μΌλ΅ ν…μ¤νΈ ν›„ μ •λ¦¬
4. **AsyncMock**: λΉ„λ™κΈ° λ©”μ„λ“μ—λ” λ°λ“μ‹ `AsyncMock` μ‚¬μ©

## π― 4λ‹¨κ³„: μ‹¤μ  API ν†µν•© ν…μ¤νΈ

### μ‹¤μ  API ν…μ¤νΈ ν΄λμ¤
```python
@pytest.mark.real_api
class TestRealApiIntegration:
    """μ‹¤μ  API ν‚¤λ¥Ό μ‚¬μ©ν• ν†µν•© ν…μ¤νΈ"""

    @pytest.fixture(scope="class")
    def api_keys(self):
        """ν΄λμ¤ λ λ²¨ API ν‚¤ ν”½μ¤μ²"""
        access_key, secret_key = get_test_api_keys()
        if not access_key or not secret_key:
            pytest.skip("μ‹¤μ  API ν‚¤κ°€ μ—†μ–΄μ„ ν…μ¤νΈλ¥Ό κ±΄λ„λλ‹λ‹¤")
        return access_key, secret_key

    @pytest.mark.asyncio
    async def test_real_public_api(self):
        """μ‹¤μ  κ³µκ° API ν…μ¤νΈ"""
        from upbit_auto_trading.infrastructure.external_apis.api_client_factory import ApiClientFactory

        async with ApiClientFactory.create_public_only_client() as client:
            # μ‹¤μ  λ§μΌ“ μ΅°ν
            markets = await client.get_markets()

            # ν„μ‹¤μ μΈ κ²€μ¦
            assert len(markets) > 0
            assert any(market['market'].startswith('KRW-') for market in markets)

            # μ¶”κ°€ κ²€μ¦: μ²« λ²μ§Έ KRW λ§μΌ“ ν„μ¬κ°€ μ΅°ν
            krw_markets = [m for m in markets if m['market'].startswith('KRW-')]
            if krw_markets:
                first_market = krw_markets[0]['market']
                tickers = await client.get_tickers([first_market])
                assert len(tickers) == 1
                assert 'trade_price' in tickers[0]
                assert tickers[0]['trade_price'] > 0

    @pytest.mark.asyncio
    async def test_real_private_api(self, api_keys):
        """μ‹¤μ  μΈμ¦ API ν…μ¤νΈ"""
        access_key, secret_key = api_keys

        # ν™κ²½λ³€μ ν¨μΉλ΅ API ν‚¤ μ£Όμ…
        with patch.dict('os.environ', {
            'UPBIT_ACCESS_KEY': access_key,
            'UPBIT_SECRET_KEY': secret_key
        }):
            async with ApiClientFactory.create_upbit_client() as client:
                accounts = await client.get_accounts()

                # μµμ†ν•μ ν„μ‹¤μ  κ²€μ¦
                assert isinstance(accounts, list)
                krw_account = next((acc for acc in accounts if acc['currency'] == 'KRW'), None)
                assert krw_account is not None
                assert 'balance' in krw_account
```

### μ‹¤μ  API ν…μ¤νΈ λ¨λ²” μ‚¬λ΅€
1. **scope="class"**: λΉ„μ©μ΄ ν° API ν‚¤ λ΅λ”©μ„ ν΄λμ¤λ‹Ή 1λ²λ§
2. **pytest.skip()**: API ν‚¤ μ—†μΌλ©΄ μλ™μΌλ΅ κ±΄λ„λ›°κΈ°
3. **patch.dict()**: ν™κ²½λ³€μ μ„μ‹ μ„¤μ •μΌλ΅ κ²©λ¦¬λ ν…μ¤νΈ
4. **ν„μ‹¤μ  κ²€μ¦**: λ„λ¬΄ μ—„κ²©ν•μ§€ μ•μ€ κ²€μ¦ μ΅°κ±΄

## π― 5λ‹¨κ³„: ν…μ¤νΈ μ‹¤ν–‰ μ „λµ

### κ°λ° μ¤‘ λΉ λ¥Έ ν”Όλ“λ°±
```bash
# Mock ν…μ¤νΈλ§ (λΉ λ¥Έ μ‹¤ν–‰)
pytest tests/ -m "not real_api" -v

# νΉμ • ν…μ¤νΈ ν΄λμ¤λ§
pytest tests/infrastructure/external_apis/test_upbit_clients.py::TestUpbitPublicClient -v
```

### CI/CDμ© μ „μ²΄ κ²€μ¦
```bash
# μ „μ²΄ ν…μ¤νΈ (μ»¤λ²„λ¦¬μ§€ ν¬ν•¨)
pytest tests/ --cov=upbit_auto_trading --cov-report=html

# μ‹¤μ  API ν…μ¤νΈλ§ (ν”„λ΅λ•μ… κ²€μ¦μ©)
pytest tests/ -m "real_api" -v
```

### μ„±λ¥ λ¨λ‹ν„°λ§
```bash
# λλ¦° ν…μ¤νΈ μ‹λ³„
pytest tests/ --durations=10

# λ³‘λ ¬ μ‹¤ν–‰ (pytest-xdist)
pytest tests/ -n auto
```

## π”§ λ¬Έμ  ν•΄κ²° κ°€μ΄λ“

### μμ£Ό λ°μƒν•λ” μ¤λ¥μ™€ ν•΄κ²°λ²•

#### 1. ApiResponse νλΌλ―Έν„° μ¤λ¥
```
TypeError: ApiResponse.__init__() got an unexpected keyword argument 'response_time'
```
**ν•΄κ²°**: `response_time_ms` μ‚¬μ©

#### 2. Mock νΈμ¶ κ²€μ¦ μ‹¤ν¨
```
AssertionError: expected call not found.
Expected: params={'isDetails': 'true'}
Actual: params={'isDetails': 'false'}
```
**ν•΄κ²°**: μ‹¤μ  κµ¬ν„μ κΈ°λ³Έκ°’ ν™•μΈ

#### 3. λΉ„λ™κΈ° ν…μ¤νΈ μ‹¤ν¨
```
RuntimeError: There is no current event loop
```
**ν•΄κ²°**: `@pytest.mark.asyncio` μ¶”κ°€ λ° `AsyncMock` μ‚¬μ©

### λ””λ²„κΉ… ν
1. **μ‹¤μ  κµ¬ν„ ν™•μΈ**: Mock μ „μ— μ‹¤μ  μ½”λ“ λ¶„μ„
2. **λ‹¨κ³„λ³„ κ²€μ¦**: κ° λ‹¨κ³„λ§λ‹¤ printλ΅ ν™•μΈ
3. **pytest -vvv**: λ§¤μ° μƒμ„Έν• μ¶λ ¥μΌλ΅ μ›μΈ νμ•…

## π“ ν…μ¤νΈ ν’μ§ μ²΄ν¬λ¦¬μ¤νΈ

### Mock ν…μ¤νΈ ν’μ§
- [ ] μ‹¤μ  API μ‘λ‹µ κµ¬μ΅°μ™€ λ™μΌν• Mock λ°μ΄ν„°
- [ ] λ¨λ“  νλΌλ―Έν„°λ…μ΄ μ‹¤μ  κµ¬ν„κ³Ό μΌμΉ
- [ ] λΉ„λ™κΈ° λ©”μ„λ“μ— AsyncMock μ‚¬μ©
- [ ] λ¦¬μ†μ¤ μ •λ¦¬ (yield ν¨ν„΄)

### μ‹¤μ  API ν…μ¤νΈ ν’μ§
- [ ] API ν‚¤ μ—†μΌλ©΄ μλ™ skip
- [ ] ν™κ²½λ³€μ κ²©λ¦¬ (patch.dict)
- [ ] ν„μ‹¤μ μ΄κ³  μ•μ •μ μΈ κ²€μ¦ μ΅°κ±΄
- [ ] μ™Έλ¶€ API μμ΅΄μ„± μµμ†ν™”

### μ „μ²΄ μ‹μ¤ν… ν’μ§
- [ ] λ§μ»¤ κΈ°λ° ν…μ¤νΈ λ¶„λ¥
- [ ] CI/CD νμ΄ν”„λΌμΈ ν†µν•©
- [ ] μ»¤λ²„λ¦¬μ§€ μΈ΅μ • λ° λ¦¬ν¬ν…
- [ ] μ„±λ¥ λ¨λ‹ν„°λ§

---

**π― μ„±κ³µμ ν•µμ‹¬**: "Mockμ μ •ν™•μ„± + μ‹¤μ  API κ²€μ¦ + μ²΄κ³„μ μΈ μ‹¤ν–‰ μ „λµ"
