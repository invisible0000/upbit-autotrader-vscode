# ğŸ”§ pytest ë‹¨ìœ„í…ŒìŠ¤íŠ¸ êµ¬í˜„ - ë¬¸ì œí•´ê²° ê°€ì´ë“œ

> **ëŒ€ìƒ**: ì£¼ë‹ˆì–´ ê°œë°œì
> **ëª©ì **: pytest êµ¬í˜„ ê³¼ì •ì—ì„œ ë°œìƒí•œ ì‹¤ì œ ë¬¸ì œì™€ í•´ê²° ê³¼ì • ê¸°ë¡
> **ì‘ì„±ì¼**: 2025-08-05

## ğŸš¨ ë°œìƒí•œ ë¬¸ì œë“¤ê³¼ í•´ê²° ê³¼ì •

### ğŸ”´ ë¬¸ì œ #1: ApiResponse ìƒì„±ì íŒŒë¼ë¯¸í„° ì˜¤ë¥˜

#### ì¦ìƒ
```bash
TypeError: ApiResponse.__init__() got an unexpected keyword argument 'response_time'.
Did you mean 'response_time_ms'?
```

#### ì›ì¸ ë¶„ì„
```python
# âŒ ì˜ëª»ëœ Mock ì½”ë“œ
mock_response = ApiResponse(
    success=True,
    data=mock_response_data,
    status_code=200,
    response_time=0.1  # ì˜ëª»ëœ íŒŒë¼ë¯¸í„°ëª…
)
```

#### í•´ê²° ê³¼ì •
1. **ì‹¤ì œ êµ¬í˜„ í™•ì¸**
   ```bash
   # ì‹¤ì œ ApiResponse í´ë˜ìŠ¤ ë¶„ì„
   code upbit_auto_trading/infrastructure/external_apis/common/api_client_base.py
   ```

2. **ì •í™•í•œ êµ¬ì¡° íŒŒì•…**
   ```python
   @dataclass
   class ApiResponse:
       status_code: int
       data: Any
       headers: Dict[str, str]
       request_time: datetime
       response_time_ms: float  # ì •í™•í•œ íŒŒë¼ë¯¸í„°ëª…!
       success: bool
       error_message: Optional[str] = None
   ```

3. **ìˆ˜ì •ëœ ì½”ë“œ**
   ```python
   # âœ… ì˜¬ë°”ë¥¸ Mock ì½”ë“œ
   from datetime import datetime

   mock_response = ApiResponse(
       success=True,
       data=mock_response_data,
       status_code=200,
       headers={},
       request_time=datetime.now(),
       response_time_ms=100.0  # ì˜¬ë°”ë¥¸ íŒŒë¼ë¯¸í„°ëª…
   )
   ```

#### êµí›ˆ
- **Mock ì‘ì„± ì „ ì‹¤ì œ êµ¬í˜„ ë¶„ì„ í•„ìˆ˜**
- **IDEì˜ ìë™ì™„ì„±ë³´ë‹¤ ì‹¤ì œ ì†ŒìŠ¤ì½”ë“œ í™•ì¸ì´ ì •í™•**

---

### ğŸ”´ ë¬¸ì œ #2: UpbitAuthenticator í—¤ë” ê²€ì¦ ì‹¤íŒ¨

#### ì¦ìƒ
```bash
AssertionError: assert 'User-Agent' in {'Accept': 'application/json', 'Content-Type': 'application/json'}
```

#### ì›ì¸ ë¶„ì„
```python
# âŒ ì˜ëª»ëœ ê¸°ëŒ€ê°’
def test_get_public_headers(self):
    auth = UpbitAuthenticator(None, None)
    headers = auth.get_public_headers()
    assert "User-Agent" in headers  # ì‹¤ì œë¡œëŠ” ì—†ìŒ!
```

#### í•´ê²° ê³¼ì •
1. **ì‹¤ì œ êµ¬í˜„ í™•ì¸**
   ```python
   # upbit_auth.pyì˜ ì‹¤ì œ êµ¬í˜„
   def get_public_headers(self) -> Dict[str, str]:
       return {
           'Accept': 'application/json',
           'Content-Type': 'application/json'
           # User-AgentëŠ” ì—†ìŒ!
       }
   ```

2. **í…ŒìŠ¤íŠ¸ ìˆ˜ì •**
   ```python
   # âœ… ì‹¤ì œ êµ¬í˜„ì— ë§ëŠ” ê²€ì¦
   def test_get_public_headers(self):
       auth = UpbitAuthenticator(None, None)
       headers = auth.get_public_headers()

       # ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” í—¤ë”ë§Œ ê²€ì¦
       assert "Accept" in headers
       assert "Content-Type" in headers
       assert headers["Accept"] == "application/json"
       assert headers["Content-Type"] == "application/json"
       assert "Authorization" not in headers
   ```

#### êµí›ˆ
- **ê°€ì •í•˜ì§€ ë§ê³  ì‹¤ì œ ë™ì‘ í™•ì¸**
- **í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ êµ¬í˜„ì˜ ê³„ì•½(Contract)ì„ ê²€ì¦í•´ì•¼ í•¨**

---

### ğŸ”´ ë¬¸ì œ #3: API í˜¸ì¶œ íŒŒë¼ë¯¸í„° ë¶ˆì¼ì¹˜

#### ì¦ìƒ
```bash
AssertionError: expected call not found.
Expected: params={'isDetails': 'true'}
Actual: params={'isDetails': 'false'}
```

#### ì›ì¸ ë¶„ì„
```python
# âŒ ì˜ëª»ëœ ì˜ˆìƒê°’
mock_request.assert_called_once_with(
    "GET", "/market/all",
    params={"isDetails": "true"}  # ì‹¤ì œ ê¸°ë³¸ê°’ê³¼ ë‹¤ë¦„
)
```

#### í•´ê²° ê³¼ì •
1. **ì‹¤ì œ ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ í™•ì¸**
   ```python
   # upbit_public_client.py ë¶„ì„
   async def get_markets(self, is_details: bool = False) -> List[Dict[str, Any]]:
       params = {'isDetails': 'true' if is_details else 'false'}
       # ê¸°ë³¸ê°’ Falseì´ë¯€ë¡œ 'false'ê°€ ì •ìƒ!
   ```

2. **í…ŒìŠ¤íŠ¸ í˜¸ì¶œ ë°©ì‹ í™•ì¸**
   ```python
   # í…ŒìŠ¤íŠ¸ì—ì„œ íŒŒë¼ë¯¸í„° ì—†ì´ í˜¸ì¶œ
   result = await client.get_markets()  # is_details=False (ê¸°ë³¸ê°’)
   ```

3. **ì˜¬ë°”ë¥¸ ê²€ì¦ ì½”ë“œ**
   ```python
   # âœ… ì‹¤ì œ ê¸°ë³¸ê°’ì— ë§ëŠ” ê²€ì¦
   mock_request.assert_called_once_with(
       "GET", "/market/all",
       params={"isDetails": "false"}  # ê¸°ë³¸ê°’ ë°˜ì˜
   )
   ```

#### êµí›ˆ
- **ê¸°ë³¸ê°’ê³¼ ì‹¤ì œ í˜¸ì¶œ ë°©ì‹ ì •í™•íˆ íŒŒì•…**
- **ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ë¶„ì„ í•„ìˆ˜**

---

### ğŸ”´ ë¬¸ì œ #4: ë¹„ë™ê¸° Mock ì²˜ë¦¬ ì˜¤ë¥˜

#### ì¦ìƒ
```bash
RuntimeError: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
```

#### ì›ì¸ ë¶„ì„
```python
# âŒ ì˜ëª»ëœ Mock ì„¤ì •
with patch.object(client, '_make_request', new_callable=Mock) as mock_request:
    # Mock ëŒ€ì‹  AsyncMockì´ í•„ìš”!
```

#### í•´ê²° ê³¼ì •
1. **ë¹„ë™ê¸° íŠ¹ì„± ì´í•´**
   - `_make_request`ëŠ” `async` ë©”ì„œë“œ
   - ì¼ë°˜ `Mock`ìœ¼ë¡œëŠ” `await` ì²˜ë¦¬ ë¶ˆê°€

2. **ì˜¬ë°”ë¥¸ Mock ì ìš©**
   ```python
   # âœ… ë¹„ë™ê¸° ë©”ì„œë“œì—ëŠ” AsyncMock
   with patch.object(client, '_make_request', new_callable=AsyncMock) as mock_request:
       mock_request.return_value = mock_response
       result = await client.get_markets()  # ì •ìƒ ë™ì‘
   ```

#### êµí›ˆ
- **ë¹„ë™ê¸° ë©”ì„œë“œ Mock ì‹œ ë°˜ë“œì‹œ AsyncMock ì‚¬ìš©**
- **pytest-asyncio ì„¤ì • í•„ìš”: `asyncio_mode = "auto"`**

---

### ğŸ”´ ë¬¸ì œ #5: API í‚¤ ë¡œë”© ë³µì¡ì„±

#### ì¦ìƒ
```python
FileNotFoundError: [Errno 2] No such file or directory: 'config/secure/api_keys.enc'
```

#### ì›ì¸ ë¶„ì„
- í”„ë¡œì íŠ¸ì— 2ê°€ì§€ API í‚¤ ì €ì¥ ë°©ì‹ ì¡´ì¬
- `.env` íŒŒì¼ê³¼ ì•”í˜¸í™”ëœ íŒŒì¼ ë™ì‹œ ì§€ì› í•„ìš”
- í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ìœ ì—°í•œ ì²˜ë¦¬ í•„ìš”

#### í•´ê²° ê³¼ì •
1. **ì´ì¤‘ ë¡œë”© ì „ëµ ì„¤ê³„**
   ```python
   def get_test_api_keys() -> Tuple[Optional[str], Optional[str]]:
       # 1ìˆœìœ„: .env íŒŒì¼ (ê°œë°œ í¸ì˜ì„±)
       try:
           access_key, secret_key = load_from_env()
           if access_key and secret_key:
               return access_key, secret_key
       except Exception:
           pass

       # 2ìˆœìœ„: ì•”í˜¸í™” íŒŒì¼ (í”„ë¡œë•ì…˜ ë³´ì•ˆ)
       try:
           return load_from_encrypted()
       except Exception:
           pass

       return None, None
   ```

2. **ì•ˆì „í•œ fallback êµ¬í˜„**
   ```python
   @pytest.fixture(scope="class")
   def api_keys(self):
       access_key, secret_key = get_test_api_keys()
       if not access_key or not secret_key:
           pytest.skip("ì‹¤ì œ API í‚¤ê°€ ì—†ì–´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤")
       return access_key, secret_key
   ```

#### êµí›ˆ
- **ë‹¤ì¤‘ ì†ŒìŠ¤ ì§€ì›ìœ¼ë¡œ í™˜ê²½ë³„ ìœ ì—°ì„± í™•ë³´**
- **í…ŒìŠ¤íŠ¸ëŠ” ì˜ì¡´ì„± ì—†ì´ë„ ì‹¤í–‰ ê°€ëŠ¥í•´ì•¼ í•¨**

---

## ğŸ› ï¸ ë¬¸ì œ í•´ê²° ë°©ë²•ë¡ 

### 1. ì²´ê³„ì  ë¬¸ì œ ì§„ë‹¨
```
ë¬¸ì œ ë°œìƒ â†’ ì˜¤ë¥˜ ë©”ì‹œì§€ ë¶„ì„ â†’ ê´€ë ¨ ì½”ë“œ í™•ì¸ â†’ ì‹¤ì œ êµ¬í˜„ ë¶„ì„ â†’ ìˆ˜ì • â†’ ê²€ì¦
```

### 2. íš¨ê³¼ì ì¸ ë””ë²„ê¹… ë„êµ¬
```bash
# ìƒì„¸í•œ ì˜¤ë¥˜ ì •ë³´
pytest -vvv --tb=long

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
pytest tests/specific_test.py::TestClass::test_method -v

# pdb ë””ë²„ê±° ì‚¬ìš©
pytest --pdb
```

### 3. ì‹¤ì œ êµ¬í˜„ í™•ì¸ ë°©ë²•
```bash
# ì†ŒìŠ¤ì½”ë“œ ì§ì ‘ í™•ì¸
code upbit_auto_trading/infrastructure/external_apis/common/api_client_base.py

# í´ë˜ìŠ¤ êµ¬ì¡° ë¶„ì„
python -c "
from upbit_auto_trading.infrastructure.external_apis.common.api_client_base import ApiResponse
import inspect
print(inspect.signature(ApiResponse.__init__))
"
```

## ğŸ¯ ì˜ˆë°© ê°€ì´ë“œë¼ì¸

### Mock í…ŒìŠ¤íŠ¸ ì‘ì„± ì‹œ
1. **ì‹¤ì œ êµ¬í˜„ ë¨¼ì € ë¶„ì„**: Mock ì‘ì„± ì „ ì‹¤ì œ í´ë˜ìŠ¤/ë©”ì„œë“œ í™•ì¸
2. **íŒŒë¼ë¯¸í„° ì •í™•ì„±**: ìƒì„±ì, ë©”ì„œë“œ ì‹œê·¸ë‹ˆì²˜ ì •í™•íˆ ì¼ì¹˜
3. **ë¹„ë™ê¸° ê³ ë ¤**: async ë©”ì„œë“œëŠ” AsyncMock í•„ìˆ˜
4. **ë¦¬ì†ŒìŠ¤ ì •ë¦¬**: yield íŒ¨í„´ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í›„ ì •ë¦¬

### ì‹¤ì œ API í…ŒìŠ¤íŠ¸ ì‘ì„± ì‹œ
1. **ì˜ì¡´ì„± ìµœì†Œí™”**: API í‚¤ ì—†ì–´ë„ ê±´ë„ˆë›°ê¸°
2. **ê²©ë¦¬ëœ í™˜ê²½**: patch.dictë¡œ í™˜ê²½ë³€ìˆ˜ ì„ì‹œ ì„¤ì •
3. **í˜„ì‹¤ì  ê²€ì¦**: ë„ˆë¬´ ì—„ê²©í•˜ì§€ ì•Šì€ ì¡°ê±´
4. **ì—ëŸ¬ ì²˜ë¦¬**: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“± ì˜ˆì™¸ ìƒí™© ê³ ë ¤

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ëµ
1. **ë‹¨ê³„ë³„ ê²€ì¦**: Mock â†’ ì‹¤ì œ API ìˆœì„œë¡œ í…ŒìŠ¤íŠ¸
2. **ë§ˆì»¤ í™œìš©**: ë¹ ë¥¸/ëŠë¦° í…ŒìŠ¤íŠ¸ ë¶„ë¦¬
3. **ì»¤ë²„ë¦¬ì§€ í™•ì¸**: í…ŒìŠ¤íŠ¸ë˜ì§€ ì•Šì€ ì½”ë“œ íŒŒì•…
4. **CI/CD í†µí•©**: ìë™í™”ëœ í’ˆì§ˆ ê²€ì¦

## ğŸ“š ì°¸ê³  ìë£Œ

### pytest ê³µì‹ ë¬¸ì„œ
- [pytest-asyncio](https://pytest-asyncio.readthedocs.io/)
- [unittest.mock](https://docs.python.org/3/library/unittest.mock.html)
- [pytest fixtures](https://docs.pytest.org/en/latest/explanation/fixtures.html)

### ëª¨ë²” ì‚¬ë¡€
- [Testing async code](https://realpython.com/async-io-python/#testing-async-io-code)
- [API testing patterns](https://testdriven.io/blog/testing-third-party-apis/)

## ğŸ”„ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ìˆœì„œëŒ€ë¡œ í™•ì¸:

### ê¸°ë³¸ ì²´í¬ (5ë¶„)
- [ ] pytest ë§ˆì»¤ ì„¤ì • í™•ì¸ (`@pytest.mark.asyncio`)
- [ ] import ê²½ë¡œ ì •í™•ì„± í™•ì¸
- [ ] íŒŒì¼ëª…ì´ pytest ê·œì¹™ì— ë§ëŠ”ì§€ í™•ì¸ (`test_*.py`)

### Mock ê´€ë ¨ (10ë¶„)
- [ ] AsyncMock vs Mock ì ì ˆí•œ ì„ íƒ
- [ ] ì‹¤ì œ í´ë˜ìŠ¤ ì‹œê·¸ë‹ˆì²˜ì™€ Mock ì¼ì¹˜ì„±
- [ ] íŒŒë¼ë¯¸í„°ëª… ì •í™•ì„± (ì‹¤ì œ êµ¬í˜„ ëŒ€ì¡°)
- [ ] ë°˜í™˜ê°’ êµ¬ì¡° ì •í™•ì„±

### API ê´€ë ¨ (10ë¶„)
- [ ] API í‚¤ ë¡œë”© ìƒíƒœ í™•ì¸
- [ ] ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸
- [ ] pytest skip ì¡°ê±´ í™•ì¸

### ì‹œìŠ¤í…œ ê´€ë ¨ (15ë¶„)
- [ ] ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
- [ ] Python ë²„ì „ í˜¸í™˜ì„± í™•ì¸
- [ ] í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì • í™•ì¸
- [ ] ë¡œê·¸ íŒŒì¼ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸

---

**ğŸ’¡ í•µì‹¬ ì›ì¹™**: "ì¶”ì¸¡í•˜ì§€ ë§ê³  í™•ì¸í•˜ë¼. Mockì€ ì‹¤ì œ êµ¬í˜„ì˜ ì •í™•í•œ ë°˜ì˜ì´ì–´ì•¼ í•œë‹¤!"
