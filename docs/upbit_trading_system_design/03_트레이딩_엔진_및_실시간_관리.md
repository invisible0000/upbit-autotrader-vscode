# 자동 매매 프로그램 개발 기획 v2 - 3부: 트레이딩 엔진 및 실시간 관리

## 1. 개요

3부의 목표는 2부에서 설계한 '전략'이라는 청사진에 생명을 불어넣어 실제 시장에서 실행하고 관리하는 **트레이딩 엔진(Trading Engine)** 을 설계하는 것이다. 또한, 여러 포지션을 한눈에 모니터링하고 리스크를 관리하는 **대시보드**를 구체화한다.

---

## 2. 트레이딩 엔진 (`TradingEngine`)

트레이딩 엔진은 시스템의 '손과 발'로서, 실시간 데이터 스트림을 처리하고, `StrategyEvaluator`에게 신호 평가를 요청하며, 그 결과에 따라 실제 주문을 실행하는 핵심 컴포넌트이다.

### 2.1. 포지션 관리자 (`PositionManager`)
모든 활성 포지션의 생명주기를 관리하고, 실시간 데이터를 각 포지션에 분배하는 컨트롤 타워.

*   **포지션 생명주기 관리**:
    1.  **생성(Pending)**: 사용자가 대시보드에서 '전략 실행' 버튼을 누르면, `Position` 객체가 `pending` 상태로 생성된다.
    2.  **활성화(Active)**: `StrategyEvaluator`가 진입 신호를 감지하면, `OrderExecutor`를 통해 진입 주문을 실행한다. 주문이 성공적으로 체결되면 포지션은 `active` 상태로 전환된다.
    3.  **종료 중(Closing)**: 청산 신호가 감지되거나 사용자가 수동으로 종료를 명령하면, `closing` 상태로 변경되고 청산 주문이 실행된다.
    4.  **종료(Closed)**: 청산 주문이 모두 체결되면, 최종 손익을 정산하고 `closed` 상태로 전환된다.
    5.  **오류(Error)**: 주문 실패, API 오류 등 예기치 않은 문제가 발생하면 `error` 상태로 전환되고, 해당 포지션의 자동매매는 즉시 중지된다.

*   **실시간 상태 추적**:
    *   `PositionManager`는 DB에 저장된 정보 외에, 각 `active` 포지션의 **실시간 상태 정보**를 메모리에서 관리한다.
    *   **상태 정보 예시**: 진입 후 도달한 최고가(`highest_price_since_entry`), 현재 보유 수량, 평균 단가, 미실현 손익 등.
    *   이 정보는 '추적 손절'과 같은 **상태 기반(stateful)** 변수를 계산하는 데 필수적이다.

### 2.2. 주문 실행기 (`OrderExecutor`)
`PositionManager`의 지시를 받아 `API Wrapper`를 통해 실제 매수/매도 주문을 실행하고, 그 결과를 보고하는 역할.

*   **주문 실행**: Upbit API에 맞게 포맷된 주문 요청을 생성하고 `UpbitRestApiClient`를 통해 전송한다.
*   **체결 확인**: 주문 전송 후, 해당 주문이 완전히 체결될 때까지 `trades` 테이블을 주기적으로 확인하거나 WebSocket으로 체결 데이터를 수신하여 체결 여부를 추적한다.
*   **결과 보고**: 최종 체결 가격, 수량, 수수료 등의 정보를 `PositionManager`에 보고하여 포지션 상태를 업데이트하고 `trades` 테이블에 기록하도록 한다.
*   **오류 처리**: 주문 실패(예: 잔고 부족), API 오류 발생 시, 오류 정보를 포함하여 `PositionManager`에 즉시 보고한다.

---

## 3. 포트폴리오 대시보드 및 리스크 관리

### 3.1. 포트폴리오 대시보드 UI/UX (`DashboardWidget`)
여러 활성 포지션들을 한눈에 모니터링하고, 전체 자산 현황을 추적하며, 시스템을 제어하는 중앙 관제 센터.

*   **UI 구성**:
    *   **계좌 요약**: 전체 계좌의 총 자산, 사용 가능 현금, 총 평가 손익 등을 표시하는 영역.
    *   **활성 포지션 목록**: 현재 `active` 상태인 모든 포지션의 목록을 테이블 형태로 표시. (마켓, 진입 시간, 투입 원금, 평가 금액, 미실현 손익 등)
    *   **포지션 제어판**: 목록에서 특정 포지션을 선택하면, 해당 포지션을 '즉시 종료'하거나 '일시 중지'하는 등의 제어 버튼을 제공.
    *   **시스템 로그 뷰어**: 시스템의 주요 동작 및 오류 로그를 실시간으로 표시하는 영역.
    *   **이벤트 타임라인**: 매수, 매도, 오류 발생 등 주요 이벤트를 시간순으로 시각화하여 보여주는 뷰.

### 3.2. 리스크 관리 기능
시스템의 안정성과 자산 보호를 위한 핵심 안전장치.

*   **전역 포트폴리오 손실 제한**:
    *   **설정**: 사용자는 시스템 설정에서 '전체 자산 대비 최대 허용 손실률'(예: -10%)을 설정할 수 있다.
    *   **동작**: `PositionManager`는 모든 포지션의 미실현 손익 합계를 실시간으로 계산하여, 이 값이 설정된 손실률을 초과하면 **모든 활성 포지션을 즉시 시장가로 청산**하고 시스템을 '안전 모드'로 전환한다.
    *   **알림**: 이 기능이 발동되면, 사용자에게 즉시 텔레그램 등으로 긴급 알림을 보낸다.

*   **개별 포지션 손절매 (Stop-Loss)**:
    *   전략의 청산 조건에 '손절매' 트리거를 포함시켜 구현한다. (예: '현재가가 진입가 대비 -5% 이하로 하락하면 청산')

*   **OCO (One-Cancels-the-Other) 청산**:
    *   전략의 청산 조건에 여러 개의 트리거(예: 익절, 손절, 추적 손절)가 있을 경우, 그 중 **하나의 조건이 먼저 충족되어 청산이 시작되면 나머지 청산 조건들은 자동으로 비활성화**되는 로직을 `PositionManager`에 구현한다. 이는 불필요한 중복 주문을 방지한다.
