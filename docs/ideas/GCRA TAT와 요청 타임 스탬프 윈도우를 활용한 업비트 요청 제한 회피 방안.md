## GCRA TAT와 요청 타임 스탬프 윈도우를 활용한 업비트 요청 제한 회피 방안
1. 기본적은 GCRA의 TAT를 이용한 지연을 사용. (기본 동작 사이클은 gcra를 따름)
2. 요청 타임스탬프 윈도우를 이용하여 버스트 허용 확인 및 지연량 정밀 제공

### 기본 정보
- 업비트 요청 제한은 크게 1초당 카운트 제한과 1분당 카운트 제한으로 분류된다. (감시 인터벌 또는 윈도우 인터벌)
- 업비트 요청 제한은 세부적으로 0.5 rps, 5 rps, 8rps, 10rps, 30 rps, 100 rpm 6종류이다.
- **업비트 웹소켓의 요청 제한은 5 rps, 100 rpm 중복 제한을 가진다.
- 0.5 rps 제한은 1초 간격으로 다루기 어려우므로 2초 간격으로 변환하여 사용하여야 한다.
### 요청 타임 스탬프 윈도우 관리 방법
#### 기본 설정
1. 윈도우의 크기는 요청제한 카운트
	- 요청 제한이 5 rps면 윈도우는 5슬롯
	- **0.5 rps 요청 제한은 윈도우 크기를 1로 하고 감시 인터벌도 2초로 사용
2. 1초당 카운트 제한은 감시 인터벌이 1초
3. 1분당 카운트 제한은 감시 인터벌이 1분
4. 윈도우는 빈값을 가질 수 있다. (빈슬롯이라고도 표현하며 버스트 여유를 의미한다. 코파일럿이 다른 방안으로 같은 효과를 내도록 바꿀 수 있음)
5. 윈도우에 채워지는 순서는 FIFO를 따름(`[,,]` `[1,,]`, `[2,1,]`, `[3,2,1]`, `[4,3,2]`, `[4,3,]`, `[4,,]`, `[,,]`)

#### 메커니즘
1. 윈도우에 빈슬롯이 있으면 지연을 무시하고 요청을 처리함(버스트)
2. 윈도우에 빈슬롯이 없다면 GCRA TAT 절차를 따름
3. 지연 적용시 윈도우의 타임스탬프를 계산하여 TAT 결과 중 더 큰 값을 사용.
	- 윈도우 타임스탬프 첫 슬롯에서 현재 시간을 빼서 시차계산
		- 만약 첫슬롯 시차가 감시 인터벌보다 크면 계산 중지(이미 큰 차이가 있으므로 지연 계산에 의미가 없음)
	- 2번 슬롯부터는 다음 슬롯 시간에서 이전 슬롯 시간을 빼서 시차 계산
	- 윈도우 시차의 합을 감시 인터벌에서 뺀 값을 지연으로 제공
4. 슬롯은 현재 시간과 감시 인터벌 만큼 차이나면 비움 (별도 관리자 역할?, 전역 상태 관리 필요?)

### 요청 시니리오
- 서버의 요청 제한 3 rps 가정

| time(ms) | 서브1 | 서브2 |
| -------- | ---- | ---- |
| 1000 ms | s1_1 | none |
| 1020 ms | none | s2_1 |
| 1030 ms | s1_2 | none |
| 1040 ms | none | s2_2 |
| 1500 ms | s1_3 | none |
| 1800 ms | none | s2_3 |
| 2200 ms | s1_4 | none |
| 2600 ms | none | s2_4 |
| 3000 ms | s1_5 | none |

- 요청 처리 예상

| time(ms) | 서브1  | 서브2  | queue            | 참조 id               | 윈도우             | 윈도우 시차        | 윈도우 시차합 | 처리   | 상태  | 지연     |
| -------- | ---- | ---- | ---------------- | ------------------- | ------------------ | ------------- | ------- | ---- | --- | ------ |
| 초기값 | none | none | none             | [, , ]              | [, , ]             | [, , ]        | 0 ms    | none | 초기값 | 0 ms   |
| 0 ms  | none | none |                  | [, , ]  | [, , ] | [, , ] | 0 ms  | 유휴 | 빈슬롯  | (0 ms) |
| 1000 ms  | s1_1 | none |                  | [s1_1, , ]          | [1000, , ]         | [0, , ]       | 0 ms    | s1_1 | 전송  | 0 ms   |
| 1020 ms  | none | s2_1 |                  | [s2_1, s1_1, ]      | [1020, 1000, ]     | [0, 20, ]     | 20 ms   | s2_1 | 전송  | 0 ms   |
| 1030 ms  | s1_2 | none |                  | [s1_2, s2_1, s1_1]  | [1030, 1020, 1000] | [0, 10, 20]   | 30 ms   | s1_2 | 전송  | 0 ms   |
| 1040 ms  | none | s2_2 | s2_2             | [s1_2, s2_1, s1_1]  | [1030, 1020, 1000] | [10, 10, 20]  | 40 ms   | 큐    | 대기  | 960 ms |
| 1500 ms  | s1_3 | none | s2_2, s1_3       | [s1_2, s2_1, s1_1]  | [1030, 1020, 1000] | [470, 10, 20] | 500 ms  | 큐    | 대기  | 500 ms |
| 1800 ms  | none | s2_3 | s2_2, s1_3, s2_3 | [s1_2, s2_1, s1_1]  | [1030, 1020, 1000] | [770, 10, 20] | 800 ms  | 큐    | 대기  | 300 ms |
| 2000 ms  | none | none | s1_3, s2_3       | [s2_2, s1_2, s2_1,] | [1040, 1030, 1020] | [960, 10, 10] | 980 ms  | s2_2 | 전송  | 20 ms  |
| 2020 ms  | none | none | s2_3             | [s1_3, s2_2, s2_1]  | [1500, 1040, 1030] | [520, 460, 10] | 990 ms  | s1_3 | 전송  | 10 ms |
| 2030 ms  | none | none |                  | [s2_3, s1_3, s2_2]  | [1800, 1500, 1040] | [230, 300, 460] | 990 ms  | s2_3 | 전송  | 10 ms |
| 2040 ms  | none | none |                  | [s2_3, s1_3, s2_2]  | [1800, 1500, 1040] | [240, 300, 460] | 1000 ms  | 슬롯 | 정리  | 0 ms |
| 2040 ms  | none | none |                  | [s2_3, s1_3, ]  | [1800, 1500, ] | [240, 300, ] | 540 ms  | 유휴 | 빈슬롯  | (300 ms) |
| 2200 ms  | s1_4 | none |                  | [s1_4, s2_3, s1_3]  | [2200, 1800, 1500 ] | [0, 400, 300 ] | 700 ms  | s1_4 | 전송  | 300 ms |
| 2500 ms  | none | none |                  | [s1_4, s2_3, s1_3]  | [2200, 1800, 1500 ] | [300, 400, 300 ] | 1000 ms  | 슬롯 | 정리  | 0 ms |
| 2500 ms  | none | none |                  | [s1_4, s2_3, ]  | [2200, 1800, ] | [300, 400, ] | 700 ms  | 슬롯 | 정리  | 0 ms |
| 2600 ms  | none | s2_4 |                  | [s2_4, s1_4, s2_3]  | [2600, 2200, 1800 ] | [0, 400, 400 ] | 800 ms  | s2_4 | 전송  | 200 ms |
| 2800 ms  | none | none |                  | [s2_4, s1_4, s2_3]  | [2600, 2200, 1800 ] | [200, 400, 400 ] | 1000 ms  | 슬롯 | 정리  | 0 ms |
| 2800 ms  | none | none |                  | [s2_4, s1_4, ]  | [2600, 2200, ] | [200, 400, ] | 600 ms  | 유휴 | 빈슬롯  | (400 ms)|
| 3000 ms  | s1_5 | none |                  | [s1_5, s2_4, s1_4 ]  | [3000, 2600, 2200 ] | [0, 400, 400 ] | 800 ms  | s1_5 | 전송  | 200 ms |
| 3200 ms  | none | none |                  | [s1_5, s2_4, s1_4 ]  | [3000, 2600, 2200 ] | [200, 400, 400 ] | 1000 ms  | 슬롯 | 정리  | 0 ms |
| 3200 ms  | none | none |                  | [s1_5, s2_4, ]  | [3000, 2600, ] | [200, 400, ] | 600 ms  | 유휴 | 빈슬롯  | (400 ms) |
| 3600 ms  | none | none |                  | [s1_5, , ]  | [3000, , ] | [200, , ] | 200 ms  | 유휴 | 빈슬롯  | (200 ms) |
| 3800 ms  | none | none |                  | [, , ]  | [, , ] | [,, ] | 0 ms  | 유휴 | 빈슬롯  | (0 ms) |