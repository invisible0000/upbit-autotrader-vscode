"""
기본 7규칙 전략 예제 - 전략 메이커 사용 가이드
원자적 컴포넌트 기반 전략 빌더를 활용한 완전한 매매 전략 구성 가이드
"""

# 기본 7규칙 전략 예제 - 전략 메이커 사용 가이드

## 🎯 목표
원자적 전략 빌더 UI를 사용하여 **"기본 7규칙 전략"**을 처음부터 끝까지 직접 만들어보는 실습 가이드입니다.

## 📋 전략 개요
| 번호 | 규칙 이름 (역할) | 간단한 설명 |
|:-----|:----------------|:------------|
| 1 | **RSI 과매도 진입** (ENTRY) | RSI 지표가 20 이하로 떨어지면 최초 진입 |
| 2 | **수익 시 불타기** (SCALE_IN) | 수익률 5% 도달 시마다 3회까지 추가 매수 |
| 3 | **계획된 익절** (EXIT) | 불타기 3회 완료 후, 다음 수익 신호에 전량 매도 |
| 4 | **트레일링 스탑** (EXIT) | 5% 수익 후, 고점 대비 3% 하락 시 전량 매도 |
| 5 | **하락 시 물타기** (SCALE_IN) | 평단가 대비 -5% 하락 시, 2회까지 추가 매수 |
| 6 | **급락 감지** (EXIT/RISK_MGMT) | 1분 내 -5% 폭락 시, 모든 규칙 무시하고 즉시 청산 |
| 7 | **급등 감지** (MANAGEMENT) | 1분 내 +5% 급등 시, 불타기 중단하여 트레일링 스탑으로 더 높은 수익 추구 |

---

## 🚀 Step-by-Step 실습 가이드

### **Phase 1: 전략 빌더 시작**

1. **전략 빌더 실행**
   ```bash
   cd ui_prototypes
   python atomic_strategy_builder_ui.py
   ```

2. **화면 구성 확인**
   - 왼쪽: 컴포넌트 팔레트 (📊변수, 🎯조건, ⚡액션 탭)
   - 오른쪽: 전략 캔버스 (📦선택된 컴포넌트들, 규칙 카드 영역)

---

### **Phase 2: 규칙 1 - RSI 과매도 진입 (ENTRY)**

#### **Step 1: RSI 지표 설정**
1. 왼쪽 팔레트 → **📊 변수** 탭 클릭
2. "지표" 그룹에서 **"📈 RSI 지표"** 버튼 클릭
3. 팝업에서 RSI 설정:
   - `period` 슬라이더: **14** (기본값 유지)
   - **OK** 클릭

#### **Step 2: 과매도 조건 생성**
1. **🎯 조건** 탭 클릭
2. "커스텀 조건 생성" 그룹에서 **"🔧 새 조건 만들기"** 클릭
3. 커스텀 조건 다이얼로그:
   - 변수 선택: **"RSI 지표 (indicator.rsi)"**
   - 연산자: **"<"**
   - 비교 대상: **"고정값"** → **"20"** 입력
   - 조건 이름: **"RSI 과매도 진입"**
   - 실시간 미리보기 확인: "📊 RSI 지표 < 20"
   - **OK** 클릭

#### **Step 3: 매수 액션 선택**
1. **⚡ 액션** 탭 클릭
2. **"💰 전량 매수"** 버튼 클릭

#### **Step 4: 진입 규칙 생성**
1. 오른쪽 캔버스에서 **"🔧 규칙 만들기"** 버튼 클릭
2. 규칙 생성 다이얼로그:
   - 규칙 이름: **"RSI 과매도 진입"**
   - 규칙 역할: **"ENTRY"**
   - 조건 조합 방식: **"AND"** (조건이 1개뿐이므로 상관없음)
   - 실행할 액션: **"💰 전량 매수"** 선택
   - **OK** 클릭

✅ **결과**: 녹색 배경의 🚀 진입 규칙 카드가 캔버스에 생성됨

---

### **Phase 3: 규칙 2 - 수익 시 불타기 (SCALE_IN)**

#### **Step 1: 수익률 조건 생성**
1. **🎯 조건** 탭 → **"🔧 새 조건 만들기"** 클릭
2. 커스텀 조건 설정:
   - 변수 선택: **"현재 수익률(%) (state.profit_percent)"**
   - 연산자: **">="**
   - 비교 대상: **"고정값"** → **"5"** 입력
   - 조건 이름: **"5% 수익 달성"**
   - **OK** 클릭

#### **Step 2: 부분 매수 액션 설정**
1. **⚡ 액션** 탭에서 **"💰 전량 매수"** 클릭 (추가 매수용으로 재사용)

#### **Step 3: 불타기 규칙 생성**
1. **"🔧 규칙 만들기"** 클릭
2. 규칙 설정:
   - 규칙 이름: **"수익 시 불타기"**
   - 규칙 역할: **"SCALE_IN"**
   - 실행할 액션: **"💰 전량 매수"**
   - **OK** 클릭

✅ **결과**: 파란색 배경의 ➕ 추가매수 규칙 카드 생성

---

### **Phase 4: 규칙 3 - 계획된 익절 (EXIT)**

#### **Step 1: 기존 조건 재사용**
1. **🎯 조건** 탭에서 기본 조건 그룹의 **"📊 5% 수익 달성"** 클릭
   (이미 만든 조건을 재사용)

#### **Step 2: 전량 매도 액션 선택**
1. **⚡ 액션** 탭에서 **"🚫 전량 청산"** 클릭

#### **Step 3: 계획된 익절 규칙 생성**
1. **"🔧 규칙 만들기"** 클릭
2. 규칙 설정:
   - 규칙 이름: **"계획된 익절"**
   - 규칙 역할: **"EXIT"**
   - 실행할 액션: **"🚫 전량 청산"**
   - **OK** 클릭

✅ **결과**: 빨간색 배경의 🛑 청산 규칙 카드 생성

---

### **Phase 5: 규칙 4 - 트레일링 스탑 (EXIT)**

#### **Step 1: 트레일링 스탑 조건 생성**
1. **🎯 조건** 탭 → **"🔧 새 조건 만들기"** 클릭
2. 설정:
   - 변수 선택: **"현재 수익률(%)"**
   - 연산자: **">="**
   - 비교 대상: **"고정값"** → **"5"** 입력
   - 조건 이름: **"트레일링 스탑 활성화"**
   - **OK** 클릭

#### **Step 2: 트레일링 스탑 규칙 생성**
1. **⚡ 액션** 탭에서 **"🚫 전량 청산"** 클릭
2. **"🔧 규칙 만들기"** 클릭
3. 규칙 설정:
   - 규칙 이름: **"트레일링 스탑"**
   - 규칙 역할: **"EXIT"**
   - 실행할 액션: **"🚫 전량 청산"**
   - **OK** 클릭

---

### **Phase 6: 규칙 5 - 하락 시 물타기 (SCALE_IN)**

#### **Step 1: 하락 조건 생성**
1. **🎯 조건** 탭 → **"🔧 새 조건 만들기"** 클릭
2. 설정:
   - 변수 선택: **"현재 수익률(%)"**
   - 연산자: **"<="**
   - 비교 대상: **"고정값"** → **"-5"** 입력
   - 조건 이름: **"5% 손실 발생"**
   - **OK** 클릭

#### **Step 2: 물타기 규칙 생성**
1. **⚡ 액션** 탭에서 **"💰 전량 매수"** 클릭
2. **"🔧 규칙 만들기"** 클릭
3. 규칙 설정:
   - 규칙 이름: **"하락 시 물타기"**
   - 규칙 역할: **"SCALE_IN"**
   - 실행할 액션: **"💰 전량 매수"**
   - **OK** 클릭

---

### **Phase 7: 규칙 6 - 급락 감지 (EXIT/RISK_MGMT)**

#### **Step 1: 급락 조건 생성**
1. **🎯 조건** 탭 → **"🔧 새 조건 만들기"** 클릭
2. 설정:
   - 변수 선택: **"현재 수익률(%)"**
   - 연산자: **"<="**
   - 비교 대상: **"고정값"** → **"-5"** 입력
   - 조건 이름: **"급락 감지"**
   - **OK** 클릭

#### **Step 2: 비상 청산 규칙 생성**
1. **⚡ 액션** 탭에서 **"🚫 전량 청산"** 클릭
2. **"🔧 규칙 만들기"** 클릭
3. 규칙 설정:
   - 규칙 이름: **"급락 감지 비상 청산"**
   - 규칙 역할: **"EXIT"**
   - 실행할 액션: **"🚫 전량 청산"**
   - **OK** 클릭

---

### **Phase 8: 규칙 7 - 급등 감지 (MANAGEMENT)**

#### **Step 1: 급등 조건 생성**
1. **🎯 조건** 탭 → **"🔧 새 조건 만들기"** 클릭
2. 설정:
   - 변수 선택: **"현재 수익률(%)"**
   - 연산자: **">="**
   - 비교 대상: **"고정값"** → **"5"** 입력
   - 조건 이름: **"급등 감지"**
   - **OK** 클릭

#### **Step 2: 급등 대응 규칙 생성** (현재 UI 한계로 인한 간소화)
**🎯 목적**: 급등 상황에서 불타기(20% 청산)를 막아 트레일링 스탑으로 더 높은 수익 추구

1. **⚡ 액션** 탭에서 **"🚫 전량 청산"** 클릭
2. **"🔧 규칙 만들기"** 클릭
3. 규칙 설정:
   - 규칙 이름: **"급등 감지 (불타기 방지)"**
   - 규칙 역할: **"EXIT"** (MANAGEMENT 대신)
   - 실행할 액션: **"🚫 전량 청산"**
   - **OK** 클릭

**💡 실제 동작**: 급등 시 불타기를 중단하여 트레일링 스탑이 더 높은 수익률까지 추적할 수 있도록 함

---

### **Phase 9: 전략 검증 및 저장**

#### **Step 1: 전략 검증**
1. 오른쪽 캔버스에서 **"✅ 전략 검증"** 클릭
2. 검증 결과 확인:
   ```
   ✅ 전략이 유효합니다!
   • 진입 규칙: 있음
   • 청산 규칙: 있음
   ```

#### **Step 2: 전략 저장**
1. **"💾 전략 저장"** 클릭
2. 전략 정보 입력:
   - 전략 이름: **"기본 7규칙 전략 예제"**
   - 전략 설명: 
     ```
     RSI 과매도 진입 기반의 완전한 매매 전략
     • 진입: RSI < 20
     • 관리: 수익시 불타기, 손실시 물타기
     • 청산: 계획된 익절, 트레일링 스탑, 급락 감지
     • 제어: 급등 감지로 불타기 방지하여 더 높은 수익 추구
     ```
   - **저장** 클릭

#### **Step 3: 최종 확인**
- 상태바에 "저장됨: 기본 7규칙 전략 예제" 표시 확인
- 캔버스에 7개의 규칙 카드가 모두 표시되어 있는지 확인

---

## 🎯 완성된 전략 구성

캔버스에 다음과 같은 규칙 카드들이 표시되어야 합니다:

1. 🚀 **RSI 과매도 진입** (녹색 - ENTRY)
2. ➕ **수익 시 불타기** (파란색 - SCALE_IN)
3. 🛑 **계획된 익절** (빨간색 - EXIT)
4. 🛑 **트레일링 스탑** (빨간색 - EXIT)
5. ➕ **하락 시 물타기** (파란색 - SCALE_IN)
6. 🛑 **급락 감지 비상 청산** (빨간색 - EXIT)
7. 🛑 **급등 감지 (불타기 방지)** (빨간색 - EXIT)

**💡 전략 핵심**: 급등 시 불타기를 중단하여 트레일링 스탑이 더 높은 수익률까지 추적하도록 하는 수익 최적화 전략

---

## 🔍 검증 포인트

### **필수 확인사항:**
- [ ] 7개 규칙이 모두 생성되었는가?
- [ ] 진입 규칙 1개가 있는가?
- [ ] 청산 규칙이 4개 이상 있는가?
- [ ] 각 규칙 카드의 색상이 역할에 맞게 표시되는가?
- [ ] 전략 검증이 통과되는가?
- [ ] 전략이 성공적으로 저장되는가?

### **고급 확인사항:**
- [ ] 규칙 카드에 조건과 액션이 올바르게 표시되는가?
- [ ] AND/OR 논리 조합이 정확히 표시되는가?
- [ ] 임시 컴포넌트 영역이 올바르게 동작하는가?

---

## 🚨 예상 이슈 및 해결방법

### **이슈 1**: 조건 생성 시 변수가 보이지 않음
**해결**: 📊 변수 탭에서 해당 변수를 먼저 설정했는지 확인

### **이슈 2**: 규칙 생성 시 "조건이 없습니다" 오류
**해결**: 🎯 조건 탭에서 조건을 먼저 선택했는지 확인

### **이슈 3**: 전략 검증 실패
**해결**: 최소 1개의 ENTRY 규칙과 1개의 EXIT 규칙이 있는지 확인

### **이슈 4**: 규칙 카드가 너무 많아서 헷갈림
**해결**: 캔버스 초기화 후 단계별로 천천히 다시 진행

---

## 🎉 완성!

축하합니다! **기본 7규칙 전략 예제**를 성공적으로 완성했습니다.

이제 이 전략을 백테스트하거나 실제 거래에 적용할 수 있는 기반이 마련되었습니다.

### **다음 단계:**
1. 백테스트 엔진과 연동하여 성과 검증
2. 파라미터 최적화 (RSI 임계값, 수익률 목표 등)
3. 추가 규칙 생성 (시간 필터, 볼륨 조건 등)
4. 실제 거래소 API와 연동하여 라이브 트레이딩

**전략 메이커 검증 완료!** ✅
