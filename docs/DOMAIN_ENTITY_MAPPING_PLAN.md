# 🗂️ 도메인 엔티티 매핑 계획서

> **목적**: 업비트 자동매매 시스템의 비즈니스 데이터를 안전하고 효율적으로 저장하는 방법
> **대상**: 비개발자, 기획자, 사업 관계자
> **갱신**: 2025-08-05

## 📋 한 줄 요약

**"사용자가 만든 매매 전략과 설정을 안전하게 보관하고, 필요할 때 빠르게 찾아쓸 수 있는 창고 시스템 설계"**

---

## 🎯 왜 이런 계획이 필요한가?

### 현재 상황
- 사용자들이 **매매 전략**을 만들고 **백테스팅** 결과를 확인하는 시스템
- 데이터가 3개의 다른 창고(데이터베이스)에 분산되어 저장됨
- 각 창고마다 저장하는 내용과 목적이 다름

### 해결하려는 문제
1. **데이터 일관성**: 같은 정보가 여러 곳에 흩어져서 혼란 발생
2. **성능 문제**: 필요한 정보를 찾는데 시간이 오래 걸림
3. **유지보수 어려움**: 시스템 업데이트나 문제 해결이 복잡함

---

## 🏪 3개 창고 시스템 구조

### 1️⃣ 설정 창고 (settings.sqlite3)
**"매매에 사용되는 기본 도구들과 설정값 보관"**

#### 저장 내용
- **매매 변수 정의**: RSI, 이동평균 등 기술적 지표 설명서
- **파라미터 설정**: 각 지표의 설정값 (예: RSI 기간 14일)
- **카테고리 분류**: 지표들을 용도별로 분류한 정보

#### 비유로 설명
- **서점의 도서 분류 시스템**과 같음
- 각 책(지표)이 어느 분야(카테고리)에 속하는지
- 어떤 정보(파라미터)가 필요한지 미리 정의

### 2️⃣ 전략 창고 (strategies.sqlite3)
**"사용자가 만든 매매 전략과 테스트 결과 보관"**

#### 저장 내용
- **사용자 전략**: 개인이 설계한 매매 규칙
- **백테스팅 결과**: 과거 데이터로 테스트한 성과
- **실행 기록**: 실제 거래 내역과 결과

#### 비유로 설명
- **개인의 요리 레시피북**과 같음
- 각자만의 특별한 레시피(전략)
- 만들어본 결과와 평가(백테스팅)
- 실제 요리한 기록(실행 내역)

### 3️⃣ 시장 데이터 창고 (market_data.sqlite3)
**"실제 거래소에서 수집한 시장 정보 보관"**

#### 저장 내용
- **가격 데이터**: 코인의 시세 변화 기록
- **거래량 정보**: 얼마나 많이 거래되었는지
- **기술적 지표 값**: 계산된 RSI, 이동평균 등

#### 비유로 설명
- **기상청의 날씨 데이터**와 같음
- 매일매일의 온도, 습도, 바람 기록
- 이 데이터로 날씨 예측과 분석 수행

### 4️⃣ 미니차트 샘플 창고 (sampled_market_data.sqlite3)
**"트리거 빌더와 전략 메이커의 시뮬레이션용 특별 데이터"**

#### 저장 내용
- **시나리오별 샘플 데이터**: 상승, 하락, 급등, 급락, 횡보, 지표교차
- **KRW-BTC 일봉 데이터**: 약 2,800개의 선별된 데이터
- **전문가 세그멘테이션**: 각 시나리오를 잘 보여주는 구간만 추출

#### 특별한 점
- **독립적 운영**: 다른 시스템에 영향을 주지 않음
- **시뮬레이션 전용**: 미니차트 표시와 전략 테스트에만 사용
- **전문가 선별**: 시나리오별로 최적화된 데이터만 보관

---

## 🔗 도메인 엔티티란 무엇인가?

### 쉬운 설명
**도메인 엔티티 = "비즈니스에서 중요한 개념들을 프로그램으로 표현한 것"**

### 우리 시스템의 주요 엔티티들

#### 1. 전략 (Strategy)
- **의미**: 사용자가 만든 매매 전략
- **포함 정보**: 전략 이름, 설명, 생성일, 사용 횟수
- **실제 예**: "RSI 과매도 진입 + 트레일링 스탑 전략"

#### 2. 조건 (Condition)
- **의미**: 매매 신호를 판단하는 개별 조건
- **포함 정보**: 변수, 연산자, 비교값
- **실제 예**: "RSI가 30보다 작으면"

#### 3. 백테스팅 결과 (BacktestResult)
- **의미**: 과거 데이터로 전략을 테스트한 결과
- **포함 정보**: 수익률, 승률, 최대 손실
- **실제 예**: "6개월간 15% 수익, 승률 67%"

#### 4. 거래 기록 (TradeRecord)
- **의미**: 실제 실행된 매매 내역
- **포함 정보**: 거래 시간, 가격, 수량, 결과
- **실제 예**: "2025-08-05 14:30, BTC 매수, 65,000,000원"

---

## 📊 매핑(연결) 계획

### 무엇을 어디에 저장할 것인가?

#### 설정 창고 ← 기본 정보
```
매매 변수 엔티티 → tv_trading_variables 테이블
파라미터 엔티티 → tv_variable_parameters 테이블
카테고리 엔티티 → tv_indicator_categories 테이블
```

#### 전략 창고 ← 사용자 데이터
```
전략 엔티티 → strategies 테이블
조건 엔티티 → strategy_conditions 테이블
백테스팅 결과 → backtest_results 테이블
실행 기록 → execution_logs 테이블
```

#### 시장 데이터 창고 ← 시장 정보
```
가격 데이터 → price_data 테이블
지표 캐시 → indicator_cache 테이블
시장 정보 → market_info 테이블
```

#### 미니차트 샘플 창고 ← 시뮬레이션 데이터
```
OHLCV 데이터 → ohlcv_data 테이블
시나리오별 세그먼트 → 독립적 관리
미니차트 표시용 → 전용 엔진 사용
```

---

## 🔄 데이터 흐름도 (사용자 관점)

### 1. 전략 생성 과정
```
사용자가 조건 설정
    ↓
설정창고에서 변수 정보 확인
    ↓
조건 엔티티 생성
    ↓
전략창고에 저장
```

### 2. 백테스팅 과정
```
사용자가 전략 선택
    ↓
전략창고에서 전략 정보 로드
    ↓
시장데이터창고에서 과거 데이터 조회
    ↓
시뮬레이션 실행
    ↓
결과를 전략창고에 저장
```

### 3. 미니차트 시뮬레이션 과정
```
사용자가 시나리오 선택 (상승/하락/급등 등)
    ↓
샘플창고에서 해당 시나리오 데이터 로드
    ↓
미니차트에 표시
    ↓
전략 테스트 (다른 시스템과 독립적)
```

---

## 🛡️ 안전성과 성능 보장 방법

### 데이터 안전성
1. **트랜잭션 처리**: 저장 중 문제 발생 시 원래 상태로 복구
2. **데이터 검증**: 잘못된 정보 저장 방지
3. **백업 시스템**: 정기적으로 중요 데이터 백업

### 성능 최적화
1. **인덱스 활용**: 자주 조회되는 정보를 빠르게 찾기
2. **캐시 시스템**: 한 번 계산한 결과를 임시 저장
3. **연결 풀링**: 데이터베이스 연결을 효율적으로 관리

### 미니차트 독립성
1. **별도 데이터 소스**: 다른 시스템에 영향 없음
2. **전용 엔진**: 샘플 데이터 전용 처리 로직
3. **시나리오 최적화**: 각 상황에 맞는 최적의 데이터 제공

---

## 🔧 구현 우선순위

### 1단계: 기본 매핑 (높음)
- 전략과 조건의 기본 저장/조회 기능
- 설정 정보 연동
- 기본적인 데이터 안전성 보장

### 2단계: 성능 최적화 (중간)
- 빠른 조회를 위한 인덱싱
- 캐시 시스템 구축
- 트랜잭션 처리 강화

### 3단계: 고도화 (낮음)
- 고급 백테스팅 결과 분석
- 실시간 성능 모니터링
- 자동 백업 시스템

### 4단계: 미니차트 통합 (지속)
- 샘플 DB 독립적 운영 보장
- 시나리오별 데이터 최적화
- 시뮬레이션 엔진 고도화

---

## ✅ 성공 기준

### 사용자 경험 기준
- [ ] 전략 저장/불러오기가 3초 이내 완료
- [ ] 백테스팅 결과 조회가 1초 이내 완료
- [ ] 미니차트 시뮬레이션이 즉시 반응
- [ ] 시스템 재시작 후에도 모든 데이터 유지

### 기술적 기준
- [ ] 동시 사용자 10명 이상 지원
- [ ] 데이터 무결성 100% 보장
- [ ] 시스템 간 독립성 유지
- [ ] 백업/복구 자동화 완료

---

## 📚 관련 문서

- [프로젝트 명세서](PROJECT_SPECIFICATIONS.md): 전체 시스템 개요
- [DB 스키마](DB_SCHEMA.md): 데이터베이스 상세 구조
- [아키텍처 개요](ARCHITECTURE_OVERVIEW.md): 시스템 설계 원칙

---

## 💡 요약

이 계획의 핵심은 **"올바른 정보를 올바른 곳에 안전하게 보관하여, 필요할 때 빠르게 찾아 사용할 수 있게 만드는 것"**입니다.

특히 **미니차트 샘플 시스템**은 다른 데이터베이스와 완전히 독립적으로 운영되어, 시뮬레이션 기능이 실제 거래 시스템에 전혀 영향을 주지 않도록 설계됩니다.

사용자는 복잡한 내부 구조를 몰라도, 직관적이고 빠른 매매 전략 관리 시스템을 경험하게 될 것입니다.
