# QAsync í†µí•© ì•„í‚¤í…ì²˜ ê²€ì¦ ì›Œí¬í”Œë¡œìš°
# ëª©ì : ì´ë²¤íŠ¸ ë£¨í”„ ì¶©ëŒì„ ìœ ë°œí•˜ëŠ” ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬ë¡œ íšŒê·€ ë°©ì§€

name: QAsync Architecture Compliance Check

on:
  push:
    branches: [ main, develop, feature/qasync-* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  qasync-compliance:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PowerShell
      shell: pwsh
      run: |
        Write-Host "QAsync ì•„í‚¤í…ì²˜ ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì‚¬ ì‹œì‘..." -ForegroundColor Green

    - name: Check for prohibited event loop patterns
      shell: pwsh
      run: |
        Write-Host "ğŸ” ê¸ˆì§€ëœ ì´ë²¤íŠ¸ ë£¨í”„ íŒ¨í„´ ê²€ì‚¬ ì¤‘..." -ForegroundColor Yellow

        # ê¸ˆì§€ íŒ¨í„´ ë¦¬ìŠ¤íŠ¸
        $prohibitedPatterns = @(
          "new_event_loop\(",
          "run_until_complete\(",
          "asyncio\.run\(",
          "set_event_loop\(None\)",
          "QApplication\.exec\(\)"
        )

        $violations = @()
        $totalFiles = 0

        # upbit_auto_trading ë””ë ‰í† ë¦¬ì—ì„œ Python íŒŒì¼ ê²€ì‚¬
        $pythonFiles = Get-ChildItem upbit_auto_trading -Recurse -Include *.py -ErrorAction SilentlyContinue

        if (-not $pythonFiles) {
            Write-Host "âš ï¸ Python íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë””ë ‰í† ë¦¬ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”." -ForegroundColor Yellow
            exit 0
        }

        foreach ($pattern in $prohibitedPatterns) {
            Write-Host "  íŒ¨í„´ ê²€ì‚¬: $pattern" -ForegroundColor Cyan

            $matches = $pythonFiles | Select-String -Pattern $pattern

            foreach ($match in $matches) {
                $violation = @{
                    File = $match.Filename
                    Line = $match.LineNumber
                    Pattern = $pattern
                    Content = $match.Line.Trim()
                }
                $violations += $violation

                Write-Host "    âŒ $($match.Filename):$($match.LineNumber) - $pattern" -ForegroundColor Red
            }
        }

        # ê²°ê³¼ ìš”ì•½
        Write-Host "`nğŸ“Š ê²€ì‚¬ ê²°ê³¼ ìš”ì•½:" -ForegroundColor Green
        Write-Host "  - ê²€ì‚¬ëœ íŒŒì¼: $($pythonFiles.Count)ê°œ" -ForegroundColor White
        Write-Host "  - ë°œê²¬ëœ ìœ„ë°˜: $($violations.Count)ê°œ" -ForegroundColor White

        if ($violations.Count -gt 0) {
            Write-Host "`nğŸš¨ QAsync ì•„í‚¤í…ì²˜ ìœ„ë°˜ ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!" -ForegroundColor Red
            Write-Host "ë‹¤ìŒ íŒ¨í„´ë“¤ì€ ë‹¤ì¤‘ ì´ë²¤íŠ¸ ë£¨í”„ ì¶©ëŒì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:" -ForegroundColor Red

            # íŒŒì¼ë³„ ìœ„ë°˜ ì‚¬í•­ ê·¸ë£¹í™”
            $violationsByFile = $violations | Group-Object File

            foreach ($fileGroup in $violationsByFile) {
                Write-Host "`nğŸ“ $($fileGroup.Name):" -ForegroundColor Yellow
                foreach ($violation in $fileGroup.Group) {
                    Write-Host "  Line $($violation.Line): $($violation.Pattern)" -ForegroundColor Red
                    Write-Host "    $($violation.Content)" -ForegroundColor Gray
                }
            }

            Write-Host "`nğŸ’¡ í•´ê²° ë°©ë²•:" -ForegroundColor Green
            Write-Host "  1. docs/big_issues/issue_01_20250926/QAsync_REFACTORING_WORK_GUIDE.md ì°¸ì¡°" -ForegroundColor White
            Write-Host "  2. @asyncSlot ë°ì½”ë ˆì´í„°ì™€ qasync íŒ¨í„´ ì‚¬ìš©" -ForegroundColor White
            Write-Host "  3. TaskManagerë¥¼ í†µí•œ íƒœìŠ¤í¬ ìƒëª…ì£¼ê¸° ê´€ë¦¬" -ForegroundColor White

            # CI ë¹Œë“œ ì‹¤íŒ¨
            exit 1
        } else {
            Write-Host "âœ… QAsync ì•„í‚¤í…ì²˜ ì»´í”Œë¼ì´ì–¸ìŠ¤ í†µê³¼!" -ForegroundColor Green
        }

    - name: Check for recommended qasync patterns
      shell: pwsh
      run: |
        Write-Host "`nğŸ” ê¶Œì¥ QAsync íŒ¨í„´ ì‚¬ìš© í˜„í™© í™•ì¸..." -ForegroundColor Yellow

        $recommendedPatterns = @(
          "@asyncSlot",
          "qasync\.",
          "TaskManager",
          "loop_guard"
        )

        $pythonFiles = Get-ChildItem upbit_auto_trading -Recurse -Include *.py -ErrorAction SilentlyContinue
        $patternUsage = @{}

        foreach ($pattern in $recommendedPatterns) {
            $matches = $pythonFiles | Select-String -Pattern $pattern
            $patternUsage[$pattern] = $matches.Count

            if ($matches.Count -gt 0) {
                Write-Host "âœ… $pattern íŒ¨í„´: $($matches.Count)ê°œ íŒŒì¼ì—ì„œ ì‚¬ìš©ë¨" -ForegroundColor Green
            } else {
                Write-Host "âš ï¸ $pattern íŒ¨í„´: ì‚¬ìš©ë˜ì§€ ì•ŠìŒ" -ForegroundColor Yellow
            }
        }

        Write-Host "`nğŸ“ˆ QAsync ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ë¥ :" -ForegroundColor Green
        $asyncSlotUsage = $patternUsage["@asyncSlot"]
        $qasyncUsage = $patternUsage["qasync\."]

        if ($asyncSlotUsage -gt 0 -or $qasyncUsage -gt 0) {
            Write-Host "  QAsync íŒ¨í„´ ë„ì…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤." -ForegroundColor Green
        } else {
            Write-Host "  QAsync íŒ¨í„´ ë„ì…ì´ í•„ìš”í•©ë‹ˆë‹¤." -ForegroundColor Yellow
        }

  dependency-check:
    runs-on: windows-latest
    needs: qasync-compliance

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Check qasync dependency
      shell: pwsh
      run: |
        Write-Host "ğŸ“¦ QAsync ì˜ì¡´ì„± í™•ì¸ ì¤‘..." -ForegroundColor Yellow

        # requirements.txt í™•ì¸
        if (Test-Path "requirements.txt") {
            $requirements = Get-Content "requirements.txt"
            $hasQasync = $requirements | Where-Object { $_ -match "qasync" }

            if ($hasQasync) {
                Write-Host "âœ… qasync ì˜ì¡´ì„±ì´ requirements.txtì— ìˆìŠµë‹ˆë‹¤." -ForegroundColor Green
                Write-Host "  $hasQasync" -ForegroundColor Gray
            } else {
                Write-Host "âš ï¸ qasync ì˜ì¡´ì„±ì´ requirements.txtì— ì—†ìŠµë‹ˆë‹¤." -ForegroundColor Yellow
                Write-Host "  QAsync ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìœ„í•´ qasync>=0.24.1ì„ ì¶”ê°€í•˜ì„¸ìš”." -ForegroundColor Yellow
            }
        } else {
            Write-Host "âš ï¸ requirements.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." -ForegroundColor Yellow
        }

        # pyproject.toml í™•ì¸ (ì„ íƒì )
        if (Test-Path "pyproject.toml") {
            $pyproject = Get-Content "pyproject.toml" -Raw
            if ($pyproject -match "qasync") {
                Write-Host "âœ… qasync ì˜ì¡´ì„±ì´ pyproject.tomlì—ë„ ìˆìŠµë‹ˆë‹¤." -ForegroundColor Green
            }
        }
