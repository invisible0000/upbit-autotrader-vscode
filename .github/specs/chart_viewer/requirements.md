# 차트뷰 요구사항 명세서
> 마켓 데이터 DB 및 실시간 API/WebSocket 연동 테스트용 차트뷰 구현

## 📊 화면 구성 및 레이아웃

### 1. 전체 레이아웃 (1:4:2 비율 3열 구조) - 호가창 우선 개발
```
┌──────────┬──────────────────────────────────────────────────┬─────────────┐
│          │            Chart Area (4 비율) - Phase 2 구현    │             │
│  Coin    │  ┌────────────────────────────────────────────┐  │  Orderbook  │
│  List    │  │         Main Plot (Candlestick) 4 비율    │  │   호가창    │
│          │  ├────────────────────────────────────────────┤  │ (우선 구현) │
│ (1 비율) │  │ Volume  │ MACD   │ RSI    │ STOCH  │ ATR   │  │             │
│          │  │        (모든 서브 플롯은 상하 세로 배치)    │  │             │
│          │  │ 1 비율  │ 1 비율 │ 1 비율 │ 1 비율 │ 1비율  │  │  (2 비율)   │
│          │  └────────────────────────────────────────────┘  │             │
│          │  5개 서브플롯 (4:1:1:1:1:1 비율, 상하 세로 배치)   │             │
└──────────┴──────────────────────────────────────────────────┴─────────────┘
```

### 2. 코인 리스트 패널 (좌측)
- **마켓 선택**: KRW/BTC/USDT 마켓 탭
- **검색 필터**: 코인명/심벌 필터 (우측 [×] 버튼으로 클리어)
- **즐겨찾기**: 더블클릭시 ⭐ 표시, 상단 고정, 필터 무시
- **표시 정보**: 심벌 + 코인명
- **데이터 로딩**: 화면 선택시 API로 마켓 정보 로딩

### 3. 차트 패널 (우측)
#### 3.1 차트 상단 컨트롤
- **타임프레임 선택**: 콤보박스 (1m, 3m, 5m, 15m, 30m, 1h, 4h, 1d)
- **데이터 소스 선택**:
  - ☑️ WebSocket (기본 체크)
  - ☐ API (추가 체크시 80% 빈도로 동시 연동)

#### 3.2 메인 플롯 (4 비율)
- **캔들스틱 차트**: OHLC 데이터 시각화
- **기술적 지표 오버레이**: 이동평균선, 볼린저밴드 등
- **초기 데이터**: 현시점 기준 200개 캔들
- **실시간 업데이트**: WebSocket을 통한 현재 캔들 실시간 갱신

#### 3.3 서브 플롯 (5개, 각 1 비율) - 고정 표시
- **거래량 (Volume)**: 기본 거래량 막대 차트
- **MACD**: 신호선과 히스토그램
- **RSI**: 과매수/과매도 구간 표시
- **STOCHASTICS**: %K, %D 라인
- **ATR**: 평균 진실 범위

#### 3.4 차트 상호작용
- **마우스 휠**: 확대/축소
- **좌우 스크롤**: 과거/미래 데이터 탐색
- **자동 데이터 로딩**: 스크롤시 DB에서 추가 데이터 자동 로딩

### 4. 호가창 (우측) - 우선 개발
- **실시간 호가**: 매수/매도 호가 실시간 표시
- **호가 모아보기**: 업비트 호가 모아보기 기능 활용
- **호가량 시각화**: 호가량에 따른 바 차트 또는 히트맵
- **가격 클릭**: 호가 가격 클릭시 상세 정보 표시
- **매수/매도 구분**: 색상으로 매수/매도 호가 구분
- **누적 수량**: 누적 매수/매도 수량 표시
- **틱 단위 정보**: 마켓별 호가 단위 표시
- **스프레드 표시**: 매수/매도 호가 스프레드
- **호가창 깊이**: 30개 호가 쌍 표시 (업비트 기본값)

### 5. 창 상태 기반 리소스 관리
- **활성화 상태**: 창이 활성화되어 있을 때만 실시간 업데이트
- **최소화/숨김**: 창이 최소화되거나 숨겨지면 리소스 사용 중단
- **백그라운드 모드**: 필요시 저빈도 업데이트 모드 제공
- **자동 재개**: 창 활성화시 자동으로 실시간 모드 복원

### 6. 동적 레이아웃 관리
- **리사이즈 대응**: 창 크기 변경시 자동으로 비율 유지
- **최소 크기**: 각 패널별 최소 크기 설정
- **분할 드래그**: 패널간 경계선 드래그로 비율 조정 가능
- **레이아웃 저장**: 사용자 레이아웃 설정 저장/복원

## 🛠️ 기술적 요구사항

### 1. 데이터 소스
- **Market Data DB**: `data/market_data.sqlite3`
- **실시간 API**: Upbit REST API
- **실시간 WebSocket**: Upbit WebSocket
- **마켓 데이터 백본**: 통합 데이터 관리 시스템

### 2. 마켓 데이터 백본 시스템
#### 2.1 데이터 수집 엔진
- **멀티 소스 수집**: API + WebSocket 동시 수집
- **데이터 검증**: 중복 제거, 무결성 검사
- **실시간 동기화**: 실시간 데이터와 히스토리 데이터 일관성
- **타임프레임 변환**: 1분 → 3분, 5분, 15분... 자동 변환

#### 2.2 캐싱 및 저장소
- **메모리 캐시**: Redis 스타일 인메모리 캐시
- **DB 저장소**: SQLite 기반 영구 저장
- **압축 저장**: 대용량 데이터 압축 저장
- **인덱싱**: 빠른 범위 검색을 위한 인덱스

#### 2.3 리소스 관리
- **구독 모델**: 차트뷰 창별 데이터 구독/해제
- **라이프사이클**: 창 상태에 따른 자동 리소스 관리
- **백그라운드 수집**: 최소한의 백그라운드 데이터 수집
- **메모리 제한**: 설정된 메모리 한계 내에서 동작

### 3. 플롯팅 라이브러리 검토
#### PyQt6 호환 차트 라이브러리:
1. **PyQtGraph** ⭐ (추천)
   - 고성능 실시간 플롯팅
   - PyQt6 네이티브 통합
   - 캔들스틱, 호가창 구현 가능
   - 확대/축소, 스크롤 내장

2. **Matplotlib + Qt Backend**
   - 풍부한 차트 옵션
   - 기술적 지표 라이브러리 다양
   - 상대적으로 무거움

3. **PlotlyQt**
   - 인터랙티브한 차트
   - 웹 기반 렌더링
   - 호가창 구현 복잡

### 4. 아키텍처 구조 (동적 시스템 설계)
```
presentation/
├── chart_viewer/
│   ├── views/
│   │   ├── chart_viewer_window.py        # 메인 윈도우 (3열 레이아웃)
│   │   ├── coin_list_view.py             # 코인 리스트 (1 비율)
│   │   ├── chart_area_view.py            # 차트 영역 (4 비율)
│   │   ├── orderbook_view.py             # 호가창 (2 비율)
│   │   └── control_panel_view.py         # 상단 컨트롤
│   ├── presenters/
│   │   ├── window_lifecycle_presenter.py # 창 상태 관리
│   │   ├── chart_presenter.py            # 차트 로직
│   │   ├── coin_list_presenter.py        # 리스트 로직
│   │   ├── orderbook_presenter.py        # 호가창 로직
│   │   └── resource_manager.py           # 리소스 관리
│   └── widgets/
│       ├── dynamic_splitter.py           # 동적 스플리터
│       ├── candlestick_widget.py         # 캔들차트 위젯
│       ├── subplot_widget.py             # 서브플롯 위젯
│       └── orderbook_widget.py           # 호가창 위젯

application/
├── market_data_backbone/
│   ├── data_collection_service.py        # 데이터 수집 엔진
│   ├── cache_manager.py                  # 캐싱 시스템
│   ├── subscription_manager.py           # 구독 관리
│   └── lifecycle_manager.py              # 라이프사이클 관리
├── chart_service.py                      # 차트 데이터 서비스
└── realtime_service.py                   # 실시간 데이터 관리

infrastructure/
├── market_data_backbone/
│   ├── data_collector.py                 # 멀티소스 수집기
│   ├── memory_cache.py                   # 인메모리 캐시
│   ├── timeframe_converter.py            # 타임프레임 변환
│   └── resource_monitor.py               # 리소스 모니터링
├── chart_data_repository.py             # DB 차트 데이터
├── upbit_market_api.py                   # 마켓 API
├── upbit_websocket_client.py             # WebSocket 클라이언트
└── technical_indicators.py              # 기술적 지표 계산
```

## 📋 구현 단계별 계획

### Phase 0: 호가창 우선 개발 및 이벤트 버스 확장 (2-3일)
- [ ] 기존 InMemoryEventBus와 호환성 검증
- [ ] OrderbookEvent 타입 추가 (우선순위 5,8,10)
- [ ] 호가창 기본 UI 구현 (실시간 표시)
- [ ] 업비트 호가 웹소켓 연동
- [ ] 호가 모아보기 기능 구현
- [ ] 호가창 전용 이벤트 핸들러 구현

### Phase 1: 마켓 데이터 백본 구축 (3-4일)
- [ ] 기존 시스템과 연동되는 데이터 수집 엔진 구현
- [ ] 멀티소스 데이터 동기화 (1M 포함)
- [ ] 메모리 캐시 시스템
- [ ] 타임프레임 변환 로직 (1M 지원)
- [ ] 구독/해제 관리 시스템

### Phase 2: 기본 UI 및 동적 레이아웃 (2-3일)
- [ ] 3열 동적 스플리터 레이아웃 (1:4:2)
- [ ] 창 상태 기반 리소스 관리
- [ ] 코인 리스트 기본 UI
- [ ] 호가창 기본 UI
- [ ] 레이아웃 저장/복원

### Phase 3: 5개 고정 서브플롯 차트 엔진 (3-4일)
- [ ] PyQtGraph 기반 캔들스틱 차트
- [ ] 200개 초기 데이터 로딩
- [ ] 5개 서브플롯 고정 구성 (Volume, MACD, RSI, STOCH, ATR)
- [ ] 4:1:1:1:1:1 비율 동적 레이아웃
- [ ] 타임프레임 선택 (1M 포함)
- [ ] 마우스 상호작용

### Phase 4: 실시간 연동 및 백본 통합 (3-4일)
- [ ] 백본과 차트뷰 연동
- [ ] 실시간 캔들 업데이트
- [ ] 호가창 실시간 업데이트
- [ ] 창 활성화 상태별 리소스 제어
- [ ] API/WebSocket 하이브리드 모드

### Phase 5: 코인 리스트 및 차트 완성 (2-3일)
- [ ] 마켓 선택 및 검색 필터
- [ ] 즐겨찾기 기능
- [ ] 동적 차트 패키지 검토 및 교체 (필요시)
- [ ] 호가 클릭 이벤트

### Phase 6: 고급 기능 및 최적화 (4-5일)
- [ ] 기술적 지표 세부 구현 (5개 서브플롯)
- [ ] 이동평균선, 볼린저밴드 (메인 플롯 오버레이)
- [ ] 성능 최적화 및 메모리 관리
- [ ] 동적 차트 라이브러리 최종 검토
- [ ] 에러 처리 강화

### Phase 7: 테스트 및 안정화 (2-3일)
- [ ] 마켓 데이터 백본 스트레스 테스트
- [ ] 장시간 실행 안정성 테스트
- [ ] 메모리 누수 검사
- [ ] 동적 레이아웃 테스트
- [ ] 문서화

## 🔍 추가 기술 조사 필요 사항

### 1. 타임프레임 지원 조사
- **1개월 타임프레임**: Upbit API 지원 확인 (WebSocket 미지원시 API 사용)
- **하이브리드 모드**: WebSocket 미지원시 API 폴링으로 대체
- **데이터 변환**: 1일 → 1주 → 1개월 자동 변환 로직
- **기존 이벤트 버스**: InMemoryEventBus 확장으로 안전한 통합

### 2. 마켓 데이터 백본 설계
- **기존 시스템 호환**: InMemoryEventBus 확장으로 안전한 통합
- **실시간 동기화**: WebSocket + API 데이터 일관성
- **메모리 관리**: 대량 히스토리 데이터 효율적 관리
- **구독 모델**: 차트뷰별 독립적 데이터 구독
- **생명주기**: 창 상태에 따른 자동 리소스 관리

### 2. 호가창 구현 방법 (우선 개발)
- PyQtGraph에서 실시간 바 차트 구현
- 매수/매도 호가 색상 구분
- 호가량에 따른 시각적 표현
- 실시간 호가 업데이트 성능 최적화
- 업비트 호가 모아보기 기능 활용
- 호가 단위 정책 적용 (docs/UPBIT_ORDERBOOK_API_GUIDE.md 참고)

### 3. 동적 차트 라이브러리 검토
- **현재 선택**: PyQtGraph (실시간 성능 우수)
- **대안 검토**: PlotlyQt, Matplotlib + Qt Backend
- **성능 요구사항**: 5개 서브플롯 동시 렌더링
- **동적 변화 지원**: 확대/축소, 스크롤 최적화
- **교체 가능성**: Phase 5에서 성능 이슈 시 검토

### 4. 동적 레이아웃 시스템 (4:1:1:1:1:1 비율)
- **메인 플롯**: 4 비율 (캔들스틱 + 오버레이)
- **5개 서브플롯**: 각 1 비율 (Volume, MACD, RSI, STOCH, ATR)
- **최소 크기**: 각 서브플롯별 최소 높이 보장
- **리사이즈 이벤트**: 창 크기 변경시 비율 자동 조정
- **상태 저장**: 사용자 레이아웃 설정 영구 저장
### 5. 성능 최적화
- 대량 캔들 데이터 렌더링 최적화
- 창 상태별 리소스 사용량 제어
- 백본 시스템과 차트뷰 메모리 공유 최적화

### 6. 기술적 지표 라이브러리
- TA-Lib vs pandas-ta 비교
- PyQtGraph와의 통합 방법

## 🎯 성공 기준
1. **3열 레이아웃**: 1:4:2 비율의 동적 레이아웃 정상 동작
2. **호가창 우선 완성**: 실시간 호가 표시 및 호가 모아보기 기능
3. **5개 서브플롯**: 4:1:1:1:1:1 비율로 Volume, MACD, RSI, STOCH, ATR 고정 표시
4. **기존 시스템 호환**: InMemoryEventBus 확장으로 매매 시스템 영향 없음
5. **마켓 데이터 백본**: 통합 데이터 관리 시스템 안정적 동작
6. **리소스 관리**: 창 비활성화시 리소스 사용량 90% 이상 감소
7. **실시간 연동**: WebSocket/API 하이브리드 모드 정상 동작
8. **타임프레임**: 1M 포함 모든 타임프레임 지원
9. **호가창 검증**: API/웹소켓 동작 완전 검증으로 실제 매매 준비
10. **성능**: 60fps 이상 부드러운 차트 업데이트 유지 (5개 서브플롯 포함)

---
*첨부된 업비트 차트 화면을 참고하여 유사한 UX 구현 목표*
