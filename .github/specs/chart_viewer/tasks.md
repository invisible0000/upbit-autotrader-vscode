# 차트뷰어 구현 태스크

## 🎯 구현 전략

기존 InMemoryEventBus 시스템을 안전하게 확장하여 호환성 보장. 기존 매매 시스템에 영향을 주지 않으면서 차트뷰어 기능 추가. 1개월 타임프레임까지 지원하도록 구현. Phase 0에서 기존 시스템 확장, Phase 1~3은 핵심 기능, Phase 4~7은 UI 완성도 집중.

## 📋 구현 태스크

### Phase 0: 기존 이벤트 버스 시스템 안전 확장 (1-2일)

- [x] 0.1 기존 InMemoryEventBus 호환성 확장
  - [x] ChartViewerEvent 타입 추가 (기존 DomainEvent 상속)
  - [x] ChartViewerPriority 상수 정의 (기존 priority 범위 내)
  - [x] 기존 subscribe/publish 메서드 활용
  - [x] 기존 시스템과 완전 격리된 차트뷰어 이벤트 처리
  - _검증: 기존 매매 시스템 영향 없음 확인 ✅_

- [x] 0.2 창 상태 기반 우선순위 관리 시스템
  - [x] ChartViewerResourceManager 구현 (기존 시스템 독립)
  - [x] WindowLifecycleManager 구현 (기존 이벤트 버스 활용)
  - [x] 창 상태별 우선순위 자동 조정 (5→8→10 범위)
  - [x] 기존 시스템과 리소스 격리
  - _검증: 우선순위 변경이 기존 시스템에 영향 없음 ✅_

- [x] 0.3 1개월 타임프레임 지원 시스템
  - [x] TimeframeSupport 클래스 구현
  - [x] 1w, 1M 타임프레임 API 전용 처리
  - [x] WebSocket/API 하이브리드 모드 구현
  - [x] 기존 타임프레임과 호환성 보장
  - _검증: 모든 타임프레임 (1m~1M) 데이터 수집 가능 ✅_

- [x] 0.4 기존 시스템 안전성 검증
  - [x] 기존 매매 엔진과 동시 실행 테스트
  - [x] 메모리/CPU 사용량 영향 측정 (메모리 0.07MB 증가, CPU 7.80%)
  - [x] 이벤트 처리 성능 영향 분석 (InMemoryEventBus 정상 동작)
  - [x] 기존 기능 동작 무결성 확인 (호환성 테스트 6/6 통과)
  - _검증: 기존 시스템 100% 정상 동작 보장 ✅_

### Phase 1: 마켓 데이터 백본 구축 (3-4일)

- [x] 1.1 기존 호환 데이터 수집 엔진 구현
  - [x] 기존 이벤트 시스템 활용한 MarketDataEventHandler
  - [x] 멀티소스 수집기 (API + WebSocket, 1개월 포함)
  - [x] 데이터 검증 및 중복 제거 로직
  - [x] 타임프레임 변환 엔진 (1분→1개월)
  - [x] 기존 DomainEvent 상속 이벤트 발행
  - _검증: 1분 데이터로 1개월 캔들 생성 + 기존 시스템 영향 없음 ✅_

- [x] 1.2 기존 호환 메모리 캐시 시스템 구현
  - [x] 기존 인프라와 호환되는 캐시 시스템 (ChartMemoryCache)
  - [x] LRU 정책 기반 메모리 관리 (차트뷰어 전용 256MB 할당)
  - [x] 압축 저장 및 빠른 범위 검색 (gzip 압축, OrderedDict)
  - [x] 기존 시스템과 메모리 격리 (타임프레임별 분리 캐시)
  - [x] 리소스 모니터 연동 (실시간 성능 추적)
  - _검증: 캐시 성능 향상, 기존 시스템 메모리 영향 없음 ✅_

- [x] 1.3 기존 호환 구독 관리 시스템 구현
  - [x] 기존 InMemoryEventBus 구독 시스템 활용 (SubscriptionManager)
  - [x] 차트뷰별 독립적 데이터 구독/해제 (심볼별 타임프레임별)
  - [x] 기존 priority 시스템과 호환되는 우선순위 관리 (LOW~CRITICAL)
  - [x] 중복 구독 방지 및 리소스 공유 (자동 통합 및 해제)
  - [x] 유휴 구독 자동 해제 및 백그라운드 정리
  - _검증: 기존 구독과 격리된 차트뷰 구독/해제 ✅_

- [x] 1.4 DB 통합 및 영구 저장 (기존 호환)
  - [x] 기존 `data/market_data.sqlite3` 활용
  - [x] 1개월 캔들 데이터 스키마 확장
  - [x] 기존 히스토리 데이터와 호환성 보장
  - [x] 실시간 데이터와 히스토리 동기화
  - _검증: 1개월 캔들 포함 모든 데이터 1초 내 로딩 ✅_

### Phase 2: 기본 UI 및 동적 레이아웃 (2-3일)

- [ ] 2.1 메인 윈도우 및 3열 스플리터 구현
  - [ ] ChartViewerWindow 기본 구조 (1:4:2 비율)
  - [ ] 동적 스플리터 (QSplitter 기반)
  - [ ] 최소 크기 제한 및 리사이즈 대응
  - [ ] 레이아웃 저장/복원 기능
  - _검증: 창 크기 변경시 비율 유지_

- [ ] 2.2 창 상태 기반 리소스 관리 구현
  - [ ] WindowLifecyclePresenter 구현
  - [ ] 활성화/비활성화 상태 감지
  - [ ] 최소화/복원 이벤트 처리
  - [ ] 백그라운드 모드 리소스 제어 (90% 절약)
  - _검증: 창 비활성화시 리소스 사용량 확인_

- [ ] 2.3 코인 리스트 기본 UI 구현
  - [ ] 마켓 선택 (KRW/BTC/USDT)
  - [ ] 검색 필터 및 클리어 버튼
  - [ ] 즐겨찾기 기능 (더블클릭 ⭐)
  - [ ] 심벌 + 코인명 표시
  - _검증: 마켓 선택 및 즐겨찾기 동작_

- [ ] 2.4 호가창 기본 UI 구현
  - [ ] 매수/매도 호가 구분 표시
  - [ ] 실시간 호가 데이터 표시
  - [ ] 기본 색상 구분 (매수/매도)
  - [ ] 호가 클릭 이벤트 처리
  - _검증: 실시간 호가 업데이트_

### Phase 3: PyQtGraph 차트 엔진 (3-4일)

- [ ] 3.1 PyQtGraph 기반 캔들스틱 차트 구현
  - [ ] CandlestickWidget 기본 구조
  - [ ] OHLC 데이터 시각화
  - [ ] 200개 초기 데이터 로딩
  - [ ] 마우스 휠 확대/축소
  - _검증: 캔들스틱 차트 렌더링_

- [ ] 3.2 서브플롯 및 기술적 지표 구현
  - [ ] 거래량 서브플롯 (기본)
  - [ ] MACD, RSI, ATR, STOCH 선택 가능
  - [ ] 이동평균선 오버레이 (SMA, EMA)
  - [ ] 볼린저밴드 오버레이
  - _검증: 지표 전환 및 오버레이_

- [ ] 3.3 차트 상호작용 구현
  - [ ] 좌우 스크롤 (과거/미래 데이터)
  - [ ] 자동 데이터 로딩 (스크롤시)
  - [ ] 확대/축소 상태 유지
  - [ ] 차트 경계 처리
  - _검증: 부드러운 스크롤 및 확대/축소_

- [ ] 3.4 타임프레임 선택 구현 (1개월 포함)
  - [ ] 콤보박스 (1m, 3m, 5m, 15m, 30m, 1h, 4h, 1d, 1w, 1M)
  - [ ] 1개월 타임프레임 API 전용 처리
  - [ ] 타임프레임 변경시 데이터 재로딩
  - [ ] 현재 선택 상태 유지
  - [ ] 기존 백본 시스템과 연동
  - _검증: 1개월 포함 모든 타임프레임 정상 동작_

### Phase 4: 실시간 연동 및 기존 시스템 통합 (3-4일)

- [ ] 4.1 기존 이벤트 버스 기반 차트뷰 연동 구현
  - [ ] ChartPresenter와 기존 InMemoryEventBus 연결
  - [ ] ChartViewerEvent 기반 데이터 수신
  - [ ] 실시간 캔들 업데이트 (기존 시스템과 격리)
  - [ ] 데이터 소스 선택 (WebSocket/API) 안전 처리
  - _검증: 실시간 캔들 업데이트 60fps + 기존 시스템 영향 없음_

- [ ] 4.2 기존 호환 호가창 실시간 연동 구현
  - [ ] OrderbookPresenter 기존 이벤트 핸들러 활용
  - [ ] 기존 DomainEvent 상속 orderbook 이벤트 구독
  - [ ] 호가량 바차트 (기존 시스템과 독립적 업데이트)
  - [ ] 누적 수량 표시 (기존 시스템 격리)
  - _검증: 실시간 호가 업데이트 + 기존 시스템과 리소스 격리_

- [ ] 4.3 하이브리드 모드 안전 처리 구현
  - [ ] WebSocket 80% + API 20% 안전 연동
  - [ ] 데이터 소스 체크박스 UI (기존 시스템 독립)
  - [ ] 1개월 타임프레임 API 전용 처리
  - [ ] 데이터 일관성 검증 (기존 데이터와 격리)
  - _검증: 모든 타임프레임 하이브리드 모드 + 기존 시스템 영향 없음_

- [ ] 4.4 창 상태별 안전한 리소스 제어 구현
  - [ ] WindowLifecycleManager 기존 이벤트 시스템 활용
  - [ ] 활성화: 우선순위 5 (기존 범위 내)
  - [ ] 비활성화: 우선순위 8 (기존 시스템 영향 없음)
  - [ ] 최소화: 우선순위 10 (최하위)
  - [ ] 기존 매매 우선순위 1-3 보장
  - _검증: 우선순위 제어가 기존 시스템에 영향 없음_

### Phase 5: 고급 기능 및 최적화 (4-5일)

- [ ] 5.1 고급 기술적 지표 구현
  - [ ] MACD, RSI, ATR, STOCH 계산
  - [ ] 다중 이동평균선 (5, 20, 60일)
  - [ ] 볼린저밴드 (20일 기준)
  - [ ] 지표 조합 및 파라미터 설정
  - _검증: 모든 지표 정확성 확인_

- [ ] 5.2 성능 최적화 구현
  - [ ] 대량 캔들 데이터 렌더링 최적화
  - [ ] 메모리 사용량 모니터링
  - [ ] 불필요한 리렌더링 방지
  - [ ] GPU 가속 활용 (가능한 경우)
  - _검증: 60fps 유지, 메모리 200MB 이하_

- [ ] 5.3 즐겨찾기 고급 기능 구현
  - [ ] 즐겨찾기 상단 고정
  - [ ] 필터 무시 로직
  - [ ] 즐겨찾기 그룹 관리
  - [ ] 설정 저장/복원
  - _검증: 즐겨찾기 우선 표시_

- [ ] 5.4 에러 처리 강화
  - [ ] 네트워크 연결 실패 대응
  - [ ] 데이터 파싱 오류 처리
  - [ ] 사용자 친화적 오류 메시지
  - [ ] 자동 복구 메커니즘
  - _검증: 오류 상황 시뮬레이션_

### Phase 6: UI 완성도 및 사용성 (2-3일)

- [ ] 6.1 코인 리스트 완성
  - [ ] 검색 필터 고도화
  - [ ] 코인명 + 심벌 표시 개선
  - [ ] 마켓별 색상 구분
  - [ ] 로딩 상태 표시
  - _검증: 직관적인 코인 선택_

- [ ] 6.2 호가창 시각화 완성
  - [ ] 호가량에 따른 바차트
  - [ ] 매수/매도 색상 구분
  - [ ] 가격 클릭시 상세 정보
  - [ ] 호가 스프레드 표시
  - _검증: 호가창 사용성_

- [ ] 6.3 차트 UX 개선
  - [ ] 툴팁 및 십자선 표시
  - [ ] 가격/시간 축 포맷팅
  - [ ] 차트 테마 및 색상
  - [ ] 범례 및 라벨링
  - _검증: 전문적인 차트 외관_

- [ ] 6.4 컨트롤 패널 완성
  - [ ] 타임프레임 선택 UI 개선
  - [ ] 데이터 소스 선택 체크박스
  - [ ] 상태 표시 및 진행바
  - [ ] 설정 저장/로드
  - _검증: 직관적인 컨트롤_

### Phase 7: 테스트 및 안정화 (2-3일)

- [ ] 7.1 마켓 데이터 백본 스트레스 테스트
  - [ ] 대량 구독 처리 테스트
  - [ ] 메모리 누수 검사
  - [ ] 장시간 실행 안정성
  - [ ] 리소스 모니터링
  - _검증: 24시간 연속 동작_

- [ ] 7.2 UI 통합 테스트
  - [ ] 다중 창 동시 사용
  - [ ] 창 상태 변경 테스트
  - [ ] 레이아웃 리사이즈 테스트
  - [ ] 사용자 시나리오 검증
  - _검증: 실제 사용 시나리오_

- [ ] 7.3 성능 벤치마크
  - [ ] 렌더링 fps 측정
  - [ ] 메모리 사용량 프로파일링
  - [ ] 네트워크 효율성 측정
  - [ ] 캐시 히트율 확인
  - _검증: 성능 목표 달성_

- [ ] 7.4 문서화 및 가이드
  - [ ] 사용자 가이드 작성
  - [ ] 개발자 문서 업데이트
  - [ ] 설치 및 설정 가이드
  - [ ] 문제 해결 가이드
  - _검증: 문서 완성도_

## 🎯 단계별 검증 기준

### Phase 0 완료 기준
- [x] 기존 InMemoryEventBus 확장이 기존 시스템에 영향 없음
- [x] 차트뷰어 우선순위(5,8,10)가 기존 우선순위(1-3)와 격리됨
- [x] 1개월 타임프레임 포함 모든 데이터 수집 가능
- [x] 기존 매매 엔진 100% 정상 동작 보장

### Phase 1 완료 기준
- [x] 1분 데이터로 1개월 캔들 변환 + 기존 시스템 영향 없음
- [x] 캐시 성능 향상, 기존 메모리 사용량 영향 없음 (LRU+압축+격리)
- [x] 기존 구독과 격리된 차트뷰 구독/해제 동작 (독립 구독 관리)
- [x] 1개월 캔들 포함 모든 데이터 1초 내 로딩 (Phase 1.4 DB 통합 완료 ✅)

### Phase 2 완료 기준
- [ ] 3열 레이아웃 1:4:2 비율 유지
- [ ] 창 비활성화시 우선순위 자동 조정 (기존 시스템 영향 없음)
- [ ] 코인 리스트 기본 기능 동작
- [ ] 호가창 실시간 표시

### Phase 3 완료 기준
- [ ] PyQtGraph 캔들스틱 렌더링 (기존 시스템과 독립)
- [ ] 기술적 지표 오버레이 동작
- [ ] 마우스 상호작용 정상
- [ ] 1개월 포함 모든 타임프레임 지원

### Phase 4 완료 기준
- [ ] 실시간 캔들 업데이트 60fps + 기존 시스템 영향 없음
- [ ] 호가창 실시간 업데이트 + 기존 시스템과 리소스 격리
- [ ] 모든 타임프레임 하이브리드 모드 + 기존 시스템 영향 없음
- [ ] 우선순위 제어가 기존 시스템에 영향 없음

### Phase 5 완료 기준
- [ ] 모든 기술적 지표 정확성
- [ ] 기존 시스템과 격리된 성능 목표 달성
- [ ] 즐겨찾기 우선 표시
- [ ] 기존 시스템과 독립적인 에러 처리

### Phase 6 완료 기준
- [ ] 직관적인 UI/UX
- [ ] 전문적인 차트 외관
- [ ] 호가창 사용성
- [ ] 설정 저장/로드

### Phase 7 완료 기준
- [ ] 24시간 연속 동작 안정성
- [ ] 기존 매매 엔진과 동시 동작 무결성 검증
- [ ] 모든 성능 목표 달성 (기존 시스템 영향 없음)
- [ ] 1개월 타임프레임 포함 완전 동작
- [ ] 완전한 문서화

## 🚀 최종 성공 기준

1. **기존 시스템 완전 호환성**: 매매 엔진 등 기존 기능 100% 정상 동작
2. **안전한 이벤트 시스템 확장**: InMemoryEventBus 확장이 기존 시스템에 영향 없음
3. **우선순위 기반 격리**: 차트뷰어(5,8,10)와 기존 우선순위(1-3) 완전 분리
4. **1개월 타임프레임 지원**: 1m~1M 모든 타임프레임 완전 동작
5. **3열 동적 레이아웃**: 1:4:2 비율, 리사이즈 대응
6. **마켓 데이터 백본**: 멀티소스 수집, 통합 관리 (기존 시스템과 호환)
7. **실시간 성능**: 60fps 차트, 부드러운 호가창 (기존 시스템 영향 없음)
8. **안정성**: 24시간 연속 동작 무결성
9. **사용성**: 직관적 UI, 전문적 차트 품질
10. **완전한 격리**: 차트뷰어 오류가 기존 시스템에 영향 없음

---
*DDD 아키텍처, Infrastructure v4.0 로깅, 기존 InMemoryEventBus 확장, 완전 호환성 보장 원칙 준수*
