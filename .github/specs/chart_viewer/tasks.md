# 차트뷰어 구현 태스크

## 🎯 구현 전략

기존 InMemoryEventBus 시스템을 안전하게 확장하여 호환성 보장. 기존 매매 시스템에 영향을 주지 않으면서 **호가창을 우선 개발**하여 API/웹소켓의 원활한 동작을 검증하고 실제 매매 시 주문이 원활하도록 지원. 차트는 메인 플롯 + 5개 서브플롯(4:1:1:1:1:1 비율)으로 구성. Phase 0에서 호가창 우선 구현, Phase 1~3은 핵심 기능, Phase 4~7은 UI 완성도 집중.

## 📋 구현 태스크

### Phase 0: 호가창 우선 개발 및 이벤트 버스 안전 확장 (2-3일)

- [ ] 0.1 호가창 우선 구현을 위한 기존 InMemoryEventBus 확장
  - [ ] OrderbookEvent 타입 추가 (기존 DomainEvent 상속)
  - [ ] ChartViewerPriority에 ORDERBOOK_HIGH = 5 추가
  - [ ] 기존 subscribe/publish 메서드 활용한 호가 이벤트 처리
  - [ ] 기존 시스템과 완전 격리된 호가창 이벤트 처리
  - _검증: 기존 매매 시스템 영향 없음 + 호가 이벤트 격리 ✅_

- [ ] 0.2 업비트 호가 웹소켓 연동 및 API 검증
  - [ ] 업비트 호가 웹소켓 클라이언트 구현
  - [ ] 호가 모아보기 기능 구현 (docs/UPBIT_ORDERBOOK_API_GUIDE.md 참고)
  - [ ] 호가 정책 조회 API 연동
  - [ ] 실시간 호가 데이터 수신 및 파싱
  - [ ] 웹소켓 연결 안정성 및 재연결 로직
  - _검증: 모든 마켓 호가 데이터 실시간 수신 + API 안정성 ✅_

- [ ] 0.3 호가창 기본 UI 구현 (우선 개발)
  - [ ] OrderbookWidget 기본 구조 (PyQtGraph 기반)
  - [ ] 실시간 매수/매도 호가 표시
  - [ ] 호가량에 따른 바차트 시각화
  - [ ] 매수/매도 색상 구분 및 호가 스프레드 표시
  - [ ] 30개 호가 쌍 표시 및 누적 수량 계산
  - _검증: 실시간 호가 업데이트 및 시각화 완성 ✅_

- [ ] 0.4 호가창과 기존 시스템 안전성 검증
  - [ ] 호가창과 기존 매매 엔진 동시 실행 테스트
  - [ ] 호가 이벤트 처리가 기존 이벤트에 영향 없음 확인
  - [ ] 호가창 리소스 사용량 측정 및 격리 확인
  - [ ] API/웹소켓 동작 검증으로 실제 매매 준비도 확인
  - _검증: 호가창 완전 격리 + 실제 매매 API 안정성 보장 ✅_

### Phase 1: 마켓 데이터 백본 구축 (3-4일)

- [x] 1.1 기존 호환 데이터 수집 엔진 구현
  - [x] 기존 이벤트 시스템 활용한 MarketDataEventHandler
  - [x] 멀티소스 수집기 (API + WebSocket, 1개월 포함)
  - [x] 데이터 검증 및 중복 제거 로직
  - [x] 타임프레임 변환 엔진 (1분→1개월)
  - [x] 기존 DomainEvent 상속 이벤트 발행
  - _검증: 1분 데이터로 1개월 캔들 생성 + 기존 시스템 영향 없음 ✅_

- [x] 1.2 기존 호환 메모리 캐시 시스템 구현
  - [x] 기존 인프라와 호환되는 캐시 시스템 (ChartMemoryCache)
  - [x] LRU 정책 기반 메모리 관리 (차트뷰어 전용 256MB 할당)
  - [x] 압축 저장 및 빠른 범위 검색 (gzip 압축, OrderedDict)
  - [x] 기존 시스템과 메모리 격리 (타임프레임별 분리 캐시)
  - [x] 리소스 모니터 연동 (실시간 성능 추적)
  - _검증: 캐시 성능 향상, 기존 시스템 메모리 영향 없음 ✅_

- [x] 1.3 기존 호환 구독 관리 시스템 구현
  - [x] 기존 InMemoryEventBus 구독 시스템 활용 (SubscriptionManager)
  - [x] 차트뷰별 독립적 데이터 구독/해제 (심볼별 타임프레임별)
  - [x] 기존 priority 시스템과 호환되는 우선순위 관리 (LOW~CRITICAL)
  - [x] 중복 구독 방지 및 리소스 공유 (자동 통합 및 해제)
  - [x] 유휴 구독 자동 해제 및 백그라운드 정리
  - _검증: 기존 구독과 격리된 차트뷰 구독/해제 ✅_

- [x] 1.4 DB 통합 및 영구 저장 (기존 호환)
  - [x] 기존 `data/market_data.sqlite3` 활용
  - [x] 1개월 캔들 데이터 스키마 확장
  - [x] 기존 히스토리 데이터와 호환성 보장
  - [x] 실시간 데이터와 히스토리 동기화
  - _검증: 1개월 캔들 포함 모든 데이터 1초 내 로딩 ✅_

### Phase 2: 기본 UI 및 동적 레이아웃 (2-3일)

- [x] 2.1 메인 윈도우 및 3열 스플리터 구현
  - [x] ChartViewerWindow 기본 구조 (1:4:2 비율)
  - [x] 동적 스플리터 (QSplitter 기반)
  - [x] 최소 크기 제한 및 리사이즈 대응
  - [x] 레이아웃 저장/복원 기능
  - _검증: 창 크기 변경시 비율 유지 ✅_

- [x] 2.2 창 상태 기반 리소스 관리 구현
  - [x] WindowLifecyclePresenter 구현
  - [x] 활성화/비활성화 상태 감지
  - [x] 최소화/복원 이벤트 처리
  - [x] 백그라운드 모드 리소스 제어 (90% 절약)
  - _검증: 창 비활성화시 리소스 사용량 확인 ✅_

- [x] 2.3 코인 리스트 기본 UI 구현
  - [x] 마켓 선택 (KRW/BTC/USDT)
  - [x] 검색 필터 및 클리어 버튼
  - [x] 즐겨찾기 기능 (더블클릭 ⭐)
  - [x] 심벌 + 코인명 표시
  - [x] 실제 업비트 API 연동 (CoinListService)
  - [x] 실시간 데이터 로드 및 포맷팅
  - ⚠️ _검증: UI 초기화 순서 문제로 데이터 표시 안됨 (해결 필요)_

- [x] 2.4 기본 레이아웃에 호가창 통합
  - [x] 3열 스플리터에 호가창 패널 통합 (2 비율)
  - [x] 호가창과 차트뷰의 독립적 리소스 관리
  - [x] 호가창 상태별 우선순위 조정 연동
  - [x] 전체 레이아웃에서 호가창 최소 크기 보장
  - _검증: 호가창이 포함된 3열 레이아웃 완성 ✅_

### Phase 3: 5개 고정 서브플롯 차트 엔진 (3-4일)

- [ ] 3.1 PyQtGraph 기반 캔들스틱 차트 구현
  - [ ] CandlestickWidget 기본 구조 (메인 플롯 4 비율)
  - [ ] OHLC 데이터 시각화
  - [ ] 200개 초기 데이터 로딩
  - [ ] 마우스 휠 확대/축소
  - _검증: 캔들스틱 차트 렌더링_

- [ ] 3.2 5개 서브플롯 고정 구현 (Volume, MACD, RSI, STOCH, ATR)
  - [ ] MultiSubplotWidget 구조 (각 1 비율)
  - [ ] Volume 거래량 막대 차트
  - [ ] MACD 신호선과 히스토그램
  - [ ] RSI 과매수/과매도 구간
  - [ ] STOCHASTICS %K, %D 라인
  - [ ] ATR 평균 진실 범위
  - _검증: 5개 서브플롯 동시 렌더링_

- [ ] 3.3 차트 상호작용 구현 (동적 차트 패키지 고려)
  - [ ] 좌우 스크롤 (과거/미래 데이터)
  - [ ] 자동 데이터 로딩 (스크롤시)
  - [ ] 확대/축소 상태 유지
  - [ ] 차트 경계 처리
  - [ ] 동적 변화에 최적화된 차트 라이브러리 성능 검토
  - _검증: 부드러운 스크롤 및 확대/축소_

- [ ] 3.4 타임프레임 선택 구현 (1개월 포함)
  - [ ] 콤보박스 (1m, 3m, 5m, 15m, 30m, 1h, 4h, 1d, 1w, 1M)
  - [ ] 1개월 타임프레임 API 전용 처리
  - [ ] 타임프레임 변경시 5개 서브플롯 동시 업데이트
  - [ ] 현재 선택 상태 유지
  - [ ] 기존 백본 시스템과 연동
  - _검증: 1개월 포함 모든 타임프레임 정상 동작_

### Phase 4: 실시간 연동 및 기존 시스템 통합 (3-4일)

- [ ] 4.1 기존 이벤트 버스 기반 차트뷰 연동 구현
  - [ ] ChartPresenter와 기존 InMemoryEventBus 연결
  - [ ] ChartViewerEvent 기반 데이터 수신
  - [ ] 실시간 캔들 업데이트 (기존 시스템과 격리)
  - [ ] 데이터 소스 선택 (WebSocket/API) 안전 처리
  - _검증: 실시간 캔들 업데이트 60fps + 기존 시스템 영향 없음_

- [ ] 4.2 호가창 실시간 연동 완성 (기존 Phase 0 확장)
  - [ ] OrderbookPresenter와 기존 이벤트 핸들러 최적화
  - [ ] 호가 모아보기 기능 실시간 업데이트
  - [ ] 호가량 바차트 성능 최적화 (기존 시스템과 독립적)
  - [ ] 누적 수량 및 스프레드 실시간 계산
  - _검증: 호가창 최종 완성 + 기존 시스템과 리소스 격리_

- [ ] 4.3 하이브리드 모드 안전 처리 구현
  - [ ] WebSocket 80% + API 20% 안전 연동
  - [ ] 데이터 소스 체크박스 UI (기존 시스템 독립)
  - [ ] 1개월 타임프레임 API 전용 처리
  - [ ] 데이터 일관성 검증 (기존 데이터와 격리)
  - _검증: 모든 타임프레임 하이브리드 모드 + 기존 시스템 영향 없음_

- [ ] 4.4 창 상태별 안전한 리소스 제어 구현
  - [ ] WindowLifecycleManager 기존 이벤트 시스템 활용
  - [ ] 활성화: 우선순위 5 (기존 범위 내)
  - [ ] 비활성화: 우선순위 8 (기존 시스템 영향 없음)
  - [ ] 최소화: 우선순위 10 (최하위)
  - [ ] 기존 매매 우선순위 1-3 보장
  - _검증: 우선순위 제어가 기존 시스템에 영향 없음_

### Phase 5: 코인 리스트 및 동적 차트 패키지 검토 (2-3일)

- [ ] 5.1 코인 리스트 완성
  - [ ] 마켓 선택 및 검색 필터
  - [ ] 즐겨찾기 기능
  - [ ] 코인 선택시 호가창 및 차트 동시 업데이트
  - [ ] 실시간 가격 정보 표시
  - _검증: 직관적인 코인 선택_

- [ ] 5.2 동적 차트 패키지 검토 및 교체 (필요시)
  - [ ] PyQtGraph 성능 평가 (5개 서브플롯 동시 렌더링)
  - [ ] 동적 변화 지원 정도 확인
  - [ ] 대안 라이브러리 검토 (PlotlyQt, Matplotlib + Qt Backend)
  - [ ] 성능 이슈 시 차트 패키지 교체 결정
  - _검증: 최적의 차트 라이브러리 선택_

- [ ] 5.3 호가 클릭 이벤트 및 상세 기능
  - [ ] 호가 가격 클릭시 상세 정보 표시
  - [ ] 호가창과 차트 연동 (가격선 표시)
  - [ ] 호가 분석 도구 (스프레드, 누적량 등)
  - [ ] 호가 알림 기능 (선택사항)
  - _검증: 호가창 고급 기능 완성_

- [ ] 5.4 전체 시스템 통합 테스트
  - [ ] 호가창 + 차트 + 코인리스트 통합 동작
  - [ ] 실시간 데이터 동기화 확인
  - [ ] 성능 측정 및 최적화
  - [ ] 기존 시스템과의 완전 격리 재확인
  - _검증: 전체 시스템 안정성_

### Phase 6: 고급 기능 및 최적화 (4-5일)

- [ ] 6.1 5개 서브플롯 기술적 지표 세부 구현
  - [ ] Volume: 거래량 막대 + 이동평균
  - [ ] MACD: 신호선, 히스토그램, 다이버전스
  - [ ] RSI: 과매수/과매도 구간, 다이버전스
  - [ ] STOCHASTICS: %K, %D 라인, 시그널
  - [ ] ATR: 변동성 구간, 트렌드 분석
  - _검증: 모든 지표 정확성 및 시각화 확인_

- [ ] 6.2 메인 플롯 오버레이 지표 구현
  - [ ] 다중 이동평균선 (5, 20, 60일 SMA/EMA)
  - [ ] 볼린저밴드 (20일 기준)
  - [ ] 지지/저항선 자동 감지
  - [ ] 지표 조합 및 파라미터 설정
  - _검증: 메인 차트 오버레이 완성_

- [ ] 6.3 성능 최적화 (5개 서브플롯 특화)
  - [ ] 5개 서브플롯 동시 렌더링 최적화
  - [ ] 메모리 사용량 모니터링 (서브플롯별)
  - [ ] 불필요한 리렌더링 방지
  - [ ] 동적 차트 라이브러리 최종 성능 검증
  - _검증: 60fps 유지, 메모리 256MB 이하_

- [ ] 6.4 에러 처리 강화
  - [ ] 호가 웹소켓 연결 실패 대응
  - [ ] 차트 데이터 파싱 오류 처리
  - [ ] 사용자 친화적 오류 메시지
  - [ ] 자동 복구 메커니즘
  - _검증: 오류 상황 시뮬레이션_

### Phase 7: UI 완성도 및 최종 검증 (2-3일)

- [ ] 7.1 UI 완성도 및 사용성
  - [ ] 호가창 시각화 최종 완성
  - [ ] 차트 UX 개선 (툴팁, 십자선, 테마)
  - [ ] 컨트롤 패널 완성
  - [ ] 전체 UI 일관성 및 반응성
  - _검증: 전문적인 차트 외관_

- [ ] 7.2 호가창 + API/웹소켓 최종 검증
  - [ ] 호가창 24시간 연속 동작 안정성
  - [ ] API/웹소켓 모든 시나리오 테스트
  - [ ] 호가 모아보기 모든 마켓 검증
  - [ ] 실제 매매 환경 시뮬레이션
  - _검증: 실제 매매 API 안정성 100% 보장_

- [ ] 7.3 전체 시스템 통합 테스트
  - [ ] 호가창 + 차트 + 코인리스트 장시간 테스트
  - [ ] 5개 서브플롯 성능 벤치마크
  - [ ] 기존 매매 시스템과 동시 동작 무결성 검증
  - [ ] 동적 차트 라이브러리 최종 성능 확인
  - _검증: 전체 시스템 안정성 및 성능 목표 달성_

- [ ] 7.4 문서화 및 가이드
  - [ ] 호가창 사용자 가이드 작성
  - [ ] 개발자 문서 업데이트 (API/웹소켓 중심)
  - [ ] 설치 및 설정 가이드
  - [ ] 호가 기능 문제 해결 가이드
  - _검증: 완전한 문서화_

## 🎯 단계별 검증 기준

### Phase 0 완료 기준
- [ ] 기존 InMemoryEventBus 확장이 기존 시스템에 영향 없음
- [ ] 호가창 OrderbookEvent 처리가 기존 이벤트와 완전 격리됨
- [ ] **호가창 실시간 표시** 및 **호가 모아보기 기능** 완전 동작
- [ ] 업비트 API/웹소켓 연동 안정성 검증으로 **실제 매매 준비** 완료
- [ ] 호가창 리소스 사용량이 기존 시스템에 영향 없음 확인

### Phase 1 완료 기준
- [x] 1분 데이터로 1개월 캔들 변환 + 기존 시스템 영향 없음
- [x] 캐시 성능 향상, 기존 메모리 사용량 영향 없음 (LRU+압축+격리)
- [x] 기존 구독과 격리된 차트뷰 구독/해제 동작 (독립 구독 관리)
- [x] 1개월 캔들 포함 모든 데이터 1초 내 로딩 (Phase 1.4 DB 통합 완료 ✅)

### Phase 2 완료 기준
- [ ] 3열 레이아웃 1:4:2 비율 유지
- [ ] 창 비활성화시 우선순위 자동 조정 (기존 시스템 영향 없음)
- [ ] 코인 리스트 기본 기능 동작
- [ ] 호가창 실시간 표시

### Phase 3 완료 기준
- [ ] PyQtGraph 기반 캔들스틱 + 5개 서브플롯 렌더링
- [ ] 4:1:1:1:1:1 비율 동적 레이아웃 완성
- [ ] 모든 기술적 지표 (Volume, MACD, RSI, STOCH, ATR) 동시 표시
- [ ] 1개월 포함 모든 타임프레임 지원
- [ ] 동적 차트 라이브러리 성능 검증

### Phase 4 완료 기준
- [ ] 실시간 캔들 업데이트 60fps + 기존 시스템 영향 없음
- [ ] **호가창 최종 완성** + 기존 시스템과 완전 리소스 격리
- [ ] 5개 서브플롯 모든 타임프레임 하이브리드 모드 + 기존 시스템 영향 없음
- [ ] 우선순위 제어가 기존 시스템에 영향 없음

### Phase 5 완료 기준
- [ ] 직관적인 코인 선택 UI
- [ ] **동적 차트 라이브러리** 최종 선택 및 최적화
- [ ] **호가창 고급 기능** 완성 (클릭 이벤트, 상세 정보)
- [ ] 전체 시스템 통합 안정성

### Phase 6 완료 기준
- [ ] **5개 서브플롯** 모든 기술적 지표 정확성 및 시각화
- [ ] **메인 플롯 오버레이** 지표 완성
- [ ] 5개 서브플롯 동시 렌더링 60fps 성능 달성
- [ ] 기존 시스템과 격리된 성능 목표 달성

### Phase 7 완료 기준
- [ ] 직관적인 UI/UX 및 전문적인 차트 외관
- [ ] **호가창 + API/웹소켓 24시간 안정성** 검증으로 **실제 매매 준비** 완료
- [ ] **5개 서브플롯** 성능 벤치마크 및 **동적 차트 라이브러리** 최종 검증
- [ ] 기존 매매 엔진과 동시 동작 무결성 100% 보장
- [ ] 완전한 문서화 (호가 기능 중심)

## 🚀 최종 성공 기준

1. **기존 시스템 완전 호환성**: 매매 엔진 등 기존 기능 100% 정상 동작
2. **호가창 우선 완성**: 실시간 호가 표시, 호가 모아보기, **API/웹소켓 완전 검증**으로 **실제 매매 준비**
3. **5개 서브플롯 차트**: 4:1:1:1:1:1 비율, Volume/MACD/RSI/STOCH/ATR 고정 표시
4. **동적 차트 라이브러리**: 최적의 성능과 동적 변화 지원하는 라이브러리 선택
5. **안전한 이벤트 시스템 확장**: InMemoryEventBus 확장이 기존 시스템에 영향 없음
6. **우선순위 기반 격리**: 호가창/차트뷰어(5,8,10)와 기존 우선순위(1-3) 완전 분리
7. **1개월 타임프레임 지원**: 1m~1M 모든 타임프레임 완전 동작
8. **3열 동적 레이아웃**: 1:4:2 비율, 리사이즈 대응
9. **마켓 데이터 백본**: 멀티소스 수집, 통합 관리 (기존 시스템과 호환)
10. **실시간 성능**: 60fps 차트 + 5개 서브플롯, 부드러운 호가창 (기존 시스템 영향 없음)
11. **안정성**: 24시간 연속 동작 무결성 + **실제 매매 API 안정성** 보장
12. **사용성**: 직관적 UI, 전문적 차트 품질
13. **완전한 격리**: 차트뷰어 오류가 기존 시스템에 영향 없음

---
*DDD 아키텍처, Infrastructure v4.0 로깅, 기존 InMemoryEventBus 확장, 완전 호환성 보장 원칙 준수*
