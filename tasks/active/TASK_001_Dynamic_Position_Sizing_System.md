# 💰 동적 포지션 사이징 시스템 구현

**태스크 ID**: TASK_001  
**생성일**: 2025-07-24  
**우선순위**: 높음  
**담당자**: GitHub Copilot  
**예상 기간**: 4-5일  

## 🎯 목표
고정 → 차등 → 동적 → 수식 기반 매매량 지원 시스템 구축

## 📍 대상 파일
- `upbit_auto_trading/ui/desktop/screens/strategy_management/components/strategy_maker.py`
- 매수/매도 탭 확장

## ⚠️ 중요 설계 원칙: 충돌 방지 시스템

### 🔄 매매량 설정 우선순위 체계
```
1. 포지션 등록 (최우선) > 2. 전략 조합 > 3. 개별 전략 > 4. 시스템 기본값
```

### 🛡️ 충돌 방지 로직
1. **포지션 등록 시**: 기존 전략 매매량 설정 감지 → 확인 알림 → 선택권 제공
2. **전략 조합 시**: 개별 전략의 매매량 연동 자동 비활성화
3. **매매량 연동기**: 전략 조합과 포지션 등록에서 공통 사용

### 📢 사용자 알림 예시
```
⚠️ 포지션 등록 충돌 감지
이미 전략에 설정된 거래량 설정이 존재합니다.

기존 설정: 고정 10% + RSI 기반 조절
새 설정: 변동성 기반 동적 조절

[ 기존 설정 유지 ] [ 새 설정으로 교체 ] [ 취소 ]
```

---

## 📋 Phase 1: 기본 매매량 설정 UI 구현

### ✅ 체크리스트
- [x] **1.1** 매수 탭에 매매량 설정 프레임 추가
- [x] **1.2** 매도 탭에 매매량 설정 프레임 추가  
- [x] **1.3** 기본 설정 모드 선택 (고정/비율/동적)
- [x] **1.4** 고정 금액 입력 위젯
- [x] **1.5** 비율 기반 입력 위젯 (자산 대비 %)
- [x] **1.6** "고급 설정" 버튼 추가
- [x] **1.7** 미리보기 표시 영역
- [x] **1.8** 충돌 감지 함수 구현
- [x] **1.9** 우선순위 검증 로직 구현

### 🔍 **Phase 1 완료 - 사용자 확인 필요**
✅ **Phase 1 구현 완료!** 기본 매매량 설정 UI가 매수/매도 탭에 추가되었습니다.
👀 **확인 요청**: UI 테스트 후 다음 Phase 진행 승인을 요청드립니다.

### 🎨 UI 구성
```
📊 매매량 설정
├── [ 고정 금액 ] [ 비율 기반 ] [ 동적 조절 ]
├── 금액/비율 입력: [____] KRW / %
├── [ 🔧 고급 설정 ] 버튼
└── 📋 현재 설정: "자산의 10% (약 50,000 KRW)"
```

---

## 📋 Phase 2: 심플 등록 시스템 (변수→파라미터→연산→연동)

### ✅ 체크리스트  
- [ ] **2.1** 변수 선택 드롭다운 (RSI, MACD, 볼린저 등)
- [ ] **2.2** 파라미터 매핑 시스템
- [ ] **2.3** 연산자 선택 (곱하기, 나누기, 가중평균)
- [ ] **2.4** 연동 배율 설정 (0.5x ~ 3.0x)
- [ ] **2.5** 실시간 계산 미리보기
- [ ] **2.6** 변수 연결 검증 로직
- [ ] **2.7** 조합 전략 시 자동 비활성화 처리

### 🔧 심플 모드 구성
```
🔗 변수 연동 설정
├── 기준 변수: [RSI 14일 ▼]
├── 연산 방식: [곱하기 ▼] 배율: [1.2x]
├── 최소/최대: [5%] ~ [50%]
└── 📊 예상 결과: RSI 30 → 매매량 12%
```

---

## 📋 Phase 3: 고급 등록 시스템 (내부연산기 포함)

### ✅ 체크리스트
- [ ] **3.1** 다중 변수 조합 시스템
- [ ] **3.2** 내부 연산기 구현 (가중평균, 표준편차)
- [ ] **3.3** 조건부 로직 (IF-THEN-ELSE)
- [ ] **3.4** 변수 간 상관관계 분석
- [ ] **3.5** 시나리오 기반 테스트
- [ ] **3.6** 연산 체인 검증
- [ ] **3.7** 성능 최적화

### ⚙️ 고급 모드 구성
```
🧮 내부 연산기
├── 변수 1: RSI(14) × 0.4
├── 변수 2: BB%B × 0.3  
├── 변수 3: Volume MA × 0.3
├── 연산식: (Var1 + Var2 + Var3) / 기준가격
└── 조건: IF RSI < 30 THEN 최대 30% ELSE 기본
```

---

## 📋 Phase 4: 전문가 모드 (수식 기반 매매량 계산)

### ✅ 체크리스트
- [ ] **4.1** 수식 입력 편집기 (코드 하이라이팅)
- [ ] **4.2** AST 파서 안전성 검증
- [ ] **4.3** 허용 함수 라이브러리 (math, 통계)
- [ ] **4.4** 실시간 수식 검증
- [ ] **4.5** 오류 메시지 표시
- [ ] **4.6** 수식 라이브러리 (프리셋)
- [ ] **4.7** 백테스트 연동

### 🔬 전문가 모드 구성
```
💻 수식 편집기
├── def calculate_position_size(price, rsi, volume, balance):
├──     volatility = std(price, 20) / mean(price, 20)
├──     risk_factor = max(0.1, min(1.0, (50 - rsi) / 100))
├──     return balance * 0.1 * risk_factor * (1 - volatility)
└── ✅ 수식 검증 완료 | ❌ 구문 오류: line 3
```

---

## 🔄 통합 검증 체크리스트

### ✅ 충돌 방지 테스트
- [ ] **T1** 포지션 등록 시 기존 설정 감지
- [ ] **T2** 우선순위 체계 작동 확인  
- [ ] **T3** 전략 조합 시 개별 설정 비활성화
- [ ] **T4** 매매량 연동기 공통 사용 테스트

### ✅ 통합 테스트
- [ ] **T5** 4가지 모드 간 전환 테스트
- [ ] **T6** 실시간 계산 정확성 검증
- [ ] **T7** UI 반응성 테스트
- [ ] **T8** 메모리 사용량 최적화

---

## 📊 진행 상황

**전체 진행률**: 0% (시작 준비 완료)

| Phase | 진행률 | 상태 |
|-------|--------|------|
| Phase 1 | 0% | ⏳ 대기 중 |
| Phase 2 | 0% | ⏳ 대기 중 |  
| Phase 3 | 0% | ⏳ 대기 중 |
| Phase 4 | 0% | ⏳ 대기 중 |

**다음 작업**: Phase 1.1 - 매수 탭에 매매량 설정 프레임 추가

---

## 📝 구현 노트

### 충돌 방지 핵심 로직
```python
def check_position_size_conflict(strategy_id, new_settings):
    """포지션 사이징 충돌 감지 및 해결"""
    existing = get_strategy_position_settings(strategy_id)
    if existing and existing != new_settings:
        return show_conflict_dialog(existing, new_settings)
    return True

def disable_individual_sizing_on_combination():
    """전략 조합 시 개별 매매량 설정 비활성화"""
    for strategy in combined_strategies:
        strategy.position_sizing.enabled = False
```

### 우선순위 적용 순서
1. 포지션 등록 설정 확인
2. 전략 조합 설정 확인  
3. 개별 전략 설정 확인
4. 시스템 기본값 적용

---

**최종 업데이트**: 2025-07-24 태스크 생성 및 충돌 방지 시스템 설계 완료
