# π“ Overlap Optimizer μƒνƒ ν™•μΈ μΏΌλ¦¬ ν•΄μ„¤

> **λ©μ **: DB λΉ„μ „λ¬Έκ°€λ„ overlap_optimizer.pyμ 4κ° SQL μΏΌλ¦¬ λ™μ‘κ³Ό μ μ¬μ  λ¬Έμ μ μ„ μ΄ν•΄ν•  μ μλ„λ΅ λ•λ” λ¬Έμ„

---

## π” κ°μ”

`overlap_optimizer.py`λ” μ—…λΉ„νΈ μΊ”λ“¤ λ°μ΄ν„° μμ§‘ μ‹ μ¤‘λ³µκ³Ό λ„λ½μ„ μµμ†ν™”ν•κΈ° μ„ν•΄ 4λ‹¨κ³„ μµμ ν™”λ¥Ό μν–‰ν•©λ‹λ‹¤. κ° λ‹¨κ³„λ” νΉμ • SQL μΏΌλ¦¬λ΅ ν„μ¬ μƒνƒλ¥Ό ν™•μΈν•μ—¬ μµμ μ μ „λµμ„ μ„ νƒν•©λ‹λ‹¤.

### 4λ‹¨κ³„ μµμ ν™” μ „λµ
1. **START_OVERLAP**: μ‹μ‘μ  κ²ΉμΉ¨ ν™•μΈ
2. **COMPLETE_OVERLAP**: μ™„μ „ κ²ΉμΉ¨ ν™•μΈ
3. **FRAGMENTATION**: ννΈν™” ν™•μΈ
4. **CONNECTED_END**: μ—°κ²°λ λμ  μ°ΎκΈ°

---

## π“‹ μΏΌλ¦¬ 1: μ‹μ‘μ  κ²ΉμΉ¨ ν™•μΈ (START_OVERLAP)

### μΏΌλ¦¬ κµ¬μ΅°
```sql
SELECT 1 FROM candles_KRW_BTC_1m
WHERE candle_date_time_utc BETWEEN '2024-01-01T00:00:00' AND '2024-01-01T03:19:00'
LIMIT 1
```

### π― λ©μ 
- **μ§λ¬Έ**: "μμ§‘ν•λ ¤λ” μ‹κ°„ λ²”μ„μ— μ΄λ―Έ λ°μ΄ν„°κ°€ μλ‚μ”?"
- **λ‹µλ³€**: μμΌλ©΄ `1`, μ—†μΌλ©΄ λΉ κ²°κ³Ό

### π”§ λ™μ‘ μ›λ¦¬
1. μ‹μ‘ μ‹κ°„λ¶€ν„° 200κ° μΊ”λ“¤ λ²”μ„ λ‚΄μ—μ„ κ²€μƒ‰
2. λ”± 1κ°λ§ μ°ΎμΌλ©΄ μ¦‰μ‹ μ¤‘λ‹¨ (`LIMIT 1`)
3. ν¨μ¨μ : μ΅΄μ¬ μ—¬λ¶€λ§ ν™•μΈ, μ‹¤μ  λ°μ΄ν„°λ” κ°€μ Έμ¤μ§€ μ•μ

### β… μ¥μ 
- **λ§¤μ° λΉ λ¦„**: μ²« λ²μ§Έ λ§¤μΉ­ λ°μ΄ν„°λ¥Ό μ°ΎμΌλ©΄ μ¦‰μ‹ μΆ…λ£
- **λ©”λ¨λ¦¬ ν¨μ¨μ **: μ‹¤μ  μΊ”λ“¤ λ°μ΄ν„°λ¥Ό μ½μ§€ μ•μ
- **λ…ν™•ν• λ©μ **: λ‹¨μν• μ΅΄μ¬ μ—¬λ¶€λ§ ν™•μΈ

### β οΈ μ μ¬μ  λ¬Έμ μ 
- **1μ΄ νƒ€μ„ν”„λ μ„**: κ±°λκ°€ μ—†λ” μ΄κ°€ λ§μ•„ μ •μƒμ μΈ "λΉ κµ¬κ°„"λ„ κ²ΉμΉ¨μΌλ΅ μ¤μΈν•  μ μμ
- **μΈλ±μ¤ μμ΅΄μ„±**: `candle_date_time_utc` μ»¬λΌμ— μΈλ±μ¤κ°€ μ—†μΌλ©΄ μ „μ²΄ ν…μ΄λΈ” μ¤μΊ” λ°μƒ

---

## π“ μΏΌλ¦¬ 2: μ™„μ „ κ²ΉμΉ¨ ν™•μΈ (COMPLETE_OVERLAP)

### μΏΌλ¦¬ κµ¬μ΅°
```sql
SELECT COUNT(*) FROM candles_KRW_BTC_1m
WHERE candle_date_time_utc BETWEEN '2024-01-01T00:00:00' AND '2024-01-01T03:19:00'
```

### π― λ©μ 
- **μ§λ¬Έ**: "μμƒλλ” μΊ”λ“¤ κ°μμ™€ μ‹¤μ  μ €μ¥λ κ°μκ°€ μΌμΉν•λ‚μ”?"
- **λ‹µλ³€**: μ‹¤μ  μ €μ¥λ μΊ”λ“¤ κ°μ λ°ν™

### π”§ λ™μ‘ μ›λ¦¬
1. μ‹κ°„ λ²”μ„ λ‚΄ λ¨λ“  μΊ”λ“¤ κ°μλ¥Ό μ„ΈκΈ°
2. TimeUtilsλ΅ κ³„μ‚°ν• μμƒ κ°μμ™€ λΉ„κµ
3. μΌμΉν•λ©΄ "μ™„μ „ κ²ΉμΉ¨"μΌλ΅ νλ‹¨

### β… μ¥μ 
- **μ •ν™•μ„±**: μ‹¤μ  λ°μ΄ν„° κ°μλ¥Ό μ •ν™•ν νμ•…
- **μ™„μ „μ„± κ²€μ¦**: λ¶€λ¶„ κ²ΉμΉ¨κ³Ό μ™„μ „ κ²ΉμΉ¨μ„ κµ¬λ¶„

### β οΈ μ μ¬μ  λ¬Έμ μ 
- **μ„±λ¥**: λ²”μ„ λ‚΄ λ¨λ“  λ μ½”λ“λ¥Ό μ¤μΊ”ν•΄μ•Ό ν•¨
- **1μ΄ νƒ€μ„ν”„λ μ„ μ΄μ**:
  - μμƒ: 200κ° (3λ¶„ 20μ΄ = 200μ΄)
  - μ‹¤μ : 150κ° (κ±°λκ°€ μ—†λ” 50μ΄ μ μ™Έ)
  - β†’ μ™„μ „ κ²ΉμΉ¨μ΄ μ•„λ‹ κ²ƒμΌλ΅ μλ» νλ‹¨
- **λ©”λ¨λ¦¬ μ‚¬μ©**: ν° λ²”μ„μ—μ„λ” λ§μ€ λ©”λ¨λ¦¬ ν•„μ”

---

## π§© μΏΌλ¦¬ 3: ννΈν™” ν™•μΈ (FRAGMENTATION)

### μΏΌλ¦¬ κµ¬μ΅°
```sql
WITH gaps AS (
    SELECT
        candle_date_time_utc,
        LAG(timestamp) OVER (ORDER BY timestamp) as prev_timestamp,
        timestamp - LAG(timestamp) OVER (ORDER BY timestamp) as gap_seconds
    FROM candles_KRW_BTC_1m
    WHERE candle_date_time_utc BETWEEN '2024-01-01T00:00:00' AND '2024-01-01T03:19:00'
    ORDER BY timestamp
)
SELECT COUNT(CASE WHEN gap_seconds > 90 THEN 1 END) as significant_gaps
FROM gaps
WHERE prev_timestamp IS NOT NULL
```

### π― λ©μ 
- **μ§λ¬Έ**: "μ €μ¥λ λ°μ΄ν„°μ— μλ―Έμλ” μ‹κ°„ κ°„κ²©μ΄ μλ‚μ”?"
- **λ‹µλ³€**: μ„κ³„κ°’(1.5 Γ— timeframe)μ„ μ΄κ³Όν•λ” κ°„κ²©μ κ°μ

### π”§ λ™μ‘ μ›λ¦¬
1. **CTE (Common Table Expression)**: `gaps` μ„μ‹ ν…μ΄λΈ” μƒμ„±
2. **LAG μλ„μ° ν•¨μ**: μ΄μ „ μΊ”λ“¤μ timestamp κ°€μ Έμ¤κΈ°
3. **κ°„κ²© κ³„μ‚°**: ν„μ¬ - μ΄μ „ = μ‹κ°„ μ°¨μ΄ (μ΄)
4. **μ„κ³„κ°’ λΉ„κµ**: 90μ΄(1λ¶„ Γ— 1.5) μ΄κ³Όν•λ” κ°„κ²© μ°ΎκΈ°
5. **μΉ΄μ΄νΈ**: μλ―Έμλ” κ°„κ²©μ΄ 2κ° μ΄μƒμ΄λ©΄ "ννΈν™”"

### π“ LAG μλ„μ° ν•¨μ μƒμ„Έ λ™μ‘

**LAG**λ” "μ΄μ „ ν–‰μ κ°’μ„ κ°€μ Έμ¤λ”" μλ„μ° ν•¨μμ…λ‹λ‹¤. λ§μΉ **μ‹κ°„ μ—¬ν–‰**μ„ ν•΄μ„ "λ°”λ΅ μ „ λ°μ΄ν„°"λ¥Ό ν„μ¬ ν–‰μ—μ„ λ³Ό μ μκ² ν•΄μ¤λ‹λ‹¤.

#### 1λ‹¨κ³„: μ›λ³Έ λ°μ΄ν„° μμ‹
```
candle_date_time_utc    timestamp
2024-01-01T00:00:00    1704067200  (00:00:00)
2024-01-01T00:01:00    1704067260  (00:01:00)
2024-01-01T00:02:00    1704067320  (00:02:00)
2024-01-01T00:04:00    1704067440  (00:04:00)  β† 00:03:00 λ„λ½!
2024-01-01T00:05:00    1704067500  (00:05:00)
```

#### 2λ‹¨κ³„: LAG ν•¨μ μ μ©
```sql
LAG(timestamp) OVER (ORDER BY timestamp) as prev_timestamp
```

**κ²°κ³Ό:**
```
candle_date_time_utc    timestamp    prev_timestamp    gap_seconds
2024-01-01T00:00:00    1704067200   NULL              NULL
2024-01-01T00:01:00    1704067260   1704067200        60μ΄      β† μ •μƒ (1λ¶„)
2024-01-01T00:02:00    1704067320   1704067260        60μ΄      β† μ •μƒ (1λ¶„)
2024-01-01T00:04:00    1704067440   1704067320        120μ΄     β† λΉ„μ •μƒ! (2λ¶„)
2024-01-01T00:05:00    1704067500   1704067440        60μ΄      β† μ •μƒ (1λ¶„)
```

#### 3λ‹¨κ³„: μ„κ³„κ°’ νλ‹¨ (timeframeλ³„ μ μ‘ν•)
- **1μ΄ νƒ€μ„ν”„λ μ„**: 1.5μ΄ μ΄κ³Ό μ‹ ννΈν™”
- **1λ¶„ νƒ€μ„ν”„λ μ„**: 90μ΄(60 Γ— 1.5) μ΄κ³Ό μ‹ ννΈν™”
- **5λ¶„ νƒ€μ„ν”„λ μ„**: 450μ΄(300 Γ— 1.5) μ΄κ³Ό μ‹ ννΈν™”

```python
# μ¬λ°”λ¥Έ μ„κ³„κ°’ κ³„μ‚°
timeframe_seconds = get_timeframe_seconds(timeframe)  # 1sβ†’1, 1mβ†’60, 5mβ†’300
threshold = timeframe_seconds * 1.5
```

#### 4λ‹¨κ³„: CASE μ΅°κ±΄λ¶€ μΉ΄μ΄ν…
```sql
COUNT(CASE WHEN gap_seconds > threshold THEN 1 END)
-- gap_seconds > 90μ΄λ©΄ 1, μ•„λ‹λ©΄ NULL
-- COUNTλ” NULLμ„ μ μ™Έν•κ³  1λ§ μ„ΈκΈ°
```

**μ‹¤μ  κ³„μ‚°:**
```
gap_seconds: 60, 60, 120, 60
90μ΄ μ΄κ³Ό?: μ•„λ‹μ¤, μ•„λ‹μ¤, μ, μ•„λ‹μ¤
μΉ΄μ΄νΈ: 0, 0, 1, 0
μµμΆ… κ²°κ³Ό: significant_gaps = 1
```

### β… μ¥μ 
- **μ •κµν• λ¶„μ„**: μ‹¤μ  μ‹κ°„ κ°„κ²©μ„ λ¶„μ„ν•μ—¬ ννΈν™” μ •ν™•ν νƒμ§€
- **μ μ—°ν• μ„κ³„κ°’**: timeframeμ— λ”°λΌ μ μ‘μ  μ„κ³„κ°’ μ„¤μ •

### β οΈ μ μ¬μ  λ¬Έμ μ 
- **λ³µμ΅μ„±**: CTE + μλ„μ° ν•¨μλ΅ κ°€μ¥ λ³µμ΅ν• μΏΌλ¦¬
- **μ„±λ¥ μ¤λ²„ν—¤λ“**:
  - μ „μ²΄ λ°μ΄ν„° μ •λ ¬ ν•„μ”
  - κ° ν–‰λ§λ‹¤ μ΄μ „ ν–‰κ³Ό λΉ„κµ μ—°μ‚°
  - 200κ° Γ— μλ„μ° ν•¨μ μ—°μ‚°
- **μ„κ³„κ°’ ν•λ“μ½”λ”©**: 90μ΄λ΅ κ³ μ •λμ–΄ 1μ΄ νƒ€μ„ν”„λ μ„μ—μ„ λ¶€μ μ 
  - **1μ΄ νƒ€μ„ν”„λ μ„**: 1.5μ΄κ°€ μ μ ν•μ§€λ§ 90μ΄ μ‚¬μ©μΌλ΅ κ°μ§€ μ‹¤ν¨
  - **ν„μ¬ μ½”λ“**: `timeframe_seconds * 1.5` κ³„μ‚°ν•μ§€λ§ μΏΌλ¦¬μ—λ” 90 ν•λ“μ½”λ”©
- **λΉ„ν¨μ¨μ  μ „μ²΄ μ¤μΊ”**: 2κ° λ°κ²¬ν•΄λ„ λκΉμ§€ κ³„μ† μ¤μΊ”
  - **κ°μ„  κ°€λ¥**: 2λ²μ§Έ κ°„κ²© λ°κ²¬ μ‹ μ¦‰μ‹ μΆ…λ£ (`LIMIT 2` ν™μ©)
- **λμ–΄μ§ μ„μΉ λ―Έν™μ©**: μ²« λ²μ§Έ κ°„κ²© μ„μΉλ¥Ό κΈ°λ΅ν•μ§€ μ•μ•„ CONNECTED_ENDμ—μ„ μ¬κ³„μ‚°
  - **κ°μ„  κ°€λ¥**: μ²« λ²μ§Έ λμ–΄μ§ μ„μΉλ¥Ό λ°ν™ν•μ—¬ λ‹¤μ λ‹¨κ³„μ—μ„ μ¬μ‚¬μ©
- **λ©”λ¨λ¦¬ μ§‘μ•½μ **: μ¤‘κ°„ κ²°κ³Όλ¥Ό λ©”λ¨λ¦¬μ— μ €μ¥ν•΄μ•Ό ν•¨

### π’΅ μµμ ν™” μ•„μ΄λ””μ–΄
1. **μ΅°κΈ° μΆ…λ£**: `HAVING COUNT(...) >= 2` β†’ 2κ° λ°κ²¬ μ‹ μ¦‰μ‹ μ¤‘λ‹¨
2. **λμ–΄μ§ μ„μΉ λ°ν™**: μ²« λ²μ§Έ gap_seconds > thresholdμΈ μ„μΉλ„ ν•¨κ» λ°ν™
3. **μ μ‘ν• μ„κ³„κ°’**: timeframeμ— λ”°λ¥Έ λ™μ  threshold κ³„μ‚°

---

## π”— μΏΌλ¦¬ 4: μ—°κ²°λ λμ  μ°ΎκΈ° (CONNECTED_END)

### μΏΌλ¦¬ κµ¬μ΅°
```sql
WITH numbered_candles AS (
    SELECT
        candle_date_time_utc,
        timestamp,
        ROW_NUMBER() OVER (ORDER BY timestamp) as row_num,
        1640995200 + (ROW_NUMBER() OVER (ORDER BY timestamp) - 1) * 60 as expected_timestamp
    FROM candles_KRW_BTC_1m
    WHERE candle_date_time_utc >= '2024-01-01T00:00:00'
        AND candle_date_time_utc <= '2024-01-01T03:19:00'
    ORDER BY timestamp
    LIMIT 200
)
SELECT candle_date_time_utc
FROM numbered_candles
WHERE timestamp = expected_timestamp
ORDER BY timestamp DESC
LIMIT 1
```

### π― λ©μ 
- **μ§λ¬Έ**: "μ—°μ†μ μΌλ΅ μ €μ¥λ λ°μ΄ν„°μ λ§μ§€λ§‰ μ§€μ μ€ μ–΄λ””μΈκ°€μ”?"
- **λ‹µλ³€**: μμƒ μ‹κ°„κ³Ό μ‹¤μ  μ‹κ°„μ΄ μ •ν™•ν μΌμΉν•λ” λ§μ§€λ§‰ μΊ”λ“¤

### π”§ λ™μ‘ μ›λ¦¬
1. **CTE**: `numbered_candles` μ„μ‹ ν…μ΄λΈ” μƒμ„±
2. **ROW_NUMBER()**: κ° μΊ”λ“¤μ— μλ² λ¶€μ—¬ (1, 2, 3, ...)
3. **expected_timestamp κ³„μ‚°**:
   - μ‹μ‘μ  + (μλ²-1) Γ— timeframeμ΄
   - μ: 1640995200 + (1-1) Γ— 60 = 1640995200 (μ²« λ²μ§Έ)
   - μ: 1640995200 + (2-1) Γ— 60 = 1640995260 (λ‘ λ²μ§Έ)
4. **μ •ν™•μ„± κ²€μ¦**: μ‹¤μ  timestampμ™€ expected_timestampκ°€ μΌμΉν•λ”μ§€ ν™•μΈ
5. **λ§μ§€λ§‰ μ—°μ†μ **: μΌμΉν•λ” κ²ƒ μ¤‘ κ°€μ¥ λ¦μ€ μ‹κ°„ λ°ν™

### β… μ¥μ 
- **μ •λ°€ν• μ—°μ†μ„± κ²€μ¦**: μ‹κ°„ μμ„μ™€ κ°„κ²©μ΄ λ¨λ‘ μ •ν™•ν•μ§€ ν™•μΈ
- **μ—°μ† κµ¬κ°„ μ‹λ³„**: μ–΄λ””κΉμ§€κ°€ "λ―Ώμ„ μ μλ”" μ—°μ† λ°μ΄ν„°μΈμ§€ νμ•…

### β οΈ μ μ¬μ  λ¬Έμ μ 
- **μµκ³  λ³µμ΅μ„±**: 4κ° μΏΌλ¦¬ μ¤‘ κ°€μ¥ λ³µμ΅ν•¨
  - CTE + μλ„μ° ν•¨μ + κ³„μ‚° κ³µμ‹ + μ΅°κ±΄ λΉ„κµ
- **μ„±λ¥ λ¬Έμ **:
  - ROW_NUMBER() μλ„μ° ν•¨μλ΅ μ „μ²΄ μ •λ ¬ ν•„μ”
  - κ° ν–‰λ§λ‹¤ λ³µμ΅ν• κ³„μ‚° μν–‰
  - expected_timestamp κ³„μ‚° μ¤λ²„ν—¤λ“
- **μ¤‘λ³µ κ³„μ‚°**: FRAGMENTATIONμ—μ„ μ΄λ―Έ μ°Ύμ€ λμ–΄μ§ μ„μΉλ¥Ό μ¬κ³„μ‚°
  - **λΉ„ν¨μ¨**: ννΈν™” λ‹¨κ³„μ—μ„ μ²« λ²μ§Έ λμ–΄μ§μ„ μ°Ύμ•λ”λ° λ‹¤μ‹ μ²μλ¶€ν„° μ¤μΊ”
  - **κ°μ„  κ°€λ¥**: ννΈν™” κ²°κ³Όμ λμ–΄μ§ μ„μΉλ¥Ό μ¬μ‚¬μ©ν•μ—¬ λ°”λ΅ μ—°κ²°λ λ κ³„μ‚°
- **1μ΄ νƒ€μ„ν”„λ μ„ νΉμ λ¬Έμ **:
  - κ±°λκ°€ μ—†λ” μ΄λ” timestampκ°€ μ΅΄μ¬ν•μ§€ μ•μ
  - expected_timestampλ” μ—°μ†μ μ΄μ§€λ§ μ‹¤μ λ” λ¶μ—°μ†
  - β†’ μ—°μ†μ μ„ κ±°μ μ°Ύμ§€ λ»ν•  κ°€λ¥μ„±
- **μ •ν™•μ„± μ΄μ**:
  - μ‹μ‘μ  timestampλ¥Ό ν•λ“μ½”λ”© (1640995200)
  - μ‹κ°„λ€ λ³€ν™ μ¤λ¥ κ°€λ¥μ„±
  - μ—…λΉ„νΈ APIμ μ‹¤μ  νΉμ„±κ³Ό λ¶μΌμΉ μ„ν—
- **λ¶ν•„μ”ν• μ „μ²΄ κ²€μƒ‰**: μ²« λ²μ§Έ μ—°κ²°λ λλ§ ν•„μ”ν•λ° λ¨λ“  λ°μ΄ν„° κ²€μ‚¬

---

## π¨ 1μ΄ νƒ€μ„ν”„λ μ„μ νΉμ λ¬Έμ 

### κ·Όλ³Έμ  νΉμ„±
- **κ±°λ κΈ°λ°**: 1μ΄λ§λ‹¤ λ°λ“μ‹ κ±°λκ°€ μλ” κ²ƒμ΄ μ•„λ‹
- **μμ—°μ¤λ¬μ΄ λΉ κµ¬κ°„**: κ±°λλ‰μ΄ μ μ€ μ‹κ°„λ€μ—λ” μμ‹­ μ΄κ°„ κ±°λ μ—†μ
- **λ¶κ·μΉ™μ„±**: κ±°λ ν¨ν„΄μ— λ”°λΌ λ°μ΄ν„° λ°€λ„κ°€ ν¬κ² λ‹¬λΌμ§

### μΏΌλ¦¬λ³„ μν–¥
1. **START_OVERLAP**: μ •μƒμ μΈ λΉ κµ¬κ°„μ„ κ²ΉμΉ¨μΌλ΅ μ¤μΈ
2. **COMPLETE_OVERLAP**: μμƒ κ°μ λ¶μΌμΉλ΅ λ¶μ™„μ „ κ²ΉμΉ¨ νλ‹¨
3. **FRAGMENTATION**: μ •μƒμ μΈ κ±°λ κ°„κ²©μ„ ννΈν™”λ΅ μ¤μ§„λ‹¨
4. **CONNECTED_END**: μ—°μ†μ μ„ κ±°μ μ°Ύμ§€ λ»ν•΄ κΈ°λ¥ λ¬΄λ ¥ν™”

---

## π’΅ κ°μ„  λ°©ν–¥ μ μ•

### 1. TimeUtils κΈ°λ° λ‹¨μν™”
- **λ³µμ΅ν• SQL β†’ κ°„λ‹¨ν• Python**: μλ„μ° ν•¨μ λ€μ‹  TimeUtils ν™μ©
- **boundary μ •λ ¬**: μ—…λΉ„νΈ API νΉμ„±μ— λ§λ” μ‹κ°„ κ²½κ³„ μ‚¬μ©
- **μμΈ΅ κ°€λ¥μ„±**: λ³µμ΅ν• κ³„μ‚° λ΅μ§μ„ ν¬λ…ν•κ³  ν…μ¤νΈ κ°€λ¥ν• PythonμΌλ΅

### 2. μ μ‘ν• μ„κ³„κ°’ μ‹μ¤ν…
```python
def get_fragmentation_threshold(timeframe: str) -> int:
    """timeframeλ³„ μ μ‘ν• ννΈν™” μ„κ³„κ°’"""
    timeframe_seconds = get_timeframe_seconds(timeframe)
    return int(timeframe_seconds * 1.5)

# 1s β†’ 1.5μ΄, 1m β†’ 90μ΄, 5m β†’ 450μ΄
```

### 3. μ΅°κΈ° μΆ…λ£ μµμ ν™”
```sql
-- ν„μ¬: λ¨λ“  λ°μ΄ν„° μ¤μΊ” ν›„ μΉ΄μ΄νΈ
SELECT COUNT(CASE WHEN gap_seconds > ? THEN 1 END) FROM gaps

-- κ°μ„ : 2κ° λ°κ²¬ μ‹ μ¦‰μ‹ μ¤‘λ‹¨
SELECT 1 FROM gaps WHERE gap_seconds > ? LIMIT 2
-- κ²°κ³Όκ°€ 2κ°λ©΄ ννΈν™”, μ•„λ‹λ©΄ μ—°μ†
```

### 4. λμ–΄μ§ μ„μΉ μ¬μ‚¬μ© μ‹μ¤ν…
```python
class FragmentationResult:
    has_fragmentation: bool
    first_gap_position: Optional[datetime]  # μ²« λ²μ§Έ λμ–΄μ§ μ„μΉ
    gap_count: int

# FRAGMENTATIONμ—μ„ λ°ν™
def check_fragmentation() -> FragmentationResult:
    # μ²« λ²μ§Έ gap > threshold μ„μΉλ„ ν•¨κ» λ°ν™

# CONNECTED_ENDμ—μ„ μ¬μ‚¬μ©
def find_connected_end(frag_result: FragmentationResult):
    if frag_result.first_gap_position:
        # μ΄λ―Έ μ•κ³  μλ” λμ–΄μ§ μ„μΉ ν™μ©
        return frag_result.first_gap_position
    else:
        # μ „μ²΄ μ—°μ† μƒνƒ
```

### 5. 1μ΄ νƒ€μ„ν”„λ μ„ νΉλ³„ μ²λ¦¬
- **κ±°λ κΈ°λ° λ΅μ§**: μ—°μ†μ„± λ€μ‹  κ±°λ μ΅΄μ¬ μ—¬λ¶€ κΈ°μ¤€
- **μ μ—°ν• μ„κ³„κ°’**: timeframeλ³„ μ μ‘μ  κΈ°μ¤€κ°’
- **μ‹¤μ©μ  μ ‘κ·Ό**: μ™„λ²½ν• μ—°μ†μ„±λ³΄λ‹¤ λ°μ΄ν„° ν’μ§ μ¤‘μ‹¬

### 6. μ„±λ¥ μµμ ν™”
- **μΈλ±μ¤ μµμ ν™”**: μμ£Ό μ‚¬μ©λλ” μ»¬λΌμ— λ³µν•© μΈλ±μ¤
- **μΏΌλ¦¬ λ‹¨μν™”**: λ³µμ΅ν• CTEλ¥Ό μ—¬λ¬ λ‹¨κ³„λ΅ λ¶„ν• 
- **μΊμ‹± ν™μ©**: λ°λ³µ κ³„μ‚° κ²°κ³Ό λ©”λ¨λ¦¬ μΊμ‹±
- **μ¤‘λ³µ μ κ±°**: λ‹¨κ³„ κ°„ κ²°κ³Ό μ¬μ‚¬μ©μΌλ΅ λ¶ν•„μ”ν• μ¬κ³„μ‚° λ°©μ§€

### 7. κ΄€μ°° κ°€λ¥μ„± κ°μ„ 
- **λ‹¨κ³„λ³„ λ΅κΉ…**: κ° μΏΌλ¦¬ μ‹¤ν–‰ μ‹κ°„κ³Ό κ²°κ³Ό κΈ°λ΅
- **μ„±λ¥ λ¨λ‹ν„°λ§**: μΏΌλ¦¬λ³„ ν‰κ·  μ‹¤ν–‰ μ‹κ°„ μ¶”μ 
- **μμ™Έ μƒν™© κ°μ§€**: λΉ„μ •μƒμ μΈ κ²°κ³Ό ν¨ν„΄ μ•λ¦Ό

---

## π“ κ²°λ΅ 

ν„μ¬ 4κ° μΏΌλ¦¬λ” κ°κ° λ…ν™•ν• λ©μ μ„ κ°€μ§€κ³  μμ§€λ§, **λ³µμ΅μ„±κ³Ό 1μ΄ νƒ€μ„ν”„λ μ„ νΉμ„±**μΌλ΅ μΈν•΄ λ‹¤μ λ¬Έμ λ“¤μ΄ μμƒλ©λ‹λ‹¤:

### μ£Όμ” μ„ν— μ”μ†
- **μ„±λ¥ μ €ν•**: λ³µμ΅ν• μλ„μ° ν•¨μλ΅ μΈν• μ‹¤ν–‰ μ‹κ°„ μ¦κ°€
- **μ¤μ§„λ‹¨**: 1μ΄ νƒ€μ„ν”„λ μ„μ μμ—°μ¤λ¬μ΄ νΉμ„±μ„ λ¬Έμ λ΅ μΈμ‹
- **μ μ§€λ³΄μμ„±**: λ³µμ΅ν• SQL λ΅μ§μΌλ΅ λ””λ²„κΉ…κ³Ό μμ • μ–΄λ ¤μ›€

### κ¶μ¥ μ‚¬ν•­
1. **λ‹¨κ³„μ  λ‹¨μν™”**: κ°€μ¥ λ³µμ΅ν• μΏΌλ¦¬ 3, 4λ²λ¶€ν„° TimeUtils κΈ°λ°μΌλ΅ μ¬μ‘μ„±
2. **μ μ‘ν• μ„κ³„κ°’**: timeframeλ³„ λ™μ  κ³„μ‚° (1sβ†’1.5μ΄, 1mβ†’90μ΄)
3. **μ΅°κΈ° μΆ…λ£**: 2λ²μ§Έ κ°„κ²© λ°κ²¬ μ‹ μ¦‰μ‹ μ¤‘λ‹¨μΌλ΅ μ„±λ¥ ν–¥μƒ
4. **κ²°κ³Ό μ¬μ‚¬μ©**: ννΈν™” λ‹¨κ³„μ λμ–΄μ§ μ„μΉλ¥Ό μ—°κ²°λ λ μ°ΎκΈ°μ—μ„ μ¬ν™μ©
5. **μ„±λ¥ ν…μ¤νΈ**: μ‹¤μ  λ°μ΄ν„°λ΅ μΏΌλ¦¬λ³„ μ„±λ¥ μΈ΅μ • λ° λ³‘λ© μ§€μ  μ‹λ³„

> **ν•µμ‹¬**: λ³µμ΅ν• SQL λ€μ‹  κ²€μ¦λ TimeUtils + λ…ν™•ν• Python λ΅μ§μΌλ΅ λ” μ•μ „ν•κ³  μ μ§€λ³΄μν•κΈ° μ‰¬μ΄ μ‹μ¤ν… κµ¬μ¶•
> **μµμ ν™” ν¬μΈνΈ**: μ„κ³„κ°’ μ μ‘ν™”, μ΅°κΈ° μΆ…λ£, κ²°κ³Ό μ¬μ‚¬μ©μΌλ΅ μ„±λ¥κ³Ό μ •ν™•μ„± λ™μ‹ κ°μ„ 
