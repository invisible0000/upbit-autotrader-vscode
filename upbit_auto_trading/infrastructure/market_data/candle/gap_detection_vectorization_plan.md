# Gap Detection Vectorization Improvement Plan

**ë²„ì „**: v1.1
**ì‘ì„±ì¼**: 2025-09-21
**ëŒ€ìƒ**: EmptyCandleDetector ì„±ëŠ¥ ìµœì í™”
**ìƒíƒœ**: ğŸš¨ **Critical Issue ë°œê²¬** - ì²­í¬ ê²½ê³„ Gap ê²€ì¶œ ì‹¤íŒ¨---

## ğŸ“‹ ëª©ì  ë° ê°œìš”

EmptyCandleDetectorì˜ Gap ê°ì§€ ì„±ëŠ¥ì„ ë²¡í„°í™” ì—°ì‚°ì„ í†µí•´ íšê¸°ì ìœ¼ë¡œ ê°œì„ í•˜ëŠ” ì¢…í•© ê³„íšì…ë‹ˆë‹¤.
í˜„ì¬ ë£¨í”„ ê¸°ë°˜ Gap ê°ì§€ë¥¼ numpy ë²¡í„°í™” ì—°ì‚°ìœ¼ë¡œ ì „í™˜í•˜ì—¬ **93.3% ì„±ëŠ¥ í–¥ìƒ**ì„ ë‹¬ì„±í–ˆìœ¼ë©°, ì¶”ê°€ ìµœì í™” ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

---

## ğŸ¯ ì„±ê³¼ ë° í˜„í™©

### âœ… **ë‹¬ì„±ëœ ì„±ê³¼**

| í•­ëª© | ê¸°ì¡´ ë°©ì‹ | ë²¡í„°í™” ë°©ì‹ | ê°œì„ ìœ¨ |
|------|-----------|-------------|--------|
| **ì†Œê·œëª¨** (50ê°œ) | 22.72ms | 2.08ms | **90.8%** â¬†ï¸ |
| **ì¤‘ê°„ê·œëª¨** (500ê°œ) | 208.69ms | 12.38ms | **94.1%** â¬†ï¸ |
| **ëŒ€ê·œëª¨** (2000ê°œ) | 772.73ms | 58.01ms | **92.5%** â¬†ï¸ |
| **ì´ˆëŒ€ê·œëª¨** (5000ê°œ) | 1881.23ms | 80.38ms | **95.7%** â¬†ï¸ |

**í‰ê·  ì„±ëŠ¥ ê°œì„ **: **93.3%**
**ì •í™•ì„±**: **100% ì¼ì¹˜**

### ğŸ”§ **êµ¬í˜„ëœ ìµœì í™”**

1. **ë²¡í„°í™” Gap ê°ì§€**: numpy ë°°ì—´ ê¸°ë°˜ ì°¨ë¶„ ì—°ì‚°
2. **ì¡°ê±´ë¶€ ë§ˆìŠ¤í‚¹**: `gap_mask = deltas > timeframe_delta_ms`
3. **ë°°ì¹˜ ì²˜ë¦¬**: `np.where(gap_mask)[0]`ë¡œ Gap ì¸ë±ìŠ¤ ì¶”ì¶œ
4. **ë§ˆì´í¬ë¡œ ìµœì í™”**: `get_timeframe_ms()` ë©”ì„œë“œ ì¶”ê°€ (13-16% ì¶”ê°€ ê°œì„ )

---

## ï¿½ **Critical Issue: ì²­í¬ ê²½ê³„ Gap ê²€ì¶œ ì‹¤íŒ¨**

### âš ï¸ **ë°œê²¬ëœ ì—£ì§€ ì¼€ì´ìŠ¤**

**ë¬¸ì œ ìƒí™©**: ì²­í¬ ì²˜ë¦¬ ì‹œ ì´ì „ ì²­í¬ì™€ í˜„ì¬ ì²­í¬ ì‚¬ì´ì˜ Gapì´ ê²€ì¶œë˜ì§€ ì•Šì•„ **ë°ì´í„° ëˆ„ë½** ë°œìƒ

**ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ**:
```
ì²­í¬1 ì²˜ë¦¬: API[17,16,14] â†’ DB[17,16,(15),14] âœ… ì •ìƒ (15 ë¹ˆ ìº”ë“¤ ìƒì„±)

ì²­í¬2 ì²˜ë¦¬: API[11,10,9,8] â†’ DB[17,16,(15),14,11,10,9,8] âŒ ë¬¸ì œ
ë²¡í„°í™” ê³„ì‚°: [11,10,9] - [10,9,8] = [1,1,1] (ëª¨ë‘ ì •ìƒìœ¼ë¡œ ì˜¤íŒ)
ê²°ê³¼: 13,12 ë¹ˆ ìº”ë“¤ ëˆ„ë½! ì²­í¬ ê²½ê³„ Gap ë¯¸ê²€ì¶œ
```

### ğŸ”§ **í•´ê²° ë°©ì•ˆ**

**í˜„ì¬ ë°©ì‹ (ë¬¸ì œ)**:
```python
# API ì‘ë‹µë§Œ ì‚¬ìš© â†’ ì²­í¬ ê°„ ì—°ê²°ì  ëˆ„ë½
sorted_datetimes = [11,10,9,8]  # API ì‘ë‹µë§Œ
deltas = timestamps[:-1] - timestamps[1:]
gap_mask = deltas > timeframe_delta_ms  # Gap ë¯¸ê²€ì¶œ
```

**ì˜¬ë°”ë¥¸ ë°©ì‹ (í•´ê²°)**:
```python
# fallback_referenceë¥¼ ë²¡í„°í™” ì—°ì‚°ì— í¬í•¨
if fallback_reference:
    fallback_dt = parse_datetime(fallback_reference)
    extended_datetimes = [fallback_dt] + sorted_datetimes  # [14,11,10,9,8]
else:
    extended_datetimes = sorted_datetimes

timestamps = np.array([dt.timestamp() * 1000 for dt in extended_datetimes])
deltas = timestamps[:-1] - timestamps[1:]  # [3,1,1,1] â†’ Gap ì •ìƒ ê²€ì¶œ!
```

### ğŸ“ˆ **ì˜í–¥ë„**
- **ì‹¬ê°ë„**: Critical (ë°ì´í„° ë¬´ê²°ì„± ì†ìƒ)
- **ë°œìƒ ë¹ˆë„**: ëª¨ë“  ì²­í¬ ê²½ê³„ì—ì„œ ë°œìƒ ê°€ëŠ¥
- **ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥**: ëˆ„ë½ ë°ì´í„°ë¡œ ì¸í•œ ë§¤ë§¤ ì „ëµ ì˜¤ì‘ë™

---

## ï¿½ğŸ”¬ ê¸°ìˆ ì  ë¶„ì„

### **í˜„ì¬ êµ¬í˜„ ë°©ì‹ (ê¶Œì¥)**

```python
# ê¸°ì¡´ ë°©ì‹: O(n) ë£¨í”„ ê¸°ë°˜
for i in range(1, len(sorted_datetimes)):
    previous_time = sorted_datetimes[i - 1]
    current_time = sorted_datetimes[i]
    expected_current = TimeUtils.get_time_by_ticks(previous_time, timeframe, -1)
    if current_time < expected_current:
        # Gap ì²˜ë¦¬...

# ğŸš€ ë²¡í„°í™” ë°©ì‹: numpy ë°°ì—´ ì—°ì‚°
timestamps = np.array([int(dt.timestamp() * 1000) for dt in sorted_datetimes])
deltas = timestamps[:-1] - timestamps[1:]
gap_mask = deltas > self._timeframe_delta_ms
gap_indices = np.where(gap_mask)[0]
```

### **ëŒ€ì•ˆ ë°©ì‹ ë¹„êµ**

| ë°©ì‹ | ì„±ëŠ¥ | ì½”ë“œ ë³µì¡ì„± | ë©”ëª¨ë¦¬ ì‚¬ìš© | ì •í™•ì„± |
|------|------|-------------|-------------|---------|
| **ê¸°ì¡´ ë£¨í”„** | 1.0x | ë‚®ìŒ | ë‚®ìŒ | 100% |
| **ğŸ† ë²¡í„°í™” (timestamp)** | **20x** | ì¤‘ê°„ | ì¤‘ê°„ | 100% |
| **ë²¡í„°í™” (datetime64)** | 5x | ì¤‘ê°„ | ë†’ìŒ | 100% |
| **pandas ë°©ì‹** | 3x | ë†’ìŒ | ë†’ìŒ | 100% |

---

## ğŸ“ˆ ì¶”ê°€ ìµœì í™” ê³„íš

### **Phase 1: ë§ˆì´í¬ë¡œ ìµœì í™” (ì™„ë£Œ)**

- âœ… **TimeUtils.get_timeframe_ms()** ì¶”ê°€
- âœ… **13-16% ì¶”ê°€ ì„±ëŠ¥ í–¥ìƒ** ë‹¬ì„±
- âœ… **EmptyCandleDetector ì´ˆê¸°í™”** ì‹œ ì ìš©

### **Phase 2: ë©”ëª¨ë¦¬ ìµœì í™” (ê²€í†  ì¤‘)**

**ëª©í‘œ**: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”ë¡œ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ê°œì„ 

```python
# í˜„ì¬: ì „ì²´ datetime ë¦¬ìŠ¤íŠ¸ â†’ timestamp ë°°ì—´
timestamps = np.array([int(dt.timestamp() * 1000) for dt in datetime_list])

# ğŸ”§ ìµœì í™” ì•ˆ: ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬
def process_in_chunks(datetime_list, chunk_size=1000):
    for chunk in chunks(datetime_list, chunk_size):
        yield vectorized_gap_detection(chunk)
```

**ì˜ˆìƒ íš¨ê³¼**:
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ **50% ê°ì†Œ**
- ì´ˆëŒ€í˜• ë°ì´í„°ì…‹ (10ë§Œê°œ+) ì²˜ë¦¬ ê°€ëŠ¥

### **Phase 3: ë³‘ë ¬ ì²˜ë¦¬ (ë¯¸ë˜ ê³„íš)**

**ëª©í‘œ**: ë©€í‹°ì½”ì–´ í™œìš©ìœ¼ë¡œ ì¶”ê°€ ì„±ëŠ¥ í–¥ìƒ

```python
# ğŸš€ ë³‘ë ¬ ì²˜ë¦¬ êµ¬ìƒ
from concurrent.futures import ThreadPoolExecutor

def parallel_gap_detection(datetime_chunks):
    with ThreadPoolExecutor(max_workers=4) as executor:
        return list(executor.map(vectorized_gap_detection, datetime_chunks))
```

**ì˜ˆìƒ íš¨ê³¼**:
- **2-4ë°° ì¶”ê°€ ì„±ëŠ¥ í–¥ìƒ** (CPU ì½”ì–´ ìˆ˜ì— ë”°ë¼)
- ì´ˆëŒ€í˜• ë°ì´í„°ì…‹ì—ì„œ íŠ¹íˆ ìœ íš¨

---

## ğŸ¯ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### **ï¿½ Critical Priority (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)**

1. **ì²­í¬ ê²½ê³„ Gap ê²€ì¶œ ìˆ˜ì •** - fallback_reference í™œìš©í•œ ë²¡í„°í™” ê°œì„ 
   - ìƒíƒœ: âŒ **ë¯¸í•´ê²°** (ë°ì´í„° ë¬´ê²°ì„± ìœ„í—˜)
   - ì˜í–¥: ì²­í¬ ì²˜ë¦¬ ì‹œ ë¹ˆ ìº”ë“¤ ëˆ„ë½ìœ¼ë¡œ ì¸í•œ ë°ì´í„° ì†ì‹¤
   - í•´ê²°: `_detect_gaps_in_datetime_list`ì—ì„œ fallback_reference ë²¡í„°í™” ì—°ì‚° í¬í•¨

### **ï¿½ğŸ”¥ High Priority (ì™„ë£Œ)**

2. âœ… **ë²¡í„°í™” Gap ê°ì§€** - 93.3% ì„±ëŠ¥ í–¥ìƒ (ì™„ë£Œ, ë‹¨ ì²­í¬ ê²½ê³„ ì´ìŠˆ ìˆìŒ)
3. âœ… **get_timeframe_ms()** - ë§ˆì´í¬ë¡œ ìµœì í™” (ì™„ë£Œ)

### **âš–ï¸ Medium Priority (ì„ íƒì  ì ìš©)**

4. **ë©”ëª¨ë¦¬ ì²­í¬ ì²˜ë¦¬** - ëŒ€ìš©ëŸ‰ ë°ì´í„° ëŒ€ì‘
5. **Gap ì •ë³´ ìºì‹±** - ë°˜ë³µ ê³„ì‚° ì œê±°
6. **í”„ë¡œíŒŒì¼ë§ ìµœì í™”** - ë³‘ëª©ì  ì¶”ê°€ ë°œê²¬

### **ğŸ”® Low Priority (ë¯¸ë˜ ê³„íš)**

6. **ë³‘ë ¬ ì²˜ë¦¬** - ë©€í‹°ì½”ì–´ í™œìš©
7. **JIT ì»´íŒŒì¼** - numba ì ìš© ê²€í† 
8. **CUDA ê°€ì†** - GPU ì—°ì‚° ê²€í†  (ë§¤ìš° ëŒ€ìš©ëŸ‰ ì‹œ)

---

## ğŸ§ª ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•**

```bash
# ë²¡í„°í™” ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸
python tests/performance/empty_candle_detector_performance_test.py

# datetime ë°©ì‹ ë¹„êµ í…ŒìŠ¤íŠ¸
python tests/performance/datetime_vectorization_comparison.py

# ë§ˆì´í¬ë¡œ ìµœì í™” í…ŒìŠ¤íŠ¸
python tests/performance/timeutils_optimization_test.py
```

### **ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ê¸°ì¤€**

- **í…ŒìŠ¤íŠ¸ í™˜ê²½**: Windows, Python 3.13, numpy 2.3.2
- **ë°˜ë³µ íšŸìˆ˜**: 10íšŒ í‰ê· 
- **ë°ì´í„° í¬ê¸°**: 50 ~ 5000ê°œ ìº”ë“¤
- **Gap ë°€ë„**: 10-20%

---

## ğŸ’¡ ê¶Œì¥ì‚¬í•­

### **âœ… í˜„ì¬ êµ¬í˜„ ìœ ì§€**

í˜„ì¬ **ë²¡í„°í™” ë°©ì‹ (timestamp ê¸°ë°˜)**ì´ ìµœì ì˜ ì„±ëŠ¥ê³¼ ì•ˆì •ì„±ì„ ì œê³µí•©ë‹ˆë‹¤:

1. **ê²€ì¦ëœ ì„±ëŠ¥**: 93.3% í–¥ìƒ ì…ì¦
2. **ì™„ë²½í•œ ì •í™•ì„±**: 100% ê¸°ì¡´ ë¡œì§ê³¼ ì¼ì¹˜
3. **ë‚®ì€ ë³µì¡ì„±**: ìœ ì§€ë³´ìˆ˜ ë¹„ìš© ìµœì†Œ
4. **í™•ì¥ì„±**: ì¶”ê°€ ìµœì í™” ê¸°ë°˜ ì œê³µ

### **ğŸ”„ ì§€ì†ì  ê°œì„  ë°©í–¥**

1. **ëª¨ë‹ˆí„°ë§**: ì‹¤ì œ ì‚¬ìš© í™˜ê²½ì—ì„œ ì„±ëŠ¥ ì¶”ì 
2. **í”„ë¡œíŒŒì¼ë§**: ìƒˆë¡œìš´ ë³‘ëª©ì  ë°œê²¬ ë° ìµœì í™”
3. **ì—…ë°ì´íŠ¸**: numpy/Python ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ì‹œ ì¬ê²€í† 
4. **í™•ì¥**: ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë¡œ ë²¡í„°í™” ê¸°ë²• í™•ì‚°

---

## ğŸ“š ì°¸ê³  ìë£Œ

### **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼**
- `tests/performance/empty_candle_detector_performance_test.py`
- `tests/performance/datetime_vectorization_comparison.py`
- `tests/performance/timeutils_optimization_test.py`

### **êµ¬í˜„ íŒŒì¼**
- `empty_candle_detector.py` - ë©”ì¸ êµ¬í˜„ì²´
- `time_utils.py` - ì‹œê°„ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹°
- `gap_detection_vectorization_plan.md` - ë³¸ ë¬¸ì„œ

### **ê´€ë ¨ ì´ìŠˆ ë° ì»¤ë°‹**
- Gap ê°ì§€ ë²¡í„°í™” êµ¬í˜„
- TimeUtils ë§ˆì´í¬ë¡œ ìµœì í™”
- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ êµ¬ì¶•

---

## ğŸ”„ ì—…ë°ì´íŠ¸ ë¡œê·¸

| ë‚ ì§œ | ë²„ì „ | ë³€ê²½ì‚¬í•­ |
|------|------|----------|
| 2025-09-21 | v1.0 | ì´ˆê¸° ë¬¸ì„œ ì‘ì„±, ë²¡í„°í™” ì„±ê³¼ ì •ë¦¬ |
| 2025-09-21 | v1.1 | ğŸš¨ **Critical Issue ì¶”ê°€** - ì²­í¬ ê²½ê³„ Gap ê²€ì¶œ ì‹¤íŒ¨ ë¬¸ì œ ë°œê²¬ ë° í•´ê²° ë°©ì•ˆ ì œì‹œ |

---

**ğŸ“ ë¬¸ì˜**: GitHub Issues ë˜ëŠ” ì½”ë“œ ë¦¬ë·°ë¥¼ í†µí•´ ì¶”ê°€ ìµœì í™” ì œì•ˆ í™˜ì˜
