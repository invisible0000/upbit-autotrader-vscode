"""
ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ ì „ëµ ê´€ë¦¬ í™”ë©´
ìš°ë¦¬ì˜ 8ê°œ ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œì„ ê¸°ì¤€ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œ êµ¬í˜„
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QTabWidget, QHBoxLayout,
    QPushButton, QLabel, QMessageBox
)
from PyQt6.QtCore import Qt, pyqtSignal
from PyQt6.QtGui import QIcon

# ìš°ë¦¬ì˜ ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ import
import sys
import os

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì¶”ê°€ (ì˜¬ë°”ë¥¸ ê²½ë¡œ ì„¤ì •)
# í˜„ì¬ íŒŒì¼ì˜ ìœ„ì¹˜ì—ì„œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ê¹Œì§€ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ê¸°
current_dir = os.path.dirname(__file__)  # strategy_management í´ë”
screens_dir = os.path.dirname(current_dir)  # screens í´ë”
desktop_dir = os.path.dirname(screens_dir)  # desktop í´ë”
ui_dir = os.path.dirname(desktop_dir)  # ui í´ë”
upbit_auto_trading_dir = os.path.dirname(ui_dir)  # upbit_auto_trading í´ë”
project_root = os.path.dirname(upbit_auto_trading_dir)  # upbit-autotrader-vscode í´ë”

sys.path.insert(0, project_root)

try:
    # ê°œë³„ì ìœ¼ë¡œ ì‹œë„í•´ì„œ ì–´ë–¤ ê²ƒì´ ë¡œë“œ ê°€ëŠ¥í•œì§€ í™•ì¸
    ConditionDialog = None
    try:
        from .components.condition_dialog import ConditionDialog
        print("âœ… ConditionDialog ë¡œë“œ ì„±ê³µ")
    except ImportError as e:
        print(f"âš ï¸ ConditionDialog ë¡œë“œ ì‹¤íŒ¨: {e}")
    
    IntegratedConditionManager = None
    try:
        from .integrated_condition_manager import IntegratedConditionManager
        print("âœ… IntegratedConditionManager ë¡œë“œ ì„±ê³µ")
    except ImportError as e:
        print(f"âš ï¸ IntegratedConditionManager ë¡œë“œ ì‹¤íŒ¨: {e}")
        
    print(f"ğŸ” í”„ë¡œì íŠ¸ ë£¨íŠ¸: {project_root}")
    
except Exception as e:
    print(f"âŒ ì „ì²´ import ì‹¤íŒ¨: {e}")
    ConditionDialog = None
    IntegratedConditionManager = None

class NewStrategyManagementScreen(QWidget):
    """ì™„ì „íˆ ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ ì „ëµ ê´€ë¦¬ í™”ë©´"""
    
    # ì‹œê·¸ë„ ì •ì˜
    strategy_saved = pyqtSignal(dict)
    backtest_requested = pyqtSignal(str)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("ë§¤ë§¤ ì „ëµ ê´€ë¦¬")
        # 1600x1000 í™”ë©´ì— ë§ì¶°ì„œ í¬ê¸° ì¡°ì •
        self.setMinimumSize(800, 600)
        
        self.init_ui()
    
    def init_ui(self):
        """UI ì´ˆê¸°í™” - ìš°ë¦¬ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(5, 5, 5, 5)  # ë§ˆì§„ ì¤„ì´ê¸°
        layout.setSpacing(5)  # ê°„ê²© ì¤„ì´ê¸°
        
        # íƒ­ ìœ„ì ¯ ìƒì„± (ìƒë‹¨ íˆ´ë°” ì œê±°)
        self.tab_widget = QTabWidget()
        self.tab_widget.setStyleSheet("""
            QTabWidget::pane {
                border: 1px solid #c0c0c0;
                border-radius: 5px;
                background-color: white;
            }
            QTabBar::tab {
                background-color: #f0f0f0;
                border: 1px solid #c0c0c0;
                padding: 8px 16px;
                margin-right: 2px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            QTabBar::tab:selected {
                background-color: white;
                border-bottom-color: white;
            }
            QTabBar::tab:hover {
                background-color: #e6f3ff;
            }
        """)
        
        # íƒ­ë“¤ ìƒì„± - ìš°ë¦¬ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜
        self.condition_builder_tab = self.create_condition_builder_tab()
        self.strategy_combination_tab = self.create_strategy_combination_tab()
        self.backtest_tab = self.create_backtest_tab()
        self.analytics_tab = self.create_analytics_tab()
        
        # íƒ­ ì¶”ê°€
        self.tab_widget.addTab(self.condition_builder_tab, "ğŸ¯ ì¡°ê±´ ë¹Œë”")
        self.tab_widget.addTab(self.strategy_combination_tab, "ğŸ”— ì „ëµ ì¡°í•©")
        self.tab_widget.addTab(self.backtest_tab, "ğŸ“Š ë°±í…ŒìŠ¤íŒ…")
        self.tab_widget.addTab(self.analytics_tab, "ğŸ“ˆ ì „ëµ ë¶„ì„")
        
        layout.addWidget(self.tab_widget)
        
        print("âœ… ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ ì „ëµ ê´€ë¦¬ í™”ë©´ ì´ˆê¸°í™” ì™„ë£Œ")
    
    def create_condition_builder_tab(self):
        """ì¡°ê±´ ë¹Œë” íƒ­ ìƒì„± - ìš°ë¦¬ì˜ í•µì‹¬ ì»´í¬ë„ŒíŠ¸"""
        try:
            # ë¨¼ì € IntegratedConditionManager ì‹œë„
            if IntegratedConditionManager is not None:
                print("ğŸš€ IntegratedConditionManager ë¡œë”© ì¤‘...")
                integrated_manager = IntegratedConditionManager()
                
                # ì‹œê·¸ë„ ì—°ê²° (ìˆëŠ” ê²½ìš°)
                if hasattr(integrated_manager, 'condition_saved'):
                    integrated_manager.condition_saved.connect(self.on_condition_saved)
                
                print("âœ… IntegratedConditionManager ë¡œë“œ ì„±ê³µ!")
                return integrated_manager
            
            # í´ë°±: ê¸°ì¡´ ConditionDialog ì‹œë„
            elif ConditionDialog is not None:
                print("ğŸ“‹ ConditionDialog í´ë°± ë¡œë”© ì¤‘...")
                condition_dialog = ConditionDialog()
                
                # ì¡°ê±´ ì €ì¥ ì‹œê·¸ë„ ì—°ê²°
                if hasattr(condition_dialog, 'condition_saved'):
                    condition_dialog.condition_saved.connect(self.on_condition_saved)
                
                return condition_dialog
            
            else:
                raise ImportError("ì¡°ê±´ ë¹Œë” ì»´í¬ë„ŒíŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
            
        except Exception as e:
            print(f"âŒ ì¡°ê±´ ë¹Œë” ë¡œë”© ì‹¤íŒ¨: {e}")
            
            # ëŒ€ì²´ ìœ„ì ¯ ìƒì„±
            fallback_widget = QWidget()
            layout = QVBoxLayout(fallback_widget)
            
            # ì—ëŸ¬ ì •ë³´ í‘œì‹œ
            error_label = QLabel(f"ì¡°ê±´ ë¹Œë” ë¡œë”© ì‹¤íŒ¨: {e}")
            error_label.setStyleSheet("color: red; font-size: 14px; padding: 20px;")
            error_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            
            # ìƒì„¸ ì •ë³´
            detail_label = QLabel("IntegratedConditionManagerì™€ ConditionDialog ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            detail_label.setStyleSheet("color: #666; font-size: 12px; padding: 10px;")
            detail_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
            
            retry_btn = QPushButton("ğŸ”„ ë‹¤ì‹œ ì‹œë„")
            retry_btn.clicked.connect(lambda: print("ì¡°ê±´ ë¹Œë” ì¬ì‹œë„ ìš”ì²­"))
            
            layout.addWidget(error_label)
            layout.addWidget(detail_label)
            layout.addWidget(retry_btn)
            
            return fallback_widget
    
    def create_strategy_combination_tab(self):
        """ì „ëµ ì¡°í•© íƒ­ ìƒì„± - ì¡°ê±´ë“¤ì„ ì¡°í•©í•˜ì—¬ ì „ëµ ìƒì„±"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # í—¤ë”
        header_label = QLabel("ğŸ”— ì „ëµ ì¡°í•© ê´€ë¦¬")
        header_label.setStyleSheet("""
            font-size: 16px; 
            font-weight: bold; 
            color: #2c3e50;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        """)
        layout.addWidget(header_label)
        
        # ì„¤ëª…
        desc_label = QLabel("ì €ì¥ëœ ì¡°ê±´ë“¤ì„ ì¡°í•©í•˜ì—¬ ì™„ì „í•œ ë§¤ë§¤ ì „ëµì„ êµ¬ì„±í•©ë‹ˆë‹¤.")
        desc_label.setStyleSheet("color: #6c757d; font-size: 12px; padding: 10px;")
        layout.addWidget(desc_label)
        
        # TODO: ì—¬ê¸°ì— ì¡°ê±´ ì¡°í•© UI êµ¬í˜„ ì˜ˆì •
        placeholder_label = QLabel("ğŸš§ ì¡°ê±´ ì¡°í•© UI êµ¬í˜„ ì˜ˆì •")
        placeholder_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        placeholder_label.setStyleSheet("""
            color: #ffc107; 
            font-size: 14px; 
            font-style: italic;
            padding: 50px;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            margin: 20px;
        """)
        layout.addWidget(placeholder_label)
        
        return widget
    
    def create_backtest_tab(self):
        """ë°±í…ŒìŠ¤íŒ… íƒ­ ìƒì„±"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # í—¤ë”
        header_label = QLabel("ğŸ“Š ë°±í…ŒìŠ¤íŒ… ì—”ì§„")
        header_label.setStyleSheet("""
            font-size: 16px; 
            font-weight: bold; 
            color: #2c3e50;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        """)
        layout.addWidget(header_label)
        
        # ì„¤ëª…
        desc_label = QLabel("ìƒì„±ëœ ì „ëµì˜ ê³¼ê±° ì„±ê³¼ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.")
        desc_label.setStyleSheet("color: #6c757d; font-size: 12px; padding: 10px;")
        layout.addWidget(desc_label)
        
        # TODO: ë°±í…ŒìŠ¤íŒ… UI êµ¬í˜„
        placeholder_label = QLabel("ğŸš§ ë°±í…ŒìŠ¤íŒ… UI êµ¬í˜„ ì˜ˆì •")
        placeholder_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        placeholder_label.setStyleSheet("""
            color: #28a745; 
            font-size: 14px; 
            font-style: italic;
            padding: 50px;
            border: 2px dashed #28a745;
            border-radius: 10px;
            margin: 20px;
        """)
        layout.addWidget(placeholder_label)
        
        return widget
    
    def create_analytics_tab(self):
        """ì „ëµ ë¶„ì„ íƒ­ ìƒì„±"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # í—¤ë”
        header_label = QLabel("ğŸ“ˆ ì „ëµ ë¶„ì„ ëŒ€ì‹œë³´ë“œ")
        header_label.setStyleSheet("""
            font-size: 16px; 
            font-weight: bold; 
            color: #2c3e50;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
        """)
        layout.addWidget(header_label)
        
        # ì„¤ëª…
        desc_label = QLabel("ì „ëµ ì„±ê³¼ ë¶„ì„ ë° ìµœì í™” ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.")
        desc_label.setStyleSheet("color: #6c757d; font-size: 12px; padding: 10px;")
        layout.addWidget(desc_label)
        
        # TODO: ë¶„ì„ UI êµ¬í˜„
        placeholder_label = QLabel("ğŸš§ ì „ëµ ë¶„ì„ UI êµ¬í˜„ ì˜ˆì •")
        placeholder_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        placeholder_label.setStyleSheet("""
            color: #dc3545; 
            font-size: 14px; 
            font-style: italic;
            padding: 50px;
            border: 2px dashed #dc3545;
            border-radius: 10px;
            margin: 20px;
        """)
        layout.addWidget(placeholder_label)
        
        return widget
    
    def on_condition_saved(self, condition_data):
        """ì¡°ê±´ ì €ì¥ ì™„ë£Œ ì‹œ í˜¸ì¶œ"""
        print(f"âœ… ì¡°ê±´ ì €ì¥ ì™„ë£Œ: {condition_data.get('name', 'Unknown')}")
        self.strategy_saved.emit(condition_data)
        
        # ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        QMessageBox.information(
            self, 
            "ì €ì¥ ì™„ë£Œ", 
            f"ì¡°ê±´ '{condition_data.get('name', 'Unknown')}'ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"
        )

if __name__ == "__main__":
    from PyQt6.QtWidgets import QApplication
    import sys
    
    app = QApplication(sys.argv)
    
    window = NewStrategyManagementScreen()
    window.show()
    
    sys.exit(app.exec())
