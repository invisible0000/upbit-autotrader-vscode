# 매매 전략 V1.0.1 상세 요구사항 명세

## 📋 개요

**🚨 중요한 구조 변경**: 매매 전략 관리 시스템을 **진입 전략(Entry Strategy)**과 **관리 전략(Management Strategy)**으로 역할 분리하여 확장합니다.

## 🔄 전략 역할 분리 명세

### 📈 진입 전략 (Entry Strategy)
**역할**: 포지션이 없는 상태에서 최초 진입 신호를 생성
**조건**: 현재 포지션이 없을 때만 활성화
**출력**: `BUY`, `SELL`, `HOLD` 신호

### 🛡️ 관리 전략 (Management Strategy)  
**역할**: 이미 진입한 포지션의 리스크 관리 및 수익 극대화
**조건**: 활성 포지션이 존재할 때만 활성화
**출력**: `ADD_BUY`, `ADD_SELL`, `CLOSE_POSITION`, `UPDATE_STOP` 신호

### 🔗 전략 조합 시스템
**구조**: 1개 진입 전략(필수) + 0~N개 관리 전략(선택)
**예시**: "RSI 과매도 진입 + 물타기 + 트레일링 스탑"

## 🎯 기능적 요구사항 확장

### 요구사항 3.1: 진입 전략 지원 [MUST]

**사용자 스토리:** 사용자로서, 나는 다양한 진입 신호를 생성하는 전략을 선택하고 싶다. 그래서 시장 상황에 맞는 최적의 진입 타이밍을 포착할 수 있다.

#### 수용 기준

1. **WHEN** 사용자가 이동평균 교차 진입 전략을 선택하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 단기 이평선 기간 (5~20)
   - 장기 이평선 기간 (20~60)  
   - 이평선 종류 (SMA/EMA)

2. **WHEN** 사용자가 RSI 진입 전략을 선택하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - RSI 계산 기간 (14)
   - 과매도 기준 (30)
   - 과매수 기준 (70)

3. **WHEN** 사용자가 볼린저 밴드 진입 전략을 선택하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 중심선 기간 (20)
   - 표준편차 승수 (2.0)
   - 진입 방식 (반전/돌파)

4. **WHEN** 사용자가 변동성 돌파 진입 전략을 선택하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 변동폭 계산 기간 (1일)
   - K값 (0.5)
   - 당일 종가 청산 여부

5. **WHEN** 사용자가 MACD 진입 전략을 선택하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 빠른 EMA 기간 (12)
   - 느린 EMA 기간 (26)
   - 시그널 라인 기간 (9)

6. **WHEN** 사용자가 스토캐스틱 진입 전략을 선택하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - %K 기간 (14)
   - %D 기간 (3)
   - 과매도/과매수 기준 (20/80)

### 요구사항 3.2: 관리 전략 지원 [MUST]

**사용자 스토리:** 사용자로서, 나는 진입한 포지션을 다양한 방식으로 관리하고 싶다. 그래서 리스크를 제어하고 수익을 극대화할 수 있다.

#### 수용 기준

1. **WHEN** 사용자가 물타기 관리 전략을 설정하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 추가 매수 트리거 하락률 (%)
   - 최대 추가 매수 횟수 (1~5회)
   - 추가 매수 수량 비율
   - 절대 손절선 (%)

2. **WHEN** 사용자가 불타기 관리 전략을 설정하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 추가 매수 트리거 상승률 (%)
   - 최대 추가 매수 횟수 (1~3회)
   - 수량 감소 비율 (피라미드 형태)
   - 손익분기점 보호 여부

3. **WHEN** 사용자가 트레일링 스탑 관리 전략을 설정하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 추적 거리 (%)
   - 트레일링 활성화 최소 수익률 (%)
   - 스탑 방식 (percentage/ATR)

4. **WHEN** 사용자가 고정 익절/손절 관리 전략을 설정하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 익절 목표 (%)
   - 손절 기준 (%)
   - 부분 익절 사용 여부

5. **WHEN** 사용자가 부분 청산 관리 전략을 설정하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 익절 단계 목록 ([5%, 10%, 15%])
   - 각 단계별 청산 비율 ([30%, 30%, 40%])
   - 부분 청산 후 트레일링 적용 여부

6. **WHEN** 사용자가 시간 기반 청산 관리 전략을 설정하면 **THEN** 시스템은 다음 파라미터를 설정할 수 있어야 한다:
   - 최대 보유 시간 (시간)
   - 손실 시에도 강제 청산 여부
   - 장 마감 전 청산 여부

### 요구사항 3.3: 전략 조합 관리 [SHOULD]

**사용자 스토리:** 사용자로서, 나는 1개의 진입 전략과 여러 개의 관리 전략을 조합하여 완성된 매매 시스템을 구성하고 싶다. 그래서 체계적이고 일관된 매매 규칙을 만들 수 있다.

#### 수용 기준

1. **WHEN** 사용자가 전략 조합을 생성하면 **THEN** 시스템은 다음 구조를 강제해야 한다:
   - **필수**: 정확히 1개의 진입 전략 선택
   - **선택**: 0개 이상의 관리 전략 추가 (최대 5개 제한)
   - 진입 전략과 관리 전략의 역할이 명확히 구분되어 표시

2. **WHEN** 사용자가 조합 설정을 구성하면 **THEN** 시스템은 다음 기능을 제공해야 한다:
   - 관리 전략들의 실행 순서 설정 (parallel/sequential)
   - 충돌 해결 방식 설정 (priority/conservative/merge)
   - 각 관리 전략의 우선순위 설정
   - 리스크 한계 설정 (최대 포지션 크기, 최대 드로우다운)

3. **WHEN** 여러 관리 전략이 동시에 신호를 보내면 **THEN** 시스템은 설정된 충돌 해결 방식에 따라 처리해야 한다:
   - **Priority**: 우선순위가 높은 전략의 신호 채택
   - **Conservative**: CLOSE_POSITION > HOLD > 기타 순서로 보수적 처리
   - **Merge**: 신호들을 합리적으로 병합 (ADD_BUY 수량 합산 등)

4. **WHEN** 조합 전략이 저장되면 **THEN** 시스템은 해당 조합을 독립된 시스템으로 관리해야 한다:
   - 조합 목록에서 개별 전략과 동일하게 표시
   - 백테스팅 시 조합 전략 선택 가능
   - 진입/관리 전략 구성, 충돌 해결 방식 등 상세 정보 표시

### 요구사항 3.4: 상태 기반 백테스팅 엔진 [MUST]

**사용자 스토리:** 사용자로서, 나는 전략 조합이 실제 매매 상황과 동일하게 백테스트되기를 원한다. 그래서 포지션 상태에 따라 진입 전략과 관리 전략이 적절히 활성화/비활성화되는 것을 확인할 수 있다.

#### 수용 기준

1. **WHEN** 백테스트가 시작되면 **THEN** 시스템은 "진입 대기" 상태로 시작해야 한다:
   - 진입 전략만 활성화
   - 관리 전략들은 모두 비활성화
   - 포지션 없음 상태

2. **WHEN** 진입 전략이 BUY/SELL 신호를 생성하면 **THEN** 시스템은 다음과 같이 처리해야 한다:
   - 해당 가격과 수량으로 포지션 진입
   - 상태를 "포지션 관리"로 전환
   - 진입 전략 비활성화
   - 모든 관리 전략 활성화

3. **WHEN** 관리 전략이 CLOSE_POSITION 신호를 생성하면 **THEN** 시스템은 다음과 같이 처리해야 한다:
   - 포지션 완전 청산
   - 상태를 "진입 대기"로 전환
   - 관리 전략들 비활성화
   - 진입 전략 재활성화

4. **WHEN** 백테스트 결과를 분석하면 **THEN** 시스템은 다음 정보를 제공해야 한다:
   - 진입 전략의 성공률 및 평균 수익률
   - 각 관리 전략의 기여도 (추가 매수, 손절, 익절 등)
   - 포지션 관리 이력 (진입→관리→청산 전 과정)
   - 상태 전환 로그 및 시각화

### 요구사항 3.5: 탭 기반 UI 분리 [SHOULD]

**사용자 스토리:** 사용자로서, 나는 진입 전략, 관리 전략, 전략 조합을 각각 별도의 인터페이스에서 관리하고 싶다. 그래서 각 역할에 집중할 수 있고 UI가 혼란스럽지 않다.

#### 수용 기준

1. **WHEN** 사용자가 매매 전략 관리 화면에 접근하면 **THEN** 시스템은 세 개의 탭을 제공해야 한다:
   - "📈 진입 전략" 탭: 6개 진입 전략 유형 관리
   - "🛡️ 관리 전략" 탭: 6개 관리 전략 유형 관리  
   - "🔗 전략 조합" 탭: 진입+관리 전략 조합 생성 및 관리

2. **WHEN** 사용자가 "진입 전략" 탭에서 작업하면 **THEN** 시스템은 다음 기능을 제공해야 한다:
   - 진입 전략 목록 (이평교차, RSI, 볼린저밴드, 변동성돌파, MACD, 스토캐스틱)
   - 각 전략별 파라미터 설정 UI
   - 진입 신호 생성 미리보기 차트

3. **WHEN** 사용자가 "관리 전략" 탭에서 작업하면 **THEN** 시스템은 다음 기능을 제공해야 한다:
   - 관리 전략 목록 (물타기, 불타기, 트레일링스탑, 고정익절손절, 부분청산, 시간청산)
   - 각 전략별 파라미터 설정 UI
   - 포지션 관리 시뮬레이션 미리보기

4. **WHEN** 사용자가 "전략 조합" 탭에서 작업하면 **THEN** 시스템은 다음 전용 UI를 제공해야 한다:
   - 조합 전략 목록 (25%) - 조합 에디터 (50%) - 성과 비교 (25%)
   - 필수 1개 진입 전략 선택 인터페이스
   - 선택적 N개 관리 전략 추가 인터페이스
   - 실시간 조합 결과 미리보기

5. **WHEN** 사용자가 탭을 전환하면 **THEN** 시스템은 각 탭의 상태를 독립적으로 유지해야 한다:
   - 선택된 전략, 편집 중인 내용 보존
   - 탭별 독립적인 검색/필터 상태

## 🔧 비기능적 요구사항

### 성능 요구사항

1. **[MUST]** 진입 전략의 신호 계산은 500ms 이내에 완료되어야 한다.
2. **[MUST]** 관리 전략의 신호 계산은 각각 200ms 이내에 완료되어야 한다.
3. **[SHOULD]** 전략 조합의 충돌 해결 처리는 100ms 이내에 완료되어야 한다.
4. **[SHOULD]** 백테스팅 엔진의 상태 전환은 50ms 이내에 완료되어야 한다.

### 사용성 요구사항

1. **[MUST]** 진입 전략과 관리 전략의 역할 차이가 UI에서 명확히 구분되어야 한다.
2. **[MUST]** 전략 조합 시 필수(진입)/선택(관리) 구조가 직관적으로 표현되어야 한다.
3. **[SHOULD]** 관리 전략 충돌 시 해결 과정이 사용자에게 시각적으로 표시되어야 한다.
4. **[SHOULD]** 백테스팅 중 상태 전환 과정을 실시간으로 확인할 수 있어야 한다.

### 확장성 요구사항

1. **[SHOULD]** 새로운 진입 전략 추가 시 기존 코드 수정 없이 플러그인 방식으로 확장 가능해야 한다.
2. **[SHOULD]** 새로운 관리 전략 추가 시 기존 코드 수정 없이 플러그인 방식으로 확장 가능해야 한다.
3. **[COULD]** 사용자 정의 충돌 해결 로직을 스크립트로 정의할 수 있는 고급 모드를 제공할 수 있다.

## 📊 데이터 모델 확장

### 전략 역할 분리 스키마

```sql
-- 기존 trading_strategies 테이블 확장
ALTER TABLE trading_strategies ADD COLUMN strategy_role TEXT NOT NULL 
    CHECK (strategy_role IN ('entry', 'management')) DEFAULT 'entry';
ALTER TABLE trading_strategies ADD COLUMN parameter_schema TEXT; -- JSON 스키마 정의

-- 전략 조합 테이블
CREATE TABLE strategy_combinations (
    combination_id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    entry_strategy_id TEXT NOT NULL,
    execution_order TEXT DEFAULT 'parallel',
    conflict_resolution TEXT DEFAULT 'priority',
    risk_limit TEXT, -- JSON 형태 저장
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (entry_strategy_id) REFERENCES trading_strategies(strategy_id)
);

-- 조합의 관리 전략 테이블
CREATE TABLE combination_management_strategies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    combination_id TEXT NOT NULL,
    management_strategy_id TEXT NOT NULL,
    priority INTEGER DEFAULT 0,
    parameters TEXT, -- JSON 형태로 개별 파라미터 저장
    FOREIGN KEY (combination_id) REFERENCES strategy_combinations(combination_id),
    FOREIGN KEY (management_strategy_id) REFERENCES trading_strategies(strategy_id)
);

-- 백테스트 실행 이력 테이블 (확장)
ALTER TABLE backtest_results ADD COLUMN combination_id TEXT;
ALTER TABLE backtest_results ADD COLUMN state_transition_log TEXT; -- JSON 형태
ALTER TABLE backtest_results ADD COLUMN position_management_log TEXT; -- JSON 형태
```

## 🧪 테스트 요구사항

### 단위 테스트

1. **[MUST]** 각 진입 전략 클래스의 신호 생성 로직 테스트
2. **[MUST]** 각 관리 전략 클래스의 포지션 관리 로직 테스트
3. **[MUST]** 충돌 해결 엔진의 신호 처리 로직 테스트
4. **[MUST]** 전략 조합 유효성 검사 테스트 (1진입+N관리 구조)

### 통합 테스트

1. **[MUST]** 전략 조합의 백테스팅 실행 테스트 (상태 전환 포함)
2. **[MUST]** 진입→관리→청산 전체 워크플로우 테스트
3. **[SHOULD]** 탭 전환 시 상태 보존 테스트
4. **[SHOULD]** 관리 전략 충돌 시나리오 테스트

### 사용자 인수 테스트

1. **[MUST]** "RSI 진입 + 물타기 + 트레일링 스탑" 조합 테스트
2. **[MUST]** "이평교차 진입 + 불타기 + 부분청산" 조합 테스트  
3. **[SHOULD]** 복잡한 관리 전략 충돌 상황 사용성 테스트

## 🔧 개발 방침 및 제약사항

### 전략 역할 분리 방침

1. **[결정사항]** 진입 전략은 포지션 없을 때만 활성화
2. **[결정사항]** 관리 전략은 포지션 있을 때만 활성화  
3. **[결정사항]** 전략 조합은 1진입+N관리 구조로 제한

### 파라미터 최적화 방침

1. **[결정사항]** 현재 제안된 파라미터를 디폴트 값으로 설정
2. **[결정사항]** 사용자가 백테스팅을 통해 수동으로 최적 파라미터 선정
3. **[향후 계획]** 파라미터 자동 최적화 도구는 V1.1 이후 별도 개발

### 조합 전략 제약사항

1. **[결정사항]** 관리 전략은 최대 5개까지만 조합 허용
2. **[결정사항]** 충돌 해결 방식은 3가지로 제한 (priority/conservative/merge)
3. **[결정사항]** 전략 조합끼리 재조합 불가 (단순성 유지)

### 백테스팅 개선 요구사항

1. **[필요기능]** 백테스팅 대상 DB 선택 기능 추가
2. **[필요기능]** 백테스팅 기간 설정 기능 추가
3. **[핵심기능]** 상태 전환 로그 및 포지션 관리 이력 추적
4. **[향후조사]** 백테스팅 검증 결과 출력 항목 추가 연구 필요

### 실시간 실행 고려사항

1. **[핵심방침]** AI 친화적인 코드 구조 유지 (LLM 모델 감당 가능 수준)
2. **[개발방향]** 기존 AI 친화적 개발 제안을 기반으로 구현
3. **[품질목표]** 코드 안정성과 유지보수성 우선
4. **[구조원칙]** 진입/관리 전략의 명확한 책임 분리

## 🗓️ 개발 마일스톤

### Milestone 1: 전략 역할 분리 (Week 1-2)
- 진입/관리 전략 클래스 구조 재설계
- 6개 진입 전략 구현 (이평교차, RSI, 볼밴드, 변동성돌파, MACD, 스토캐스틱)
- 6개 관리 전략 구현 (물타기, 불타기, 트레일링, 고정익절, 부분청산, 시간청산)

### Milestone 2: UI 구조 변경 (Week 2-3)  
- 3탭 구조 구현 (진입/관리/조합)
- 전략 조합 UI 설계 (1진입+N관리 인터페이스)
- 충돌 해결 설정 UI 구현

### Milestone 3: 백테스팅 엔진 재설계 (Week 3-4)
- 상태 기반 백테스팅 엔진 구현
- 충돌 해결 시스템 구현
- DB와 기간 선택 기능 추가

### Milestone 4: 통합 테스트 및 검증 (Week 4-5)
- 전략 조합 백테스팅 통합 테스트
- 진입/관리 전략 기여도 분석
- 종합 테스트 및 버그 수정

## 📋 추가 고려사항 (향후 논의)

### V1.1 이후 개발 고려사항

1. **동적 전략 전환**
   - 시장 상황에 따른 진입 전략 자동 변경
   - 포지션 성과에 따른 관리 전략 동적 조정

2. **머신러닝 기반 최적화**
   - AI 모델을 이용한 진입 타이밍 정교화  
   - 강화학습 기반 관리 전략 파라미터 최적화

3. **포트폴리오 레벨 관리**
   - 여러 전략 조합의 동시 실행
   - 포트폴리오 레벨 리스크 관리 및 리밸런싱

4. **고급 사용자 기능**
   - 사용자 정의 충돌 해결 로직 스크립팅
   - 전략 성과 기반 자동 가중치 조정

이 요구사항 명세서를 바탕으로 개발을 진행하시면 됩니다. 특히 진입 전략과 관리 전략의 명확한 역할 분리에 중점을 두어 직관적이고 현실적인 매매 시스템을 구축하는 것이 목표입니다!
