# QAsync ì•„í‚¤í…ì²˜ ì»´í”Œë¼ì´ì–¸ìŠ¤ Pre-commit Hook
# ëª©ì : ê°œë°œìê°€ ì»¤ë°‹í•˜ê¸° ì „ì— ê¸ˆì§€ íŒ¨í„´ì„ ì°¨ë‹¨í•˜ì—¬ íšŒê·€ ë°©ì§€

repos:
  - repo: local
    hooks:
      - id: qasync-compliance-check
        name: QAsync Architecture Compliance Check
        entry: powershell
        args:
          - -ExecutionPolicy
          - Bypass
          - -Command
          - |
            Write-Host "ğŸ” QAsync ì•„í‚¤í…ì²˜ ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì‚¬..." -ForegroundColor Yellow

            # ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬
            $violations = Get-ChildItem upbit_auto_trading -Recurse -Include *.py | Select-String -Pattern "new_event_loop\(|run_until_complete\(|asyncio\.run\(|set_event_loop\(None\)|QApplication\.exec\(\)"

            if ($violations) {
                Write-Host "ğŸš¨ ê¸ˆì§€ëœ ì´ë²¤íŠ¸ ë£¨í”„ íŒ¨í„´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!" -ForegroundColor Red
                foreach ($violation in $violations) {
                    Write-Host "  âŒ $($violation.Filename):$($violation.LineNumber)" -ForegroundColor Red
                }
                Write-Host "ğŸ’¡ docs/big_issues/issue_01_20250926/QAsync_REFACTORING_WORK_GUIDE.mdë¥¼ ì°¸ì¡°í•˜ì„¸ìš”." -ForegroundColor Green
                exit 1
            } else {
                Write-Host "âœ… QAsync ì»´í”Œë¼ì´ì–¸ìŠ¤ í†µê³¼!" -ForegroundColor Green
            }
        language: system
        pass_filenames: false
        stages: [commit]

      - id: qasync-pattern-recommendation
        name: QAsync Pattern Recommendation
        entry: powershell
        args:
          - -ExecutionPolicy
          - Bypass
          - -Command
          - |
            # ë³€ê²½ëœ íŒŒì¼ì—ì„œ ë¹„ë™ê¸° íŒ¨í„´ í™•ì¸
            $changedFiles = git diff --cached --name-only --diff-filter=ACMR | Where-Object { $_ -match "\.py$" -and $_ -match "upbit_auto_trading" }

            if ($changedFiles) {
                $hasAsyncCode = $false
                foreach ($file in $changedFiles) {
                    if (Test-Path $file) {
                        $content = Get-Content $file -Raw
                        if ($content -match "async def|await |asyncio\.|threading\.") {
                            $hasAsyncCode = $true
                            break
                        }
                    }
                }

                if ($hasAsyncCode) {
                    $hasQasync = $changedFiles | ForEach-Object {
                        if (Test-Path $_) { Get-Content $_ -Raw }
                    } | Where-Object { $_ -match "@asyncSlot|qasync\." }

                    if (-not $hasQasync) {
                        Write-Host "ğŸ’¡ ë¹„ë™ê¸° ì½”ë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. QAsync íŒ¨í„´ ì‚¬ìš©ì„ ê³ ë ¤í•˜ì„¸ìš”:" -ForegroundColor Yellow
                        Write-Host "  - @asyncSlot ë°ì½”ë ˆì´í„° ì‚¬ìš©" -ForegroundColor Cyan
                        Write-Host "  - TaskManagerë¥¼ í†µí•œ íƒœìŠ¤í¬ ê´€ë¦¬" -ForegroundColor Cyan
                        Write-Host "  - qasync.QApplication ì‚¬ìš©" -ForegroundColor Cyan
                    }
                }
            }
        language: system
        pass_filenames: false
        stages: [commit]

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
        exclude: ^(.*\.md|.*\.txt)$
      - id: end-of-file-fixer
        exclude: ^(.*\.md|.*\.txt)$
      - id: check-yaml
      - id: check-json
      - id: check-merge-conflict

  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
        args: [--line-length=100]
        exclude: ^(legacy/|temp/|examples/)

  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
        args: [--profile=black, --line-length=100]
        exclude: ^(legacy/|temp/|examples/)
